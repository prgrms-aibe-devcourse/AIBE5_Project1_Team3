<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ì—¬ê¸°ì €ê¸° : ë¡œê·¸ì¸</title>
    <link rel="apple-touch-icon" sizes="57x57" href="../photo/android-icon-144x144.png">
  <link rel="apple-touch-icon" sizes="60x60" href="../photo/apple-icon-60x60.png">
  <link rel="apple-touch-icon" sizes="72x72" href="../photo/apple-icon-72x72.png">
  <link rel="apple-touch-icon" sizes="76x76" href="../photo/apple-icon-76x76.png">
  <link rel="apple-touch-icon" sizes="114x114" href="../photo/apple-icon-114x114.png">
  <link rel="apple-touch-icon" sizes="120x120" href="../photo/apple-icon-120x120.png">
  <link rel="apple-touch-icon" sizes="144x144" href="../photo/apple-icon-144x144.png">
  <link rel="apple-touch-icon" sizes="152x152" href="../photo/apple-icon-152x152.png">
  <link rel="apple-touch-icon" sizes="180x180" href="../photo/apple-icon-180x180.png">
  <link rel="icon" type="image/png" sizes="192x192" href="../photo/android-icon-192x192.png">
  <link rel="icon" type="image/png" sizes="32x32" href="../photo/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="96x96" href="../photo/favicon-96x96.png">
  <link rel="icon" type="image/png" sizes="16x16" href="../photo/favicon-16x16.png">
  <link rel="manifest" href="../manifest.json">
  <meta name="msapplication-TileColor" content="#ffffff">
  <meta name="msapplication-TileImage" content="ms-icon-144x144.png">
  <meta name="theme-color" content="#ffffff">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <link rel="stylesheet" href="../css/global.css">
    <link rel="stylesheet" href="../css/auth.css">
    <script>
        tailwind.config = {
            theme: { extend: { colors: { primary: '#000', accent: '#FF385C' } } }
        }
    </script>
</head>
<body class="bg-gray-50 h-screen flex items-center justify-center p-6">

    <div class="w-full max-w-md bg-white rounded-3xl shadow-xl p-8 md:p-10 animate-fade-in relative">
        <a href="index.html" class="absolute top-6 left-6 text-gray-400 transition-transform hover:scale-110" title="í™ˆìœ¼ë¡œ ì´ë™">
            <i data-lucide="home" width="24"></i>
        </a>
        <div class="text-center mb-10">
            <h1 class="text-3xl font-black mb-2 tracking-tight">ì—¬ê¸°ì €ê¸°</h1>
            <p id="auth-desc" class="text-gray-500">ë‚˜ë§Œì˜ ì—¬í–‰ íë ˆì´ì…˜ì„ ì‹œì‘í•´ë³´ì„¸ìš”.</p>
        </div>

        <div class="space-y-4">
            <button type="button" id="btn-google" class="w-full py-3.5 px-4 rounded-xl border border-gray-200 flex items-center justify-center gap-3 hover:bg-gray-50 transition-colors relative">
                <img src="https://www.svgrepo.com/show/475656/google-color.svg" alt="Google" class="w-5 h-5" />
                <span class="font-bold text-gray-700">Googleë¡œ ì‹œì‘í•˜ê¸°</span>
            </button>
            
            <div class="relative py-4">
                <div class="absolute inset-0 flex items-center"><div class="w-full border-t border-gray-100"></div></div>
                <div class="relative flex justify-center text-xs"><span id="divider-text" class="px-2 bg-white text-gray-400">ë˜ëŠ” ì´ë©”ì¼ë¡œ ë¡œê·¸ì¸</span></div>
            </div>

            <form id="form-auth" class="space-y-4">
                <div><input id="input-email" type="email" placeholder="ì´ë©”ì¼ ì£¼ì†Œ" class="w-full px-4 py-3 rounded-xl bg-gray-50 border-gray-100 border focus:bg-white focus:outline-none transition-colors text-sm" required></div>
                <div><input id="input-password" type="password" placeholder="ë¹„ë°€ë²ˆí˜¸" class="w-full px-4 py-3 rounded-xl bg-gray-50 border-gray-100 border focus:bg-white focus:outline-none transition-colors text-sm" required></div>
                
                <div id="confirm-password-group" class="hidden">
                    <input id="input-confirm-password" type="password" placeholder="ë¹„ë°€ë²ˆí˜¸ í™•ì¸" class="w-full px-4 py-3 rounded-xl bg-gray-50 border-gray-100 border focus:bg-white focus:outline-none transition-colors text-sm">
                </div>

                <button type="submit" id="btn-submit" class="w-full py-3.5 bg-black text-white rounded-xl font-bold hover:bg-gray-800 transition-colors shadow-lg shadow-gray-200 disabled:bg-gray-400">ë¡œê·¸ì¸</button>
            </form>
        </div>
        <div class="mt-8 text-center space-y-3">
            <div class="text-xs text-gray-400">
                <span id="switch-label">ê³„ì •ì´ ì—†ìœ¼ì‹ ê°€ìš”?</span>
                <a href="#" id="btn-switch-mode" class="underline ml-1 font-medium transition-colors">íšŒì›ê°€ì…</a>
            </div>

            <div>
                <a href="forgotPassword.html" class="text-xs text-gray-300 hover:text-gray-600 hover:underline transition-colors">
                    ë¹„ë°€ë²ˆí˜¸ë¥¼ ìŠìœ¼ì…¨ë‚˜ìš”?
                </a>
            </div>
        </div>


    </div>

    <script src="../js/script.js"></script>
    
    <script src="../js/data.js"></script>
    
    <script>
        const supabaseClient = window.supabaseClient;

        // --- ìš”ì†Œ ì„ íƒ ---
        const btnGoogle = document.getElementById('btn-google');
        const authForm = document.getElementById('form-auth');
        const btnSubmit = document.getElementById('btn-submit');
        const btnSwitchMode = document.getElementById('btn-switch-mode');
        const confirmGroup = document.getElementById('confirm-password-group');
        const confirmInput = document.getElementById('input-confirm-password');
        const authDesc = document.getElementById('auth-desc');
        const dividerText = document.getElementById('divider-text');
        const switchLabel = document.getElementById('switch-label');

        let isSignUpMode = false;

        // [ì¤‘ìš” ìˆ˜ì •] í˜„ì¬ login.html ìœ„ì¹˜ë¥¼ ê¸°ë°˜ìœ¼ë¡œ index.html ê²½ë¡œ ìë™ ìƒì„±
        function getRedirectUrl() {
            try {
                const origin = window.location.origin;
                const path = window.location.pathname;
                // ë§ˆì§€ë§‰ '/' ë’¤ì— ìˆëŠ” íŒŒì¼ëª…(login.html)ì„ ì œê±°í•˜ê³  index.htmlì„ ë¶™ì„
                const basePath = path.substring(0, path.lastIndexOf('/'));
                const fullPath = origin + basePath + '/index.html';
                
                console.log("Calculated Redirect URL:", fullPath); // í™•ì¸ìš© ë¡œê·¸
                return fullPath;
            } catch (e) {
                console.error("URL ìƒì„± ì‹¤íŒ¨:", e);
                // ì‹¤íŒ¨ ì‹œ ê¸°ë³¸ê°’ (í˜¹ì‹œ ëª¨ë¥¼ ëŒ€ë¹„)
                return window.location.origin + '/index.html';
            }
        }

        // --- ëª¨ë“œ ì „í™˜ ---
        btnSwitchMode.addEventListener('click', (e) => {
            e.preventDefault();
            isSignUpMode = !isSignUpMode;

            if (isSignUpMode) {
                authDesc.textContent = "ìƒˆë¡œìš´ ê³„ì •ì„ ë§Œë“¤ì–´ë³´ì„¸ìš”.";
                dividerText.textContent = "ë˜ëŠ” ì´ë©”ì¼ë¡œ íšŒì›ê°€ì…";
                btnSubmit.textContent = "íšŒì›ê°€ì… ì‹œì‘í•˜ê¸°";
                confirmGroup.classList.remove('hidden');
                confirmInput.required = true;
                switchLabel.textContent = "ì´ë¯¸ ê³„ì •ì´ ìˆìœ¼ì‹ ê°€ìš”?";
                btnSwitchMode.textContent = "ë¡œê·¸ì¸ìœ¼ë¡œ ëŒì•„ê°€ê¸°";
            } else {
                authDesc.textContent = "ë‚˜ë§Œì˜ ì—¬í–‰ íë ˆì´ì…˜ì„ ì‹œì‘í•´ë³´ì„¸ìš”.";
                dividerText.textContent = "ë˜ëŠ” ì´ë©”ì¼ë¡œ ë¡œê·¸ì¸";
                btnSubmit.textContent = "ë¡œê·¸ì¸";
                confirmGroup.classList.add('hidden');
                confirmInput.required = false;
                switchLabel.textContent = "ê³„ì •ì´ ì—†ìœ¼ì‹ ê°€ìš”?";
                btnSwitchMode.textContent = "íšŒì›ê°€ì…";
            }
        });

        // --- ë¡œê·¸ì¸ & íšŒì›ê°€ì… ì²˜ë¦¬ ---
        authForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('input-email').value;
            const password = document.getElementById('input-password').value;

            btnSubmit.disabled = true;
            btnSubmit.textContent = isSignUpMode ? "ì²˜ë¦¬ ì¤‘..." : "ë¡œê·¸ì¸ ì¤‘...";

            try {
                if (isSignUpMode) {
                    // [íšŒì›ê°€ì…]
                    const confirmPw = confirmInput.value;
                    if (password !== confirmPw) {
                        throw new Error("ë¹„ë°€ë²ˆí˜¸ ë¶ˆì¼ì¹˜");
                    }

                    if (password.length < 6) {
                        throw new Error("ë¹„ë°€ë²ˆí˜¸ ê¸¸ì´ ë¶€ì¡±");
                    }

                    const { data, error } = await supabaseClient.auth.signUp({
                        email: email,
                        password: password,
                        options: {
                            emailRedirectTo: getRedirectUrl() // ìë™ ê³„ì‚°ëœ ì£¼ì†Œ ì‚¬ìš©
                        }
                    });

                    if (error) throw error;
                    showAuthModal("ì¸ì¦ ë©”ì¼ ë°œì†¡", `${email}ë¡œ <br />ì¸ì¦ ë§í¬ë¥¼ ë³´ëƒˆìŠµë‹ˆë‹¤. <br />ë©”ì¼í•¨ì„ í™•ì¸í•´ì£¼ì„¸ìš”!`, "ğŸ“©");

                } else {
                    // [ë¡œê·¸ì¸]
                    const { data, error } = await supabaseClient.auth.signInWithPassword({ email, password });
                    if (error) throw error;
                    
                    location.href = 'index.html';
                }
            } catch (error) {
                if (error.message.includes("Invalid login credentials")) {
                    console.error(error);
                    showAuthModal("ë¡œê·¸ì¸ ì‹¤íŒ¨", "ì´ë©”ì¼ ë˜ëŠ” ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.<br />ë‹¤ì‹œ í™•ì¸í•´ì£¼ì„¸ìš”.", "ğŸš«");
                }
                else if (error.message.includes("Email not confirmed")){
                    showAuthModal("ë¡œê·¸ì¸ ì‹¤íŒ¨", "ì´ë©”ì¼ ì¸ì¦ì´ ì™„ë£Œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.<br />ë©”ì¼í•¨ì„ í™•ì¸í•´ì£¼ì„¸ìš”.", "ğŸ“©");
                }
                else if (error.message === "ë¹„ë°€ë²ˆí˜¸ ë¶ˆì¼ì¹˜") {
                    showAuthModal("ì…ë ¥ ì˜¤ë¥˜", "ë¹„ë°€ë²ˆí˜¸ê°€ ì„œë¡œ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.", "âŒ");
                }
                else if (error.message === "ë¹„ë°€ë²ˆí˜¸ ê¸¸ì´ ë¶€ì¡±") {
                    showAuthModal("ë³´ì•ˆ ê²½ê³ ", "ë¹„ë°€ë²ˆí˜¸ëŠ” ìµœì†Œ 6ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.", "ğŸ”");
                }
                else {
                    showAuthModal("ì˜¤ë¥˜ ë°œìƒ", "ì˜ˆê¸°ì¹˜ ëª»í•œ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ì— ì‹œë„í•´ì£¼ì„¸ìš”.", "âš ï¸");
                }
            } finally {
                btnSubmit.disabled = false;
                btnSubmit.textContent = isSignUpMode ? "íšŒì›ê°€ì… ì‹œì‘í•˜ê¸°" : "ë¡œê·¸ì¸";
            }
        });

        // --- ì¸ì¦ ìƒíƒœ ê°ì§€ ---
        supabaseClient.auth.onAuthStateChange((event, session) => {
            if (event === 'SIGNED_IN') {
                const isEmailConfirmation = window.location.hash.includes('access_token');
                if (isEmailConfirmation) {
                    showAuthModal("ì¸ì¦ ì™„ë£Œ", "ì´ë©”ì¼ ì¸ì¦ì´ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!", "âœ…");
                    // ì—¬ê¸°ì„œë„ ì•ˆì „í•˜ê²Œ ì´ë™
                    location.href = 'index.html';
                }
            }
        });

        // --- ì†Œì…œ ë¡œê·¸ì¸ ---
        async function handleSocialLogin(provider) {
            try {
                const { data, error } = await supabaseClient.auth.signInWithOAuth({
                    provider: provider,
                    options: {
                        redirectTo: getRedirectUrl(), // ìë™ ê³„ì‚°ëœ ì£¼ì†Œ ì‚¬ìš©
                        queryParams : {
                            prompt : 'select_account',
                            access_type : 'offline',
                        }
                    }
                });
                if (error) throw error;
            } catch (error) {
                console.error(error);
                showAuthModal("ì†Œì…œ ë¡œê·¸ì¸ ì—ëŸ¬", error.message, "âš ï¸");
            }
        }

        if(btnGoogle) btnGoogle.addEventListener('click', () => handleSocialLogin('google'));
    </script>
</body>
</html>
