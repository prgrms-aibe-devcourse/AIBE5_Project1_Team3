<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë§ˆì´í˜ì´ì§€ - ì—¬ê¸°ì €ê¸°</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="../css/global.css">
    <link rel="stylesheet" href="../css/mypage.css">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#000',
                        accent: '#FF385C',
                        ai: '#8B5CF6',
                    }
                }
            }
        }
    </script>
     <style>
        .tab-indicator { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .tab-content { display: none; animation: fadeIn 0.4s ease-out; }
        .tab-content.active { display: block; }
        .trip-card { transition: transform 0.2s; }
        .trip-card:active { transform: scale(0.98); }
        
        /* Toggle Switch UI */
        .toggle-label {
            width: 3rem;
            height: 1.5rem;
            background-color: #e5e7eb;
            border-radius: 9999px;
            position: relative;
            cursor: pointer;
            transition: background-color 0.3s ease-in-out;
        }
        .toggle-checkbox { display: none; }
        .toggle-circle {
            position: absolute; top: 2px; left: 2px;
            width: 1.25rem; height: 1.25rem;
            background-color: white; border-radius: 50%;
            transition: transform 0.3s ease-in-out;
            box-shadow: 0 1px 3px rgba(0,0,0,0.3);
        }
        .toggle-checkbox:checked + .toggle-label { background-color: #000; }
        .toggle-checkbox:checked + .toggle-label .toggle-circle { transform: translateX(1.5rem); }
        
        /* Star Rating */
        .star-btn i { transition: all 0.2s; }
        .star-btn.active i { fill: #FACC15; color: #FACC15; }
        
        /* Checkbox */
        .custom-checkbox:checked {
            background-color: #FF385C; border-color: #FF385C;
            background-image: url("data:image/svg+xml,%3csvg viewBox='0 0 16 16' fill='white' xmlns='http://www.w3.org/2000/svg'%3e%3cpath d='M12.207 4.793a1 1 0 010 1.414l-5 5a1 1 0 01-1.414 0l-2-2a1 1 0 011.414-1.414L6.5 9.086l4.293-4.293a1 1 0 011.414 0z'/%3e%3c/svg%3e");
        }

        /* Modal Scroll */
        .modal-scroll::-webkit-scrollbar { width: 6px; }
        .modal-scroll::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 4px; }
        .modal-scroll::-webkit-scrollbar-thumb { background: #d1d5db; border-radius: 4px; }
        .modal-scroll::-webkit-scrollbar-thumb:hover { background: #9ca3af; }

        /* Drag & Drop */
        .draggable-item { cursor: grab; transition: all 0.2s; user-select: none; }
        .draggable-item:active { cursor: grabbing; }
        .draggable-item.dragging { opacity: 0.5; background-color: #f3f4f6; border: 2px dashed #ccc; }
        .drag-handle { cursor: grab; color: #9ca3af; padding: 4px; }
        .drag-handle:hover { color: #374151; background-color: #f3f4f6; border-radius: 4px; }
    </style>
</head>
<body class="bg-gray-50 pb-24">

    <!-- Header -->
    <div class="sticky top-0 left-0 w-full bg-white/90 backdrop-blur-md z-40 border-b border-gray-100 px-4 h-14 flex items-center justify-between">
        <div class="flex items-center gap-3">
            <a href="index.html" class="text-gray-800 hover:text-black transition-colors">
                <i data-lucide="chevron-left" width="24"></i>
            </a>
            <h1 class="font-bold text-lg text-gray-900">ë§ˆì´í˜ì´ì§€</h1>
        </div>
        <button onclick="openSettingsModal()" class="text-gray-500 hover:text-black">
            <i data-lucide="settings" width="20"></i>
        </button>
    </div>

    <!-- Profile Section -->
    <div class="bg-white px-6 py-8 mb-2">
        <div class="flex items-center gap-4">
            <div class="relative group cursor-pointer" onclick="openProfileModal()">
                <div class="w-20 h-20 rounded-full p-[2px] bg-gradient-to-tr from-accent to-purple-500">
                    <img id="profile-img" src="" class="w-full h-full rounded-full border-2 border-white bg-gray-100 object-cover" alt="Profile">
                </div>
                <div class="absolute bottom-0 right-0 bg-white p-1 rounded-full border border-gray-100 shadow-sm">
                    <i data-lucide="camera" width="12" class="text-gray-500"></i>
                </div>
            </div>
            <div class="flex-1">
                <h2 id="profile-name" class="text-xl font-black text-gray-900 leading-tight mb-1"></h2>
                <p id="profile-email" class="text-xs text-gray-400 mb-2"></p>
                <p id="profile-bio" class="text-sm text-gray-600 mb-3 line-clamp-1"></p>
                <button onclick="openProfileModal()" class="px-3 py-1.5 border border-gray-200 rounded-lg text-xs font-bold text-gray-600 hover:bg-gray-50 hover:border-black transition-all">
                    í”„ë¡œí•„ í¸ì§‘
                </button>
            </div>
        </div>
        
        <!-- Stats -->
        <div class="flex justify-between mt-8 px-2">
            <div class="text-center w-1/3 cursor-pointer border-r border-gray-100" onclick="switchTab('saved')">
                <p class="text-xs text-gray-400 font-medium mb-1">ì°œí•œ ì—¬í–‰</p>
                <p class="text-lg font-black text-accent" id="stat-likes">0</p>
            </div>
            <div class="text-center w-1/3 border-r border-gray-100" onclick="switchTab('trips')">
                <p class="text-xs text-gray-400 font-medium mb-1">ë‹¤ë…€ì˜¨ ì—¬í–‰</p>
                <p class="text-lg font-black text-gray-900" id="stat-trips">0</p>
            </div>
            <div class="text-center w-1/3 cursor-pointer" onclick="switchTab('reviews')">
                <p class="text-xs text-gray-400 font-medium mb-1">ë‚˜ì˜ í›„ê¸°</p>
                <p class="text-lg font-black text-gray-900" id="stat-reviews">0</p>
            </div>
        </div>
    </div>

    <!-- Tabs -->
    <div class="sticky top-14 bg-white z-30 border-b border-gray-100">
        <div class="flex relative">
            <button onclick="switchTab('saved')" class="tab-btn w-1/3 py-3 text-sm font-bold text-gray-400 transition-colors data-[active=true]:text-black" data-tab="saved">
                ì°œí•œ ëª©ë¡
            </button>
            <button onclick="switchTab('trips')" class="tab-btn w-1/3 py-3 text-sm font-bold text-gray-400 transition-colors data-[active=true]:text-black" data-tab="trips">
                ë‚˜ì˜ ì—¬í–‰
            </button>
            <button onclick="switchTab('reviews')" class="tab-btn w-1/3 py-3 text-sm font-bold text-gray-400 transition-colors data-[active=true]:text-black" data-tab="reviews">
                ë‚˜ì˜ í›„ê¸°
            </button>
            <div id="tab-line" class="absolute bottom-0 h-[2px] bg-black transition-all duration-300 w-1/3 left-0"></div>
        </div>
    </div>

    <!-- Content Area -->
    <div class="max-w-3xl mx-auto px-4 py-6 min-h-[50vh]">

        <!-- Tab 1: Saved -->
        <div id="tab-saved" class="tab-content active">
            <div class="flex justify-between items-center mb-4 sticky top-28 bg-gray-50/90 backdrop-blur z-20 p-2 rounded-xl border border-gray-100 shadow-sm">
                <p class="text-xs text-gray-500 pl-2">ê°€ê³  ì‹¶ì€ ê³³ì„ ì„ íƒí•˜ì„¸ìš”.</p>
                <button onclick="generateTripFromSelection()" class="bg-accent text-white px-4 py-2 rounded-full text-xs font-bold shadow-md hover:bg-red-600 transition-colors flex items-center gap-1">
                    <i data-lucide="calendar-plus" width="14"></i>
                    ì¼ì • ë§Œë“¤ê¸°
                </button>
            </div>
            <div id="saved-grid" class="grid grid-cols-1 sm:grid-cols-2 gap-4"></div>
            <div id="saved-empty" class="hidden flex-col items-center justify-center py-20 text-gray-400">
                <i data-lucide="heart-off" width="48" class="mb-4 text-gray-200"></i>
                <p>ì•„ì§ ì°œí•œ ì—¬í–‰ì§€ê°€ ì—†ì–´ìš”.</p>
                <a href="index.html" class="mt-4 text-accent text-sm font-bold underline">ì—¬í–‰ì§€ ë‘˜ëŸ¬ë³´ê¸°</a>
            </div>
        </div>

        <!-- Tab 2: My Trips -->
        <div id="tab-trips" class="tab-content space-y-6">
            <div class="flex justify-between items-end mb-4 border-b border-gray-100 pb-2">
                <h3 class="font-bold text-lg flex items-center gap-2">
                    ë‹¤ê°€ì˜¤ëŠ” ì—¬í–‰ <span class="text-accent text-sm" id="upcoming-count">0</span>
                </h3>
                <button onclick="openManualCreateModal()" class="flex items-center gap-1 px-3 py-1.5 bg-black text-white rounded-full text-xs font-bold hover:bg-gray-800 transition-colors shadow-lg shadow-gray-200">
                    <i data-lucide="plus" width="14"></i> ì¼ì • ì¶”ê°€
                </button>
            </div>
            <div id="upcoming-list" class="space-y-4"></div>
            <div class="pt-6">
                <h3 class="font-bold text-gray-400 text-sm mb-4">ì§€ë‚œ ì—¬í–‰</h3>
                <div id="past-list" class="space-y-4 opacity-90"></div>
            </div>
        </div>

        <!-- Tab 3: Reviews -->
        <div id="tab-reviews" class="tab-content">
             <div class="bg-blue-50 p-4 rounded-xl mb-6 flex items-start gap-3">
                <i data-lucide="info" class="text-blue-500 mt-0.5" width="16"></i>
                <p class="text-xs text-blue-800 leading-relaxed">
                    ì—¬í–‰ í›„ê¸°ë¥¼ ì‘ì„±í•˜ë©´ í¬ì¸íŠ¸ê°€ ì ë¦½ë©ë‹ˆë‹¤.<br>
                    ë³„ì ê³¼ í•¨ê»˜ ìƒìƒí•œ í›„ê¸°ë¥¼ ë‚¨ê²¨ì£¼ì„¸ìš”.
                </p>
            </div>
            <div id="review-list" class="space-y-4"></div>
             <div id="review-empty" class="hidden text-center py-20 text-gray-400">ì‘ì„±í•œ í›„ê¸°ê°€ ì—†ìŠµë‹ˆë‹¤.</div>
        </div>
    </div>

    <!-- Modals -->

    <!-- Settings Modal -->
    <div id="settings-modal" class="fixed inset-0 z-50 hidden flex items-center justify-center px-4">
        <div class="absolute inset-0 bg-black/60 backdrop-blur-sm transition-opacity" onclick="closeSettingsModal()"></div>
        <div class="bg-white w-full max-w-sm rounded-3xl p-6 z-10 relative animate-slide-up">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-black">ì„¤ì •</h3>
                <button onclick="closeSettingsModal()" class="p-2 hover:bg-gray-100 rounded-full"><i data-lucide="x" width="20"></i></button>
            </div>
            <div class="space-y-6">
                <div class="flex justify-between items-center">
                    <span class="font-bold text-gray-700">ì•Œë¦¼ ì„¤ì •</span>
                    <div>
                        <input type="checkbox" id="noti-toggle" class="toggle-checkbox" />
                        <label for="noti-toggle" class="toggle-label block">
                            <span class="toggle-circle"></span>
                        </label>
                    </div>
                </div>
                <button onclick="handleLogout()" class="w-full py-4 text-red-500 font-bold bg-red-50 rounded-xl hover:bg-red-100 transition-colors flex items-center justify-center gap-2">
                    <i data-lucide="log-out" width="18"></i> ë¡œê·¸ì•„ì›ƒ
                </button>
            </div>
        </div>
    </div>

    <!-- Profile Edit Modal -->
    <div id="profile-modal" class="fixed inset-0 z-50 hidden flex items-center justify-center px-4">
        <div class="absolute inset-0 bg-black/60 backdrop-blur-sm transition-opacity" onclick="closeProfileModal()"></div>
        <div class="bg-white w-full max-w-md rounded-3xl p-6 z-10 relative animate-slide-up max-h-[85vh] overflow-y-auto modal-scroll">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-black">í”„ë¡œí•„ í¸ì§‘</h3>
                <button onclick="closeProfileModal()" class="p-2 hover:bg-gray-100 rounded-full"><i data-lucide="x" width="20"></i></button>
            </div>
            <div class="flex flex-col items-center mb-6">
                <div class="relative w-24 h-24 mb-3">
                    <img id="edit-profile-img" src="" class="w-full h-full rounded-full bg-gray-100 object-cover border border-gray-200">
                    <button type="button" onclick="refreshAvatar()" class="absolute bottom-0 right-0 bg-black text-white p-2 rounded-full shadow-lg hover:bg-gray-800 transition-colors"><i data-lucide="refresh-cw" width="14"></i></button>
                </div>
                <p class="text-xs text-gray-400">ì£¼ì‚¬ìœ„ ë²„íŠ¼ì„ ëˆŒëŸ¬ ì•„ë°”íƒ€ë¥¼ ë³€ê²½í•´ë³´ì„¸ìš”.</p>
            </div>
            <form onsubmit="saveProfile(event)" class="space-y-4">
                <div><label class="block text-xs font-bold text-gray-500 mb-1">ë‹‰ë„¤ì„</label><input type="text" id="edit-name" class="w-full p-3 bg-gray-50 rounded-xl border border-gray-200 focus:border-black focus:outline-none font-bold" required></div>
                <div><label class="block text-xs font-bold text-gray-500 mb-1">í•œì¤„ ì†Œê°œ</label><input type="text" id="edit-bio" class="w-full p-3 bg-gray-50 rounded-xl border border-gray-200 focus:border-black focus:outline-none"></div>
                <div><label class="block text-xs font-bold text-gray-500 mb-1">ì´ë©”ì¼</label><input type="email" id="edit-email" class="w-full p-3 bg-gray-100 rounded-xl border border-transparent text-gray-400 cursor-not-allowed" readonly></div>
                <button type="submit" class="w-full bg-black text-white py-4 rounded-xl font-bold text-lg hover:bg-gray-800 mt-2">ì €ì¥í•˜ê¸°</button>
            </form>
        </div>
    </div>

    <!-- Trip Detail Modal -->
    <div id="detail-modal" class="fixed inset-0 z-50 hidden flex items-center justify-center px-4">
        <div class="absolute inset-0 bg-black/60 backdrop-blur-sm" onclick="closeDetailModal()"></div>
        <div class="bg-white w-full max-w-5xl rounded-3xl p-6 md:p-8 z-10 relative animate-fade-in h-[90vh] flex flex-col">
             <div class="flex justify-between items-center mb-6 flex-shrink-0">
                <div class="flex items-center gap-3">
                    <h3 class="text-2xl font-black text-gray-900 leading-tight" id="view-title"></h3>
                    <span id="view-badge" class="px-2 py-1 bg-gray-100 rounded text-[10px] font-bold text-gray-500"></span>
                </div>
                <button onclick="closeDetailModal()" class="p-2 bg-gray-100 hover:bg-gray-200 rounded-full"><i data-lucide="x" width="24"></i></button>
             </div>
             
             <div class="flex flex-col md:flex-row gap-8 h-full overflow-hidden">
                 <div class="flex-1 space-y-6 overflow-y-auto pr-2 modal-scroll">
                     
                     <div id="view-places-container" class="hidden">
                        <label class="block text-xs font-bold text-gray-500 mb-2 flex items-center gap-1">
                            <i data-lucide="map-pin" width="12"></i> ì„ íƒëœ ì—¬í–‰ì§€
                        </label>
                        <div id="view-places-list" class="space-y-2 bg-gray-50 p-3 rounded-xl border border-gray-100"></div>
                     </div>

                     <div class="flex items-center gap-3 text-gray-700 bg-gray-50 p-4 rounded-2xl border border-gray-100">
                         <i data-lucide="calendar" width="20"></i>
                         <span id="view-date" class="font-bold text-base"></span>
                     </div>
                     
                     <div class="space-y-4">
                         <div class="p-4 rounded-2xl border border-gray-100">
                             <p class="text-xs text-gray-400 font-bold mb-1">ì—¬í–‰ì§€</p>
                             <p id="view-location" class="font-bold text-lg text-gray-900"></p>
                         </div>
                         <div class="grid grid-cols-2 gap-4">
                             <div class="p-4 rounded-2xl border border-gray-100">
                                 <p class="text-xs text-gray-400 font-bold mb-1">ë™í–‰ì¸</p>
                                 <p id="view-companions" class="font-bold text-gray-800"></p>
                             </div>
                             <div class="p-4 rounded-2xl border border-gray-100">
                                 <p class="text-xs text-gray-400 font-bold mb-1">ì˜ˆì‚°</p>
                                 <p id="view-budget" class="font-bold text-gray-800"></p>
                             </div>
                             <div class="p-4 rounded-2xl border border-gray-100">
                                 <p class="text-xs text-gray-400 font-bold mb-1">ì—¬í–‰ í…Œë§ˆ</p>
                                 <p id="view-theme-text" class="font-bold text-gray-800"></p>
                             </div>
                             <div class="p-4 rounded-2xl border border-gray-100">
                                 <p class="text-xs text-gray-400 font-bold mb-1">ì´ë™ ìˆ˜ë‹¨</p>
                                 <p id="view-transport-text" class="font-bold text-gray-800"></p>
                             </div>
                         </div>
                     </div>
                 </div>

                 <div class="flex-1 flex flex-col h-full min-h-[300px]">
                     <label class="block text-xs font-bold text-gray-500 mb-2">ìƒì„¸ ì¼ì • ë° ë©”ëª¨</label>
                     <div id="view-memo" class="flex-1 bg-gray-50 p-5 rounded-2xl border border-gray-200 text-sm leading-7 text-gray-700 whitespace-pre-wrap overflow-y-auto modal-scroll shadow-inner"></div>
                 </div>
             </div>
             
             <div class="mt-6 pt-4 border-t border-gray-100 flex-shrink-0 text-right">
                 <button onclick="closeDetailModal()" class="px-8 py-3 bg-black text-white rounded-xl font-bold hover:bg-gray-800 transition-colors">ë‹«ê¸°</button>
             </div>
        </div>
    </div>

    <!-- Create/Edit Trip Modal -->
    <div id="create-modal" class="fixed inset-0 z-50 hidden flex items-center justify-center px-4">
        <div class="absolute inset-0 bg-black/60 backdrop-blur-sm transition-opacity" onclick="closeCreateModal()"></div>
        <div class="bg-white w-full max-w-5xl rounded-3xl p-6 md:p-8 z-10 relative animate-slide-up h-[90vh] flex flex-col">
            
            <!-- Header -->
            <div class="flex justify-between items-center mb-6 flex-shrink-0">
                <h3 class="text-2xl font-black text-gray-900" id="create-modal-title">ìƒˆ ì¼ì • ë§Œë“¤ê¸°</h3>
                <button type="button" onclick="closeCreateModal()" class="p-2 hover:bg-gray-100 rounded-full transition-colors"><i data-lucide="x" width="24"></i></button>
            </div>
            
            <!-- Body -->
            <form onsubmit="handleCreateOrUpdateTrip(event)" class="flex-1 overflow-hidden flex flex-col">
                <input type="hidden" id="edit-trip-id">
                
                <div class="flex flex-col md:flex-row gap-8 h-full overflow-y-auto md:overflow-hidden">
                    
                    <!-- [Left Column] ì…ë ¥ í¼ -->
                    <div class="flex-1 flex flex-col gap-5 overflow-y-auto pr-2 modal-scroll">
                        
                        <!-- ì„ íƒëœ ì¥ì†Œ ë¦¬ìŠ¤íŠ¸ -->
                        <div id="selected-places-container" class="hidden bg-red-50 p-4 rounded-xl border border-red-100">
                            <label class="block text-xs font-bold text-red-500 mb-2 flex items-center gap-1">
                                <i data-lucide="check-circle-2" width="12"></i> ì„ íƒëœ ì°œ ëª©ë¡ (ë“œë˜ê·¸ë¡œ ìˆœì„œ ë³€ê²½)
                            </label>
                            <div id="selected-places-list" class="space-y-2 max-h-40 overflow-y-auto modal-scroll pr-1">
                                <!-- JSë¡œ ë‚´ìš© ì£¼ì…ë¨ -->
                            </div>
                        </div>

                        <div>
                            <label class="block text-xs font-bold text-gray-500 mb-1">ì—¬í–‰ ì´ë¦„</label>
                            <input type="text" id="trip-title" class="w-full p-3.5 bg-gray-50 rounded-xl border border-gray-200 focus:border-black focus:bg-white focus:outline-none font-bold transition-colors" placeholder="ì˜ˆ: ì‚¿í¬ë¡œ ì‹ë„ë½ ì—¬í–‰" required>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-xs font-bold text-gray-500 mb-1">ëŒ€í‘œ ì—¬í–‰ì§€</label>
                                <input type="text" id="trip-location" class="w-full p-3.5 bg-gray-50 rounded-xl border border-gray-200 focus:border-black focus:bg-white focus:outline-none transition-colors" required>
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-gray-500 mb-1">ì˜ˆì‚° (ë§Œì›)</label>
                                <input type="number" id="trip-budget" class="w-full p-3.5 bg-gray-50 rounded-xl border border-gray-200 focus:border-black focus:bg-white focus:outline-none transition-colors" placeholder="0">
                            </div>
                        </div>

                        <div class="flex gap-4">
                            <div class="flex-1">
                                <label class="block text-xs font-bold text-gray-500 mb-1">ì‹œì‘ì¼</label>
                                <input type="date" id="trip-start" class="w-full p-3.5 bg-gray-50 rounded-xl border border-gray-200 focus:border-black focus:bg-white focus:outline-none text-sm transition-colors" required>
                            </div>
                            <div class="flex-1">
                                <label class="block text-xs font-bold text-gray-500 mb-1">ì¢…ë£Œì¼</label>
                                <input type="date" id="trip-end" class="w-full p-3.5 bg-gray-50 rounded-xl border border-gray-200 focus:border-black focus:bg-white focus:outline-none text-sm transition-colors" required>
                            </div>
                        </div>

                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-xs font-bold text-gray-500 mb-1">ì—¬í–‰ í…Œë§ˆ</label>
                                <div class="relative">
                                    <select id="trip-theme" class="w-full p-3.5 bg-gray-50 rounded-xl border border-gray-200 focus:border-black focus:bg-white focus:outline-none text-sm appearance-none cursor-pointer">
                                        <option value="íë§">ğŸŒ¿ íë§/íœ´ì‹</option>
                                        <option value="ë§›ì§‘">ğŸ½ï¸ ë§›ì§‘ íƒë°©</option>
                                        <option value="ê´€ê´‘">ğŸ“¸ ê´€ê´‘ ëª…ì†Œ</option>
                                        <option value="ì•¡í‹°ë¹„í‹°">ğŸ„ ì•¡í‹°ë¹„í‹°</option>
                                        <option value="ì‡¼í•‘">ğŸ›ï¸ ì‡¼í•‘</option>
                                        <option value="í˜¸ìº‰ìŠ¤">ğŸ¨ í˜¸ìº‰ìŠ¤</option>
                                    </select>
                                    <i data-lucide="chevron-down" class="absolute right-3 top-1/2 transform -translate-y-1/2 w-4 h-4 text-gray-400 pointer-events-none"></i>
                                </div>
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-gray-500 mb-1">ì´ë™ ìˆ˜ë‹¨</label>
                                <div class="relative">
                                    <select id="trip-transport" class="w-full p-3.5 bg-gray-50 rounded-xl border border-gray-200 focus:border-black focus:bg-white focus:outline-none text-sm appearance-none cursor-pointer">
                                        <option value="ë¹„í–‰ê¸°">âœˆï¸ ë¹„í–‰ê¸°</option>
                                        <option value="ë Œí„°ì¹´">ğŸš— ë Œí„°ì¹´</option>
                                        <option value="ëŒ€ì¤‘êµí†µ">ğŸšŒ ëŒ€ì¤‘êµí†µ</option>
                                        <option value="ìì°¨">ğŸš˜ ìì°¨</option>
                                        <option value="ëšœë²…ì´">ğŸš¶ ëšœë²…ì´</option>
                                    </select>
                                    <i data-lucide="chevron-down" class="absolute right-3 top-1/2 transform -translate-y-1/2 w-4 h-4 text-gray-400 pointer-events-none"></i>
                                </div>
                            </div>
                        </div>

                        <div>
                            <label class="block text-xs font-bold text-gray-500 mb-1">ë™í–‰ì¸</label>
                            <input type="text" id="trip-companions" class="w-full p-3.5 bg-gray-50 rounded-xl border border-gray-200 focus:border-black focus:bg-white focus:outline-none transition-colors" placeholder="í˜¼ì, ê°€ì¡±, ì—°ì¸ ë“±">
                        </div>
                    </div>

                    <!-- Right Column -->
                    <div class="flex-1 flex flex-col h-full min-h-[300px]">
                        <label class="block text-xs font-bold text-gray-500 mb-2 flex justify-between">
                            <span>ìƒì„¸ ì¼ì • ë° ë©”ëª¨</span>
                        </label>
                        <textarea id="trip-memo" class="flex-1 w-full p-5 bg-gray-50 rounded-2xl border border-gray-200 focus:border-black focus:bg-white focus:outline-none resize-none text-sm leading-7 shadow-inner transition-colors modal-scroll" placeholder="ì—¬ê¸°ì— ìƒì„¸ ì¼ì •ì´ í‘œì‹œë©ë‹ˆë‹¤."></textarea>
                    </div>
                </div>

                <div class="mt-6 pt-4 border-t border-gray-100 flex-shrink-0">
                    <button type="submit" id="btn-save-trip" class="w-full bg-black text-white py-4 rounded-xl font-bold text-lg hover:bg-gray-800 transition-all shadow-lg active:scale-[0.99]">
                        ì¼ì • ì €ì¥í•˜ê¸°
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Review Modal -->
    <div id="review-modal" class="fixed inset-0 z-50 hidden flex items-center justify-center px-4">
        <div class="absolute inset-0 bg-black/60 backdrop-blur-sm" onclick="closeReviewModal()"></div>
        <div class="bg-white w-full max-w-md rounded-2xl p-6 z-10 relative animate-fade-in">
             <div class="flex justify-between items-center mb-4">
                 <h3 class="text-lg font-bold" id="review-modal-title">í›„ê¸° ì‘ì„±</h3>
                 <button onclick="closeReviewModal()" class="text-gray-400 hover:text-black"><i data-lucide="x" width="20"></i></button>
             </div>
             
             <div class="mb-4">
                 <label class="block text-xs text-gray-400 font-bold mb-1">ì–´ë–¤ ì¥ì†Œì— ëŒ€í•œ í›„ê¸°ì¸ê°€ìš”?</label>
                 <select id="review-article-select" class="w-full p-3 bg-white border border-gray-200 rounded-xl text-sm focus:border-black focus:outline-none appearance-none cursor-pointer">
                     <option value="">ì „ì²´ ì—¬í–‰ì— ëŒ€í•œ í›„ê¸°</option>
                 </select>
             </div>

             <div class="flex flex-col items-center mb-4 bg-gray-50 p-3 rounded-xl border border-gray-100">
                 <p class="text-xs text-gray-400 font-bold mb-2">ë³„ì ì„ ì„ íƒí•´ì£¼ì„¸ìš”</p>
                 <div class="flex gap-2" id="star-container">
                     <button type="button" onclick="setRating(1)" class="star-btn active text-gray-300"><i data-lucide="star" width="32" fill="currentColor"></i></button>
                     <button type="button" onclick="setRating(2)" class="star-btn active text-gray-300"><i data-lucide="star" width="32" fill="currentColor"></i></button>
                     <button type="button" onclick="setRating(3)" class="star-btn active text-gray-300"><i data-lucide="star" width="32" fill="currentColor"></i></button>
                     <button type="button" onclick="setRating(4)" class="star-btn active text-gray-300"><i data-lucide="star" width="32" fill="currentColor"></i></button>
                     <button type="button" onclick="setRating(5)" class="star-btn active text-gray-300"><i data-lucide="star" width="32" fill="currentColor"></i></button>
                 </div>
                 <p id="rating-text" class="text-xs font-bold text-accent mt-2">5ì  - ìµœê³ ì˜€ì–´ìš”!</p>
             </div>

             <textarea id="review-text" class="w-full h-32 p-3 bg-gray-50 rounded-xl resize-none focus:outline-none mb-4 border border-gray-200" placeholder="ì—¬í–‰ì˜ ìƒìƒí•œ í›„ê¸°ë¥¼ ë‚¨ê²¨ì£¼ì„¸ìš”."></textarea>
             <button onclick="submitReview()" id="btn-save-review" class="w-full bg-black text-white py-3 rounded-xl font-bold">ì‘ì„± ì™„ë£Œ</button>
        </div>
    </div>

    <!-- !!! Data Reset Button !!! -->
    <button onclick="resetAllData()" class="fixed bottom-4 right-4 bg-red-500 text-white px-4 py-2 rounded-full shadow-lg z-50 text-xs font-bold hover:bg-red-600 transition-colors">
        ë°ì´í„° ì´ˆê¸°í™”
    </button>

    <script src="../js/script.js"></script>
    <script src="../js/data.js"></script>
    <script>
        // --- 0. Global Variables ---
        var currentSelectedPlaces = (typeof currentSelectedPlaces !== 'undefined') ? currentSelectedPlaces : [];

        // --- 1. Data Reset Logic ---
        function resetAllData() {
            if(confirm('ëª¨ë“  ì°œí•œ ëª©ë¡ê³¼ ì—¬í–‰ ì¼ì •ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n(ë°ì´í„° ë²„ì „ ë¶ˆì¼ì¹˜ í•´ê²°ìš©)')) {
                localStorage.removeItem('myTrips');
                localStorage.removeItem('myReviews');
                localStorage.removeItem('favorites');
                alert('ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì°œí•˜ê¸°ë¥¼ ì‹œë„í•´ì£¼ì„¸ìš”.');
                location.reload();
            }
        }

        // --- 2. Settings & Profile Logic ---
        let currentAvatarSeed = 'Felix';
        const defaultProfile = { name: 'ì—¬í–‰í•˜ëŠ” ê¹€ì² ìˆ˜', email: 'traveler_kim@example.com', bio: 'ì—¬í–‰ì€ ë‚˜ë¥¼ ì°¾ëŠ” ì—¬ì •', avatarSeed: 'Felix' };

        function loadProfile() {
            const profile = JSON.parse(localStorage.getItem('userProfile')) || defaultProfile;
            const nameEl = document.getElementById('profile-name');
            if(nameEl) {
                document.getElementById('profile-name').textContent = profile.name;
                document.getElementById('profile-email').textContent = profile.email;
                document.getElementById('profile-bio').textContent = profile.bio;
                document.getElementById('profile-img').src = `https://api.dicebear.com/7.x/avataaars/svg?seed=${profile.avatarSeed}`;
            }
            currentAvatarSeed = profile.avatarSeed;
        }
        function openProfileModal() {
            const profile = JSON.parse(localStorage.getItem('userProfile')) || defaultProfile;
            document.getElementById('edit-name').value = profile.name; document.getElementById('edit-email').value = profile.email; document.getElementById('edit-bio').value = profile.bio; document.getElementById('edit-profile-img').src = `https://api.dicebear.com/7.x/avataaars/svg?seed=${profile.avatarSeed}`;
            document.getElementById('profile-modal').classList.remove('hidden'); document.getElementById('profile-modal').classList.add('flex');
        }
        function closeProfileModal() { document.getElementById('profile-modal').classList.add('hidden'); document.getElementById('profile-modal').classList.remove('flex'); }
        function saveProfile(e) { e.preventDefault(); const newProfile = { name: document.getElementById('edit-name').value, email: document.getElementById('edit-email').value, bio: document.getElementById('edit-bio').value, avatarSeed: currentAvatarSeed }; localStorage.setItem('userProfile', JSON.stringify(newProfile)); loadProfile(); closeProfileModal(); alert('í”„ë¡œí•„ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.'); }
        function refreshAvatar() { currentAvatarSeed = Math.random().toString(36).substring(7); document.getElementById('edit-profile-img').src = `https://api.dicebear.com/7.x/avataaars/svg?seed=${currentAvatarSeed}`; }

        function openSettingsModal() { 
            const modal = document.getElementById('settings-modal');
            const toggle = document.getElementById('noti-toggle');
            const isNotiOn = localStorage.getItem('settings_notification') !== 'false'; 
            if(toggle) {
                toggle.checked = isNotiOn;
                toggle.onchange = function() { localStorage.setItem('settings_notification', this.checked); };
            }
            modal.classList.remove('hidden'); modal.classList.add('flex'); 
        }
        function closeSettingsModal() { document.getElementById('settings-modal').classList.add('hidden'); document.getElementById('settings-modal').classList.remove('flex'); }
        
        // --- 3. Tab Logic ---
        function switchTab(tabId) {
            document.querySelectorAll('.tab-btn').forEach(btn => { const isActive = btn.dataset.tab === tabId; btn.dataset.active = isActive; btn.classList.toggle('text-black', isActive); btn.classList.toggle('text-gray-400', !isActive); });
            const line = document.getElementById('tab-line'); 
            if(tabId === 'saved') line.style.left = '0%'; 
            if(tabId === 'trips') line.style.left = '33.33%'; 
            if(tabId === 'reviews') line.style.left = '66.66%';
            document.querySelectorAll('.tab-content').forEach(content => { content.classList.remove('active'); }); document.getElementById(`tab-${tabId}`).classList.add('active');
        }

        // --- 4. Trips Logic ---
        function getTrips() { return JSON.parse(localStorage.getItem('myTrips') || '[]'); }
        
        function renderTrips() {
            const trips = getTrips(); const reviews = getMyReviews();
            const upcomingList = document.getElementById('upcoming-list'); const pastList = document.getElementById('past-list');
            upcomingList.innerHTML = ''; pastList.innerHTML = '';
            
            if (trips.length === 0) { upcomingList.innerHTML = `<div class="text-center py-10 text-gray-400 text-sm">ë“±ë¡ëœ ì—¬í–‰ ì¼ì •ì´ ì—†ìŠµë‹ˆë‹¤.</div>`; }
            trips.sort((a, b) => new Date(a.startDate) - new Date(b.startDate));

            trips.forEach((trip, index) => {
                const start = new Date(trip.startDate); 
                const end = new Date(trip.endDate); 
                end.setHours(23, 59, 59, 999); 
                
                const isPast = end < new Date(); 
                const today = new Date(); today.setHours(0,0,0,0);
                const dDay = Math.ceil((start - today) / (1000 * 60 * 60 * 24));
                const hasReview = reviews.some(r => r.tripId === trip.id);
                
                let actionButtonHtml = '';
                if (isPast) {
                    if (hasReview) {
                        actionButtonHtml = `<span class="px-3 py-1.5 bg-gray-100 text-gray-400 text-xs font-bold rounded-lg border border-gray-200">í›„ê¸° ì‘ì„±ì™„ë£Œ</span>`;
                    } else {
                        actionButtonHtml = `<button type="button" onclick="event.stopPropagation(); openCreateReviewModal('${trip.id}')" class="px-4 py-2 bg-gray-900 text-white text-xs font-bold rounded-lg hover:bg-black transition-colors relative z-20 shadow-md">í›„ê¸° ì“°ê¸°</button>`;
                    }
                } else {
                    actionButtonHtml = `<div class="flex gap-1 relative z-20">
                        <button type="button" onclick="event.stopPropagation(); openEditModal('${trip.id}')" class="p-2 bg-gray-100 rounded-full text-gray-500 hover:text-black hover:bg-gray-200 transition-colors">
                            <i data-lucide="pencil" width="16"></i>
                            </button><button type="button" onclick="event.stopPropagation(); deleteTrip('${trip.id}')" class="p-2 bg-gray-100 rounded-full text-gray-500 hover:text-red-500 hover:bg-red-50 transition-colors"><i data-lucide="trash-2" width="16"></i></button></div>`;
                }
                
                const cardHtml = `<div onclick="openDetailModal('${trip.id}')" class="trip-card bg-white border border-gray-100 rounded-2xl p-5 shadow-sm flex justify-between items-center group relative overflow-hidden cursor-pointer hover:shadow-md"><div class="relative z-10"><div class="flex items-center gap-2 mb-1"><span class="text-[10px] font-bold px-2 py-0.5 rounded bg-${isPast ? 'gray-100 text-gray-400' : 'red-50 text-accent'}">${isPast ? 'ì—¬í–‰ì™„ë£Œ' : (dDay <= 0 ? (dDay === 0 ? 'D-Day' : 'ì—¬í–‰ì¤‘') : `D-${dDay}`)}</span><span class="text-xs text-gray-400">${trip.startDate} ~ ${trip.endDate}</span></div><h4 class="font-bold text-lg text-gray-900 flex items-center gap-2">${trip.title} ${trip.isAI ? '<i data-lucide="sparkles" width="14" class="text-violet-500"></i>' : ''}</h4><p class="text-sm text-gray-500 flex items-center gap-1 mt-1"><i data-lucide="map-pin" width="12"></i> ${trip.location} <span class="text-xs text-gray-300">|</span> <span class="text-xs">${trip.companions || 'ë™í–‰ ë¯¸ì •'}</span></p></div><div class="relative z-10 flex flex-col items-end gap-2">${actionButtonHtml}</div></div>`;
                
                if (isPast) { pastList.innerHTML += cardHtml; } else { upcomingList.innerHTML += cardHtml; }
            });
            document.getElementById('upcoming-count').textContent = trips.length; // Approximate
            document.getElementById('stat-trips').textContent = trips.filter(t => new Date(t.endDate) < new Date()).length;
            lucide.createIcons();
        }

        // --- 5. Favorites with Smart Generator & Drag-Drop ---
        
        function generateTripFromSelection() {
            const checkboxes = document.querySelectorAll('.saved-item-checkbox:checked');
            if(checkboxes.length === 0) { alert('ì¼ì •ì— ì¶”ê°€í•  ì¥ì†Œë¥¼ ìµœì†Œ 1ê°œ ì´ìƒ ì„ íƒí•´ì£¼ì„¸ìš”.'); return; }

            const selectedIds = Array.from(checkboxes).map(cb => cb.dataset.id);
            const locationKeywords = [];
            let themeCounts = { 'ë§›ì§‘': 0, 'íœ´ì–‘': 0, 'ê´€ê´‘': 0, 'ì•¡í‹°ë¹„í‹°': 0 };

            currentSelectedPlaces = []; // ì „ì—­ ë³€ìˆ˜ ì´ˆê¸°í™”

            selectedIds.forEach(id => {
                if (typeof ARTICLES !== 'undefined') {
                    const article = ARTICLES.find(a => a.id === id);
                    if (article) {
                        const tags = (article.mainTags || []).concat(article.tags || []).join(' ');
                        let cat = 'ê´€ê´‘';
                        if (tags.match(/ìˆ™ì†Œ|í˜¸í…”|ë¦¬ì¡°íŠ¸|íœì…˜|ìŠ¤í…Œì´/)) cat = 'ìˆ™ì†Œ';
                        else if (tags.match(/ë§›ì§‘|ì‹ë‹¹|ì¹´í˜|ìŒì‹ì |ë² ì´ì»¤ë¦¬/)) cat = 'ë§›ì§‘';
                        
                        if(tags.match(/ë§›ì§‘|ì‹ë‹¹|ì¹´í˜/)) themeCounts['ë§›ì§‘']++;
                        if(tags.match(/ìˆ™ì†Œ|í˜¸í…”|ë¦¬ì¡°íŠ¸|íœ´ì–‘|íë§/)) themeCounts['íœ´ì–‘']++;
                        if(tags.match(/ê´€ê´‘|ëª…ì†Œ|ìœ ì /)) themeCounts['ê´€ê´‘']++;
                        if(tags.match(/ì•¡í‹°ë¹„í‹°|ì„œí•‘|íŠ¸ë ˆí‚¹/)) themeCounts['ì•¡í‹°ë¹„í‹°']++;

                        const textToScan = (article.address || '') + (article.title || '');
                        if (textToScan.includes('ê°•ë¦‰')) locationKeywords.push('ê°•ë¦‰');
                        else if (textToScan.includes('ê°€í‰')) locationKeywords.push('ê°€í‰');
                        else if (textToScan.includes('ë°©ì½•')) locationKeywords.push('ë°©ì½•');
                        else if (textToScan.includes('ì½”ì‚¬ë¬´ì´')) locationKeywords.push('ì½”ì‚¬ë¬´ì´');
                        else if (textToScan.includes('ì˜¤ì‚¬ì¹´')) locationKeywords.push('ì˜¤ì‚¬ì¹´');
                        else if (textToScan.includes('ê²½ì£¼')) locationKeywords.push('ê²½ì£¼');
                        else if (textToScan.includes('ê´Œ')) locationKeywords.push('ê´Œ');
                        else if (textToScan.includes('ì œì£¼')) locationKeywords.push('ì œì£¼');

                        currentSelectedPlaces.push({
                            id: article.id,
                            title: article.name || article.title,
                            address: article.address || 'ì£¼ì†Œ ì •ë³´ ì—†ìŒ',
                            imageUrl: article.imageUrl,
                            category: cat,
                            rating: article.rating
                        });
                    }
                }
            });

            // ëŒ€í‘œ ì§€ì—­ ì„ ì •
            let mainLocation = 'ë‚˜ë§Œì˜';
            if (locationKeywords.length > 0) {
                const counts = {};
                locationKeywords.forEach(loc => { counts[loc] = (counts[loc] || 0) + 1; });
                mainLocation = Object.keys(counts).reduce((a, b) => counts[a] > counts[b] ? a : b);
            }

            // ëŒ€í‘œ í…Œë§ˆ ì„ ì •
            let mainTheme = Object.keys(themeCounts).reduce((a, b) => themeCounts[a] > themeCounts[b] ? a : b);
            let themeValue = 'íë§';
            if(mainTheme === 'ë§›ì§‘') themeValue = 'ë§›ì§‘';
            if(mainTheme === 'ê´€ê´‘') themeValue = 'ê´€ê´‘';
            if(mainTheme === 'ì•¡í‹°ë¹„í‹°') themeValue = 'ì•¡í‹°ë¹„í‹°';

            // ëª¨ë‹¬ ì—´ê¸°
            openCreateModal();
            
            // ê°’ ì±„ìš°ê¸°
            const setVal = (id, val) => { if(document.getElementById(id)) document.getElementById(id).value = val; };
            setVal('trip-title', `${mainLocation} ${mainTheme} ì—¬í–‰`);
            setVal('trip-location', mainLocation);
            setVal('trip-theme', themeValue);
            setVal('trip-transport', 'ë¹„í–‰ê¸°');
            setVal('trip-companions', 'ê°€ì¡±/ì—°ì¸');
            setVal('trip-budget', '100');

            const today = new Date();
            const start = new Date(today); start.setDate(today.getDate() + 7);
            const end = new Date(start); end.setDate(start.getDate() + 9);
            setVal('trip-start', start.toISOString().split('T')[0]);
            setVal('trip-end', end.toISOString().split('T')[0]);

            renderDraggableList();
            updateTripMemo(mainLocation, mainTheme);
        }

        // --- Drag & Drop List Rendering ---
        function renderDraggableList() {
            const container = document.getElementById('selected-places-container');
            const list = document.getElementById('selected-places-list');
            
            if(container) {
                container.classList.remove('hidden');
                container.style.display = 'block';
            }
            if(list) {
                list.innerHTML = '';
                currentSelectedPlaces.forEach((item, index) => {
                    const li = document.createElement('div');
                    li.className = 'draggable-item flex items-center gap-3 p-2 bg-white rounded-lg border border-gray-100 shadow-sm select-none';
                    li.setAttribute('draggable', 'true');
                    li.dataset.index = index;

                    li.innerHTML = `
                        <div class="drag-handle p-1 cursor-grab"><i data-lucide="grip-vertical" width="16" class="text-gray-400"></i></div>
                        <img src="${item.imageUrl}" class="w-10 h-10 rounded-md object-cover flex-shrink-0 pointer-events-none">
                        <div class="flex-1 min-w-0 pointer-events-none">
                            <div class="flex items-center gap-2">
                                <span class="text-[10px] font-bold text-gray-500 bg-gray-100 px-1.5 rounded">${item.category === 'ìˆ™ì†Œ' ? 'ğŸ  ìˆ™ì†Œ' : (item.category === 'ë§›ì§‘' ? 'ğŸ½ï¸ ë§›ì§‘' : 'ğŸ“¸ ê´€ê´‘')}</span>
                                <p class="text-xs font-bold text-gray-900 truncate">${item.title}</p>
                            </div>
                        </div>
                    `;

                    li.addEventListener('dragstart', () => li.classList.add('dragging'));
                    li.addEventListener('dragend', () => {
                        li.classList.remove('dragging');
                        const location = document.getElementById('trip-location').value;
                        const theme = document.getElementById('trip-theme').value;
                        updateTripMemo(location, theme);
                    });

                    list.appendChild(li);
                });

                list.addEventListener('dragover', e => {
                    e.preventDefault();
                    const afterElement = getDragAfterElement(list, e.clientY);
                    const draggable = document.querySelector('.dragging');
                    if (afterElement == null) {
                        list.appendChild(draggable);
                    } else {
                        list.insertBefore(draggable, afterElement);
                    }
                });
                
                list.addEventListener('drop', () => {
                    const newItems = list.querySelectorAll('.draggable-item');
                    const reorderedArray = [];
                    newItems.forEach(div => {
                        reorderedArray.push(currentSelectedPlaces[div.dataset.index]);
                    });
                    currentSelectedPlaces = reorderedArray;
                    newItems.forEach((div, idx) => { div.dataset.index = idx; });

                    safeUpdateMemo();
                });
            }
            if(typeof lucide !== 'undefined') lucide.createIcons();
        }

        function safeUpdateMemo() {
            const locEl = document.getElementById('trip-location');
            const themeEl = document.getElementById('trip-theme');
            const location = locEl ? locEl.value : 'ë‚˜ë§Œì˜';
            const theme = themeEl ? themeEl.value : 'ì—¬í–‰';
            updateTripMemo(location, theme);
        }

        function getDragAfterElement(container, y) {
            const draggableElements = [...container.querySelectorAll('.draggable-item:not(.dragging)')];
            return draggableElements.reduce((closest, child) => {
                const box = child.getBoundingClientRect();
                const offset = y - box.top - box.height / 2;
                if (offset < 0 && offset > closest.offset) {
                    return { offset: offset, element: child };
                } else {
                    return closest;
                }
            }, { offset: Number.NEGATIVE_INFINITY }).element;
        }

        function updateTripMemo(location, theme) {
            let memo = `âœ¨ [${location}] ${theme} ì—¬í–‰ ê³„íšì„œ âœ¨\n\n`;
            memo += `ğŸ“‹ ì„ íƒí•œ ì¥ì†Œ (ë°©ë¬¸ ìˆœì„œ)\n`;
            
            currentSelectedPlaces.forEach((item, index) => {
                const icon = item.category === 'ìˆ™ì†Œ' ? 'ğŸ ' : (item.category === 'ë§›ì§‘' ? 'ğŸ½ï¸' : 'ğŸ“¸');
                memo += `${index + 1}. ${icon} ${item.title}\n   ğŸ“ ${item.address}\n`;
            });

            memo += `\nğŸ—“ï¸ ì¶”ì²œ ì¼ì • (ë™ì„  ìµœì í™”)\n-------------------\n`;

            if (currentSelectedPlaces.length === 0) {
                memo += "ì¥ì†Œë¥¼ ì„ íƒí•˜ë©´ ì¼ì •ì´ ìƒì„±ë©ë‹ˆë‹¤.";
            } else {
                const itemsPerDay = 3;
                let dayCount = 1;
                memo += `1ì¼ì°¨:\n`;
                memo += `- ${location} ë„ì°©\n`;

                currentSelectedPlaces.forEach((item, index) => {
                    if (index > 0 && index % itemsPerDay === 0) {
                        dayCount++;
                        memo += `\n${dayCount}ì¼ì°¨:\n`;
                    }
                    const seq = index % itemsPerDay;
                    let timeLabel = "";
                    if (seq === 0) timeLabel = "[ì˜¤ì „/ì´ë™]";
                    else if (seq === 1) timeLabel = "[ì˜¤í›„]";
                    else if (seq === 2) timeLabel = "[ì €ë…]";

                    let action = "ë°©ë¬¸";
                    if (item.category === 'ìˆ™ì†Œ') {
                        action = "ì²´í¬ì¸ ë° íœ´ì‹";
                        timeLabel = "[ìˆ™ì†Œ]"; 
                    } else if (item.category === 'ë§›ì§‘') {
                        action = "ì‹ì‚¬";
                    }

                    memo += `- ${timeLabel} ${item.title} (${action})\n`;
                });
                memo += `\n${dayCount + 1}ì¼ì°¨:\n- ì²´í¬ì•„ì›ƒ ë° ê·€ê°€\n`;
            }
            
            const memoEl = document.getElementById('trip-memo');
            if(memoEl) memoEl.value = memo;
        }

        // --- Modals Management ---
        function openDetailModal(tripId) {
            const trips = getTrips(); 
            const trip = trips.find(t => t.id === tripId); 
            if(!trip) return;

            document.getElementById('view-title').textContent = trip.title;
            const typeText = trip.isAI ? 'AI ìƒì„±' : 'ì§ì ‘ ìƒì„±';
            document.getElementById('view-badge').textContent = typeText;
            
            document.getElementById('view-date').textContent = `${trip.startDate} ~ ${trip.endDate}`; 
            document.getElementById('view-location').textContent = trip.location; 
            document.getElementById('view-companions').textContent = trip.companions || '-'; 
            document.getElementById('view-budget').textContent = trip.budget ? `${trip.budget}ë§Œì›` : '-'; 
            document.getElementById('view-memo').textContent = trip.memo || 'ì‘ì„±ëœ ë©”ëª¨ê°€ ì—†ìŠµë‹ˆë‹¤.';
            
            document.getElementById('view-theme-text').textContent = trip.theme || 'íë§';
            document.getElementById('view-transport-text').textContent = trip.transport || 'ë¹„í–‰ê¸°';

            // [New] ì„ íƒëœ ì—¬í–‰ì§€ ëª©ë¡ í‘œì‹œ
            const placesContainer = document.getElementById('view-places-container');
            const placesList = document.getElementById('view-places-list');
            
            if (trip.selectedPlaces && trip.selectedPlaces.length > 0) {
                placesContainer.classList.remove('hidden');
                placesList.innerHTML = '';
                
                trip.selectedPlaces.forEach(item => {
                    const title = item.title || item;
                    const imgUrl = item.imageUrl || 'https://via.placeholder.com/40';
                    const category = item.category || 'ì¥ì†Œ';
                    const address = item.address || 'ì£¼ì†Œ ì •ë³´ ì—†ìŒ';

                    placesList.innerHTML += `
                        <div class="flex items-center gap-3 p-2 bg-white rounded-lg border border-gray-100 shadow-sm">
                            <img src="${imgUrl}" class="w-10 h-10 rounded-md object-cover flex-shrink-0">
                            <div class="flex-1 min-w-0">
                                <div class="flex items-center gap-2">
                                    <span class="text-[10px] font-bold text-gray-500 bg-gray-100 px-1.5 rounded">${category}</span>
                                    <p class="text-xs font-bold text-gray-900 truncate">${title}</p>
                                </div>
                                <p class="text-[10px] text-gray-400 truncate">${address}</p>
                            </div>
                        </div>`;
                });
            } else {
                placesContainer.classList.add('hidden');
            }

            document.getElementById('detail-modal').classList.remove('hidden'); 
            document.getElementById('detail-modal').classList.add('flex');
        }
        function closeDetailModal() { document.getElementById('detail-modal').classList.add('hidden'); document.getElementById('detail-modal').classList.remove('flex'); }
        
        // [New] ìˆ˜ë™ ìƒì„± ë²„íŠ¼ìš© (ì´ˆê¸°í™” í¬í•¨)
        function openManualCreateModal() {
            currentSelectedPlaces = []; // ì—¬ê¸°ì„œë§Œ ì´ˆê¸°í™”!
            openCreateModal();
        }

        function openCreateModal() { 
            document.getElementById('create-modal-title').textContent = 'ìƒˆ ì¼ì • ë§Œë“¤ê¸°'; document.getElementById('btn-save-trip').textContent = 'ì¼ì • ì €ì¥í•˜ê¸°'; document.getElementById('edit-trip-id').value = ''; 
            document.querySelector('#create-modal form').reset(); 
            if (currentSelectedPlaces.length === 0) {
                const container = document.getElementById('selected-places-container');
                if(container) container.classList.add('hidden');
            }
            document.getElementById('create-modal').classList.remove('hidden'); document.getElementById('create-modal').classList.add('flex'); 
        }
        
        function openEditModal(tripId) {
            const trips = getTrips(); 
            const trip = trips.find(t => t.id === tripId); 
            if(!trip) return;

            document.getElementById('create-modal-title').textContent = 'ì¼ì • ìˆ˜ì •í•˜ê¸°'; 
            document.getElementById('btn-save-trip').textContent = 'ìˆ˜ì •ì™„ë£Œ'; 
            document.getElementById('edit-trip-id').value = trip.id;
            
            const setVal = (id, val) => { const el = document.getElementById(id); if(el) el.value = val; };
            setVal('trip-title', trip.title); 
            setVal('trip-location', trip.location); 
            setVal('trip-start', trip.startDate); 
            setVal('trip-end', trip.endDate); 
            setVal('trip-budget', trip.budget || ''); 
            setVal('trip-companions', trip.companions || ''); 
            setVal('trip-memo', trip.memo || '');
            setVal('trip-theme', trip.theme || 'íë§'); 
            setVal('trip-transport', trip.transport || 'ë¹„í–‰ê¸°');
            
            // [Updated] ìˆ˜ì • ì‹œì—ë„ ê¸°ì¡´ ì¥ì†Œ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
            currentSelectedPlaces = trip.selectedPlaces || [];
            
            if (currentSelectedPlaces.length > 0) {
                renderDraggableList(); // ë¦¬ìŠ¤íŠ¸ ë Œë”ë§
                const container = document.getElementById('selected-places-container');
                if(container) {
                    container.classList.remove('hidden');
                    container.style.display = 'block';
                    container.querySelector('label').innerHTML = '<i data-lucide="map-pin" width="12"></i> í¬í•¨ëœ ì—¬í–‰ì§€ (ìˆœì„œ ë³€ê²½ ê°€ëŠ¥)';
                }
            } else {
                const container = document.getElementById('selected-places-container');
                if(container) container.classList.add('hidden');
            }
            
            document.getElementById('create-modal').classList.remove('hidden'); 
            document.getElementById('create-modal').classList.add('flex');
            if(typeof lucide !== 'undefined') lucide.createIcons();
        }
        
        function closeCreateModal() { document.getElementById('create-modal').classList.add('hidden'); document.getElementById('create-modal').classList.remove('flex'); }
        
        function handleCreateOrUpdateTrip(e) {
            e.preventDefault(); 
            let trips = getTrips(); 
            
            const getVal = (id) => {
                const el = document.getElementById(id);
                return el ? el.value : '';
            };

            const editId = getVal('edit-trip-id');
            
            const tripData = { 
                title: getVal('trip-title'), 
                location: getVal('trip-location'), 
                startDate: getVal('trip-start'), 
                endDate: getVal('trip-end'), 
                budget: getVal('trip-budget'), 
                companions: getVal('trip-companions'), 
                memo: getVal('trip-memo'), 
                theme: getVal('trip-theme') || 'íë§',       
                transport: getVal('trip-transport') || 'ë¹„í–‰ê¸°',
                selectedPlaces: currentSelectedPlaces, // í˜„ì¬ ì „ì—­ ë³€ìˆ˜ ê°’ ì‚¬ìš©
                isAI: false 
            };

            if(editId) { 
                const index = trips.findIndex(t => t.id === editId); 
                if(index !== -1) { 
                    trips[index] = { ...trips[index], ...tripData }; 
                    alert('ì¼ì •ì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.'); 
                } 
            } else { 
                trips.push({ id: Date.now().toString(), ...tripData }); 
            }
            
            localStorage.setItem('myTrips', JSON.stringify(trips)); 
            closeCreateModal(); 
            renderTrips(); 
            e.target.reset();
        }
        
        function deleteTrip(id) { 
            if(confirm('ì¼ì •ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) { 
                console.log("ì‚­ì œ ìš”ì²­ id:", id);
                const trips = getTrips(); 
                const newTrips = trips.filter(t => t.id !== id);
                localStorage.setItem('myTrips', JSON.stringify(newTrips)); 
                renderTrips(); 
            } 
        }

        // --- 6. Review Logic ---
        function getMyReviews() { return JSON.parse(localStorage.getItem('myReviews') || '[]'); }
        let currentReviewTripId = null; let editingReviewId = null;
        let currentRating = 5;

        function setRating(rating) {
            currentRating = rating;
            const stars = document.querySelectorAll('#star-container .star-btn');
            const ratingTexts = ["", "1ì  - ì•„ì‰¬ì› ì–´ìš”", "2ì  - ê·¸ì € ê·¸ë¬ì–´ìš”", "3ì  - ê´œì°®ì•˜ì–´ìš”", "4ì  - ì¢‹ì•˜ì–´ìš”!", "5ì  - ìµœê³ ì˜€ì–´ìš”!"];
            
            const textEl = document.getElementById('rating-text');
            if(textEl) textEl.textContent = ratingTexts[rating];
            
            stars.forEach((btn, index) => {
                const icon = btn.querySelector('svg') || btn.querySelector('i');
                if (index < rating) {
                    btn.classList.add('active'); btn.classList.remove('text-gray-300');
                    if(icon) { icon.classList.add('fill-yellow-400', 'text-yellow-400'); icon.classList.remove('text-gray-300'); }
                } else {
                    btn.classList.remove('active'); btn.classList.add('text-gray-300');
                    if(icon) { icon.classList.remove('fill-yellow-400', 'text-yellow-400'); icon.classList.add('text-gray-300'); }
                }
            });
        }

        function renderReviews() {
            const reviews = getMyReviews(); const list = document.getElementById('review-list'); const empty = document.getElementById('review-empty'); const statReviews = document.getElementById('stat-reviews');
            statReviews.textContent = reviews.length; list.innerHTML = '';
            if(reviews.length === 0) { empty.classList.remove('hidden'); } else { empty.classList.add('hidden'); 
                reviews.forEach(review => { 
                    let starsHtml = ''; for(let i=0; i<5; i++) { starsHtml += `<i data-lucide="star" width="12" class="${i < review.rating ? 'fill-yellow-400 text-yellow-400' : 'text-gray-300'}"></i>`; }
                    const placeBadge = review.targetPlace ? `<span class="text-[10px] bg-gray-100 text-gray-500 px-2 py-0.5 rounded ml-2">ğŸ“ ${review.targetPlace}</span>` : '';
                    list.innerHTML += `<div class="bg-white p-4 rounded-xl border border-gray-100 shadow-sm animate-fade-in relative group"><div class="flex justify-between items-start mb-2"><div><div class="flex items-center"><h4 class="font-bold text-sm text-gray-900">${review.tripTitle}</h4>${placeBadge}</div><div class="flex items-center gap-1 mt-1">${starsHtml}</div></div><div class="flex items-center gap-2"><span class="text-xs text-gray-400">${review.date}</span><div class="flex gap-1 pl-2 border-l border-gray-100"><button onclick="openEditReviewModal(${review.id})" class="p-1 text-gray-400 hover:text-blue-500 transition-colors"><i data-lucide="pencil" width="14"></i></button><button onclick="deleteReview(${review.id})" class="p-1 text-gray-400 hover:text-red-500 transition-colors"><i data-lucide="trash-2" width="14"></i></button></div></div></div><p class="text-sm text-gray-600 line-clamp-3 leading-relaxed mt-2">${review.text}</p></div>`; 
                }); lucide.createIcons(); 
            }
        }
        function deleteReview(id) { if(confirm('ì •ë§ ì´ í›„ê¸°ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) { let reviews = getMyReviews(); reviews = reviews.filter(r => r.id !== id); localStorage.setItem('myReviews', JSON.stringify(reviews)); renderReviews(); renderTrips(); } }
        
        function openCreateReviewModal(tripId) { 
            currentReviewTripId = tripId; 
            editingReviewId = null; 
            document.getElementById('review-modal-title').textContent = 'í›„ê¸° ì‘ì„±'; 
            document.getElementById('btn-save-review').textContent = 'ì‘ì„± ì™„ë£Œ'; 
            document.getElementById('review-text').value = ''; 
            
            const trips = getTrips();
            const trip = trips.find(t => t.id === tripId);
            const selectEl = document.getElementById('review-article-select');
            
            if(selectEl) {
                selectEl.innerHTML = '';
                const defaultOpt = document.createElement('option');
                defaultOpt.value = trip ? trip.title : 'ì „ì²´ ì—¬í–‰';
                defaultOpt.textContent = `[ì „ì²´] ${trip ? trip.title : 'ì—¬í–‰ ì „ë°˜'}`;
                selectEl.appendChild(defaultOpt);

                if (trip && trip.selectedPlaces && trip.selectedPlaces.length > 0) {
                    trip.selectedPlaces.forEach(place => {
                        const opt = document.createElement('option');
                        const placeName = place.title || place; 
                        opt.value = placeName;
                        opt.textContent = `ğŸ“ ${placeName}`;
                        selectEl.appendChild(opt);
                    });
                }
            }
            setRating(5); 
            document.getElementById('review-modal').classList.remove('hidden'); 
            document.getElementById('review-modal').classList.add('flex'); 
        }
        
        function openEditReviewModal(reviewId) { 
            const reviews = getMyReviews(); 
            const review = reviews.find(r => r.id === reviewId); 
            if(!review) return; 

            editingReviewId = reviewId; 
            currentReviewTripId = review.tripId; 
            document.getElementById('review-modal-title').textContent = 'í›„ê¸° ìˆ˜ì •'; 
            document.getElementById('btn-save-review').textContent = 'ìˆ˜ì • ì™„ë£Œ'; 
            document.getElementById('review-text').value = review.text; 
            
            const trips = getTrips();
            const trip = trips.find(t => t.id === review.tripId);
            const selectEl = document.getElementById('review-article-select');
            
            if(selectEl) {
                selectEl.innerHTML = '';
                const defaultOpt = document.createElement('option');
                defaultOpt.value = trip ? trip.title : 'ì „ì²´ ì—¬í–‰';
                defaultOpt.textContent = `[ì „ì²´] ${trip ? trip.title : 'ì—¬í–‰ ì „ë°˜'}`;
                selectEl.appendChild(defaultOpt);

                if (trip && trip.selectedPlaces && trip.selectedPlaces.length > 0) {
                    trip.selectedPlaces.forEach(place => {
                        const opt = document.createElement('option');
                        const placeName = place.title || place;
                        opt.value = placeName;
                        opt.textContent = `ğŸ“ ${placeName}`;
                        selectEl.appendChild(opt);
                    });
                }
                selectEl.value = review.targetPlace;
            }
            setRating(review.rating || 5); 
            document.getElementById('review-modal').classList.remove('hidden'); 
            document.getElementById('review-modal').classList.add('flex'); 
        }

        function closeReviewModal() { document.getElementById('review-modal').classList.add('hidden'); document.getElementById('review-modal').classList.remove('flex'); }
        function submitReview() {
            const text = document.getElementById('review-text').value; 
            const selectEl = document.getElementById('review-article-select');
            const targetPlace = selectEl ? selectEl.value : '';

            if(!text) return alert('ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
            
            let reviews = getMyReviews();
            if (editingReviewId) { 
                const index = reviews.findIndex(r => r.id === editingReviewId); 
                if (index !== -1) { reviews[index].text = text; reviews[index].rating = currentRating; reviews[index].targetPlace = targetPlace; reviews[index].date = new Date().toLocaleDateString() + ' (ìˆ˜ì •ë¨)'; alert('í›„ê¸°ê°€ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.'); } 
            } else { 
                const trips = getTrips(); 
                const trip = trips.find(t => t.id === currentReviewTripId); 
                reviews.unshift({ id: Date.now(), tripId: currentReviewTripId, tripTitle: trip ? trip.title : 'ì‚­ì œëœ ì—¬í–‰', text: text, rating: currentRating, targetPlace: targetPlace, date: new Date().toLocaleDateString() }); 
            }
            localStorage.setItem('myReviews', JSON.stringify(reviews)); closeReviewModal(); renderReviews(); renderTrips();
        }

        function renderReviews() {
            const reviews = getMyReviews(); const list = document.getElementById('review-list'); const empty = document.getElementById('review-empty'); const statReviews = document.getElementById('stat-reviews');
            statReviews.textContent = reviews.length; list.innerHTML = '';
            if(reviews.length === 0) { empty.classList.remove('hidden'); } else { empty.classList.add('hidden'); 
                reviews.forEach(review => { 
                    let starsHtml = ''; for(let i=0; i<5; i++) { starsHtml += `<i data-lucide="star" width="12" class="${i < review.rating ? 'fill-yellow-400 text-yellow-400' : 'text-gray-300'}"></i>`; }
                    const placeBadge = review.targetPlace ? `<span class="text-[10px] bg-gray-100 text-gray-500 px-2 py-0.5 rounded ml-2">ğŸ“ ${review.targetPlace}</span>` : '';
                    list.innerHTML += `<div class="bg-white p-4 rounded-xl border border-gray-100 shadow-sm animate-fade-in relative group"><div class="flex justify-between items-start mb-2"><div><div class="flex items-center"><h4 class="font-bold text-sm text-gray-900">${review.tripTitle}</h4>${placeBadge}</div><div class="flex items-center gap-1 mt-1">${starsHtml}</div></div><div class="flex items-center gap-2"><span class="text-xs text-gray-400">${review.date}</span><div class="flex gap-1 pl-2 border-l border-gray-100"><button onclick="openEditReviewModal(${review.id})" class="p-1 text-gray-400 hover:text-blue-500 transition-colors"><i data-lucide="pencil" width="14"></i></button><button onclick="deleteReview(${review.id})" class="p-1 text-gray-400 hover:text-red-500 transition-colors"><i data-lucide="trash-2" width="14"></i></button></div></div></div><p class="text-sm text-gray-600 line-clamp-3 leading-relaxed mt-2">${review.text}</p></div>`; 
                }); lucide.createIcons(); 
            }
        }
        function deleteReview(id) { if(confirm('ì •ë§ ì´ í›„ê¸°ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) { let reviews = getMyReviews(); reviews = reviews.filter(r => r.id !== id); localStorage.setItem('myReviews', JSON.stringify(reviews)); renderReviews(); renderTrips(); } }

        function renderSaved() {
            const favIds = JSON.parse(localStorage.getItem('favorites') || '[]'); const grid = document.getElementById('saved-grid'); const empty = document.getElementById('saved-empty'); const statLikes = document.getElementById('stat-likes'); statLikes.textContent = favIds.length; grid.innerHTML = '';
            const savedArticles = []; favIds.forEach(id => { if(typeof ARTICLES !== 'undefined') { const article = ARTICLES.find(a => a.id === id); if(article) savedArticles.push(article); } });
            if (savedArticles.length === 0) { empty.classList.remove('hidden'); empty.classList.add('flex'); } else { empty.classList.add('hidden'); empty.classList.remove('flex'); savedArticles.forEach(item => { let category = 'ì—¬í–‰'; const allTags = (item.mainTags || []).concat(item.tags || []); if (allTags.some(t => t.match(/ìˆ™ì†Œ|í˜¸í…”|ë¦¬ì¡°íŠ¸|íœì…˜/))) category = 'ìˆ™ì†Œ'; else if (allTags.some(t => t.match(/ë§›ì§‘|ì‹ë‹¹|ì¹´í˜|ìŒì‹ì /))) category = 'ë§›ì§‘'; else if (allTags.some(t => t.match(/ê´€ê´‘|ëª…ì†Œ|íˆ¬ì–´|ì•¡í‹°ë¹„í‹°/))) category = 'ê´€ê´‘'; grid.innerHTML += `<div class="group relative rounded-xl overflow-hidden aspect-[4/3] cursor-pointer shadow-sm border border-gray-100"><div class="absolute top-2 left-2 z-20" onclick="event.stopPropagation();"><input type="checkbox" class="saved-item-checkbox custom-checkbox w-6 h-6 rounded border-2 border-white bg-black/30 checked:bg-accent checked:border-accent cursor-pointer transition-all shadow-sm" data-id="${item.id}"></div><div onclick="location.href='article.html?id=${item.id}'" class="w-full h-full relative"><img src="${item.imageUrl}" class="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110"><div class="absolute inset-0 bg-gradient-to-t from-black/80 via-transparent to-transparent"></div><div class="absolute top-2 right-2 z-20"><button onclick="event.stopPropagation(); removeFavoriteFromMyPage('${item.id}')" class="bg-white/20 backdrop-blur p-1.5 rounded-full text-white hover:bg-red-500 hover:text-white transition-colors"><i data-lucide="x" width="16"></i></button></div><div class="absolute bottom-4 left-4 right-4 text-white"><span class="inline-block px-2 py-0.5 rounded-md bg-black/30 backdrop-blur-sm text-[10px] font-bold mb-1 border border-white/20">${category}</span><h4 class="font-bold text-sm leading-tight line-clamp-2 drop-shadow-md">${item.title}</h4></div></div></div>`; }); lucide.createIcons(); }
        }
        function removeFavoriteFromMyPage(id) { toggleFavorite(id); renderSaved(); }

        window.addEventListener('DOMContentLoaded', () => {
            if (localStorage.getItem('isLoggedIn') !== 'true') { alert('ë¡œê·¸ì¸ì´ í•„ìš”í•œ ì„œë¹„ìŠ¤ì…ë‹ˆë‹¤.'); location.href = 'login.html'; return; }
            loadProfile(); renderTrips(); renderSaved(); renderReviews(); lucide.createIcons(); setRating(5); 
            const hash = window.location.hash.replace('#', ''); if(['trips', 'saved', 'reviews'].includes(hash)) switchTab(hash); else switchTab('saved');
        });
    </script>
</body>
</html>
