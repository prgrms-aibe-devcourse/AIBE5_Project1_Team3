
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ìƒì„¸ ì •ë³´ - ì—¬ê¸°ì €ê¸°</title>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link rel="stylesheet" href="../css/global.css">
    <link rel="stylesheet" href="../css/article.css">
</head>
<body style="padding-bottom: 0rem;">

    <!-- Header Navigation -->
    <div id="article-nav" class="navbar" style="background: transparent;">
        <div class="nav-inner">
            <div class="flex gap-2">
                <a href="javascript:history.back()" class="nav-icon-btn">
                    <i data-lucide="chevron-left" width="24"></i>
                </a>
                <!-- í™ˆ ë²„íŠ¼ -->
                <a href="./index.html" class="nav-icon-btn">
                    <i data-lucide="home" width="24"></i>
                </a>
            </div>
            <div class="flex gap-2">
                <button id="search-btn" class="nav-icon-btn">
                    <i data-lucide="search" width="20"></i>
                </button>
                <button id="share-btn" class="nav-icon-btn">
                    <i data-lucide="share-2" width="20"></i>
                </button>
                <button id="detail-like-btn" class="nav-icon-btn">
                    <i data-lucide="heart" width="20"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- Hero Media -->
    <div class="hero-header">
        <img id="d-image" src="" alt="Hero">
        <div class="hero-gradient"></div>
        
        <div class="hero-text-overlay">
            <div class="flex items-center gap-2 mb-2">
                <span id="d-category" class="card-badge"></span>
                <span id="d-season" class="card-badge"></span>
            </div>
            <h1 id="d-title" class="text-3xl font-black mb-2" style="line-height: 1.2;"></h1>
            <p id="d-subtitle" class="text-white" style="opacity: 0.9;"></p>
        </div>
    </div>

    <!-- Main Content -->
    <div class="article-container">

        <!-- Tags -->
        <div id="d-tags" class="tags-container"></div>

        <!-- íƒœê·¸ ë”ë³´ê¸° ë²„íŠ¼ ì¶”ê°€ -->
        <button id="tag-toggle-btn" class="tag-toggle">+ ë”ë³´ê¸°</button>

        <!-- Accordion Sections -->
        <div class="accordion-wrapper">

            <p id="d-desc" style="text-align: center"></p>

            <!-- Program Info -->
            <div class="accordion-item">
                <button class="accordion-btn" onclick="toggleAccordion(this)">
                    <span class="font-bold text-gray-900">ğŸ—ºï¸ í”„ë¡œê·¸ë¨ ì†Œê°œ</span>
                    <i data-lucide="chevron-down" width="20" class="text-gray-400"></i>
                </button>
                <div class="accordion-content open">
                    <div class="content-inner" id="d-content">
                        <!-- Content Injected -->
                    </div>
                </div>
            </div>

            <!-- Course Info -->
            <div class="accordion-item">
                <button class="accordion-btn" onclick="toggleAccordion(this)">
                    <span class="font-bold text-gray-900">ğŸ“ ì¥ì†Œ ì•ˆë‚´</span>
                    <i data-lucide="chevron-down" width="20" class="text-gray-400"></i>
                </button>
                <div class="accordion-content open">
                    <div class="content-inner">
                         <div class="flex items-center" style="margin-bottom: 1rem;">
                            <i data-lucide="map-pin" class="text-accent" width="20" style="margin-right: 0.5rem;"></i>
                            <span id="d-name" class="font-medium text-gray-800"></span>
                         </div>
                         <!-- Map Area with ID for JS injection -->
                         <div id="d-map" style="width: 100%; height: 250px; background-color: var(--gray-200); border-radius: var(--radius-lg); overflow: hidden;">
                             <!-- Iframe will be injected here -->
                         </div>
                         <br>
                         <span id="d-address" class="font-medium text-gray-800"></span>
                    </div>
                </div>
            </div>

            <!-- Host Info Bar -->
            <div class="host-info-bar">
                <div class="host-profile">
                    <div class="host-avatar">
                        <img src="https://api.dicebear.com/7.x/avataaars/svg?seed=Host" class="object-cover w-full h-full">
                    </div>
                    <div>
                        <p class="text-xs text-gray-500">Hosted by</p>
                        <p id="d-host" class="text-sm font-bold text-gray-900"></p>
                    </div>
                </div>
                <div class="host-rating">
                    <i data-lucide="star" width="16" fill="currentColor"></i>
                    <span id="d-rating"></span>
                </div>
            </div>

            <!-- Reviews -->
            <div class="accordion-item">
                <button class="accordion-btn" onclick="toggleAccordion(this)">
                    <span class="font-bold text-gray-900">ğŸ’¬ ìƒìƒ í›„ê¸°</span>
                    <i data-lucide="chevron-down" width="20" class="text-gray-400"></i>
                </button>
                <div class="accordion-content open"> <!-- Default Open -->
                    <div id="d-reviews" class="content-inner" style="display: flex; flex-direction: column; gap: 1rem;">
                        <!-- Reviews Injected -->
                    </div>
                </div>
            </div>

            <!-- ì¶”ì²œ ì—¬í–‰ì§€ (carousel: 3 items visible) -->
            <div class="accordion-item">
                <button class="accordion-btn" onclick="toggleAccordion(this)">
                    <span class="font-bold text-gray-900">ğŸ“¢ ì¶”ì²œ ì—¬í–‰ì§€</span>
                </button>
                <div class="accordion-content open">
                    <div class="advise-carousel">
                        <button class="advise-prev" aria-label="Previous">
                            <i data-lucide="chevron-left" width="20"></i>
                        </button>
                        <div class="advise-viewport">
                            <div id="advise-content" class="advise-track">
                                <div class="content-inner">ì»¨í…íŠ¸ 1</div>
                                <div class="content-inner">ì»¨í…íŠ¸ 2</div>
                                <div class="content-inner">ì»¨í…íŠ¸ 3</div>
                                <div class="content-inner">ì»¨í…íŠ¸ 4</div>
                                <div class="content-inner">ì»¨í…íŠ¸ 5</div>
                                <div class="content-inner">ì»¨í…íŠ¸ 6</div>
                                <div class="content-inner">ì»¨í…íŠ¸ 7</div>
                                <div class="content-inner">ì»¨í…íŠ¸ 8</div>
                                <div class="content-inner">ì»¨í…íŠ¸ 9</div>
                            </div>
                        </div>
                        <button class="advise-next" aria-label="Next">
                            <i data-lucide="chevron-right" width="20"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Data Script Loaded Before Logic -->
    <script src="../js/data.js"></script>
    <script src="../js/script.js"></script>
    
    <!-- Main Logic using Global Variables -->
    <script>
        // Global function for Accordion (needs to be on window for onclick attribute)
        window.toggleAccordion = function(btn) {
            const content = btn.nextElementSibling;
            content.classList.toggle('open');
        }

        // Load Data
        const urlParams = new URLSearchParams(window.location.search);
        const articleId = urlParams.get('id');
        window.currentArticle = null;
        
        // Use utility function from script.js if available
        if(typeof addToRecent === 'function' && articleId) {
            addToRecent(articleId);
        }

        window.currentArticle = ARTICLES.find(a => a.id === articleId);

        if (!window.currentArticle) {
            alert('ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
            location.href = 'index.html';
        } else {
            const art = window.currentArticle;
            document.getElementById('d-image').src = art.imageUrl;
            document.getElementById('d-title').textContent = art.title;
            document.getElementById('d-subtitle').textContent = art.subtitle;

            document.getElementById('d-desc').textContent = art.description;
            document.getElementById('d-content').innerHTML = art.content;

            document.getElementById('d-name').textContent = art.name;
            document.getElementById('d-address').textContent = art.address;

            document.getElementById('d-host').textContent = art.host;
            document.getElementById('d-rating').textContent = art.rating;

            // --- Inject Map Iframe ---
            const mapContainer = document.getElementById('d-map');
            if(mapContainer) {
                const mapFrame = document.createElement('iframe');
                mapFrame.src = `map.html?mode=embed&id=${art.id}`;
                mapFrame.style.width = '100%';
                mapFrame.style.height = '100%';
                mapFrame.style.border = 'none';
                mapFrame.setAttribute('loading', 'lazy');
                mapContainer.innerHTML = ''; 
                mapContainer.appendChild(mapFrame);
            }

            const tagsContainer = document.getElementById('d-tags');
            // ì•„í‹°í´ íƒœê·¸ ë”ë³´ê¸° ë¡œì§ 
            const toggleBtn = document.getElementById('tag-toggle-btn');
            const tagBox = document.getElementById('d-tags');

            toggleBtn.addEventListener('click', () => {
            tagBox.classList.toggle('open');

            if (tagBox.classList.contains('open')) {
                toggleBtn.textContent = 'ì ‘ê¸°';
            } else {
                toggleBtn.textContent = '+ ë”ë³´ê¸°';
            }
            });
            art.tags.forEach(tag => {
                const btn = document.createElement('button');
                btn.className = 'tag cursor-pointer';
                btn.textContent = tag;
                btn.onclick = () => location.href = `index.html?tag=${encodeURIComponent(tag)}`;
                tagsContainer.appendChild(btn);
            });

            // Populate ì¶”ì²œ ì—¬í–‰ì§€ cards (randomized, exclude current)
            (function populateAdviseCards(){
                const track = document.getElementById('advise-content');
                if (!track) return;
                if (typeof ARTICLES === 'undefined') {
                    console.warn('ARTICLES not found; ensure ../js/data.js is loaded');
                    return;
                }
                // build pool excluding current
                const pool = ARTICLES.filter(a => a.id !== articleId && a.imageUrl);
                // shuffle
                for (let i = pool.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [pool[i], pool[j]] = [pool[j], pool[i]];
                }
                const picks = pool.slice(0, Math.min(pool.length, 9));
                track.innerHTML = '';
                picks.forEach(item => {
                    const card = document.createElement('a');
                    card.className = 'content-inner';
                    card.href = `article.html?id=${encodeURIComponent(item.id)}`;
                    card.setAttribute('aria-label', item.title);
                    card.style.backgroundImage = `url('${item.imageUrl}')`;
                    const shortDesc = (item.description || '').replace(/\s+/g,' ').trim().slice(0,80);
                    // store full text on dataset so we can produce truncated display without losing original
                    card.dataset.fullTitle = item.title || '';
                    card.dataset.fullSubtitle = (item.subtitle || shortDesc || '') + '';
                    card.innerHTML = `
                        <div class="advise-card-overlay"></div>
                        <div class="advise-card-info">
                            <h4></h4>
                            <p></p>
                        </div>
                    `;
                    track.appendChild(card);
                });

                function escapeHtml(s){
                    return String(s || '').replace(/[&<>\"']/g, function(c){
                        return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"}[c];
                    });
                }
            })();

            // Truncate title/subtitle by character count and show ellipsis (preserve full text in aria-label)
            function truncateCardTexts(titleLimit = 36, subtitleLimit = 56){
                const cards = document.querySelectorAll('#advise-content .content-inner');
                if(!cards || cards.length === 0) return;
                cards.forEach(card => {
                    const h = card.querySelector('h4');
                    const p = card.querySelector('p');
                    const fullTitle = card.dataset.fullTitle || '';
                    const fullSubtitle = card.dataset.fullSubtitle || '';
                    if(h){
                        h.textContent = truncateString(fullTitle, titleLimit);
                        h.title = fullTitle;
                    }
                    if(p){
                        p.textContent = truncateString(fullSubtitle, subtitleLimit);
                        p.title = fullSubtitle;
                    }
                });

                function truncateString(s, max){
                    if(!s) return '';
                    if(s.length <= max) return s;
                    return s.slice(0, max - 1).trim() + 'â€¦';
                }
            }

            // run after populate and layout stabilizes
            setTimeout(()=>{ truncateCardTexts(); }, 80);

            const reviewContainer = document.getElementById('d-reviews');
            if (art.reviews) {
                art.reviews.forEach(review => {
                    const div = document.createElement('div');
                    div.style.background = 'var(--gray-50)';
                    div.style.padding = '1rem';
                    div.style.borderRadius = 'var(--radius-xl)';
                    div.innerHTML = `
                        <div class="flex justify-between items-start" style="margin-bottom: 0.5rem;">
                            <div class="flex items-center gap-2">
                                <div style="width: 24px; height: 24px; background: var(--gray-200); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 10px; font-weight: bold; color: var(--gray-500);">${review.user[0]}</div>
                                <span class="text-sm font-bold">${review.user}</span>
                            </div>
                            <span class="text-xs text-gray-400">
                                <i data-lucide="star" width="16" height="16" fill="currentColor" style="vertical-align: middle; transform: translateY(-1px);"></i>
                                ${review.rating}
                                </span>
                        </div>
                        <p class="text-sm text-gray-700">${review.comment}</p>
                    `;
                    reviewContainer.appendChild(div);
                });
            }

            // Search button logic
            const searchBtn = document.getElementById('search-btn');
            if (searchBtn) {
                searchBtn.addEventListener('click', () => {
                    window.location.href = 'index.html';
                });
            }

            // ê³µìœ í•˜ê¸° ë²„íŠ¼
            const shareBtn = document.getElementById('share-btn');
            function handleShare() {
                if (navigator.share) {
                    navigator.share({
                        title: art.title,
                        subtitle: art.subtitle,
                        url: window.location.href
                    }).catch(() => {});
                } else {
                    navigator.clipboard.writeText(window.location.href)
                    .then(() => {
                        if (typeof showToast === 'function') {
                            showToast('ë§í¬ê°€ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
                        } else {
                            alert('ë§í¬ê°€ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤.');
                        }
                    });
                }
            }
            shareBtn.onclick = () => {
                handleShare();
            };

            // Like button logic
            const likeBtn = document.getElementById('detail-like-btn');
            const heartIcon = likeBtn.querySelector('i');
            likeBtn.dataset.id = articleId;
            
            function updateLikeState() {
                if (typeof getFavorites !== 'function') return;

                const favorites = getFavorites();
                const heartIcon = likeBtn.querySelector('svg') || likeBtn.querySelector('i');
                if (!heartIcon) return;

                if (favorites.includes(articleId)) {
                    likeBtn.style.backgroundColor = 'var(--red-500)';
                    likeBtn.style.borderColor = 'var(--red-500)';
                    heartIcon.style.color = 'white';
                    heartIcon.setAttribute('fill', 'currentColor');
                } else {
                    heartIcon.setAttribute('fill', 'none');
                }
            }

            likeBtn.onclick = () => {
                if (typeof toggleFavorite === 'function') {
                    toggleFavorite(articleId);
                    updateLikeState();
                }
            };
            
            if (typeof lucide !== 'undefined') lucide.createIcons();
            updateLikeState();
        }
    </script>

            <!-- ì¶”ì²œ ì—¬í–‰ì§€ ì¢Œìš° ë²„íŠ¼ / ìŠ¬ë¼ì´ë“œ ë¡œì§ -->
            <script>
            (function(){
                const track = document.getElementById('advise-content');
                const prev = document.querySelector('.advise-prev');
                const next = document.querySelector('.advise-next');
                if (!track || !prev || !next) return;

                let index = 0;
                const items = () => track.querySelectorAll('.content-inner');

                function getGapPx(){
                    const list = items();
                    if (list.length < 2) return 0;
                    const a = list[0].getBoundingClientRect();
                    const b = list[1].getBoundingClientRect();
                    return Math.max(0, b.left - a.right);
                }

                function getVisibleCount(){
                    return 2; // force two cards visible to avoid partial third card
                }

                function updateButtons(){
                    const vc = getVisibleCount();
                    const maxIndex = Math.max(0, items().length - vc);
                    prev.disabled = index <= 0;
                    next.disabled = index >= maxIndex;
                    prev.style.opacity = prev.disabled ? '0.45' : '1';
                    next.style.opacity = next.disabled ? '0.45' : '1';
                }

                function slide(){
                    const it = items()[0];
                    if(!it) return;
                    const gap = getGapPx();
                    const shift = index * (it.getBoundingClientRect().width + gap);
                    track.style.transform = `translateX(-${shift}px)`;
                    updateButtons();
                }

                next.addEventListener('click', ()=>{
                    const vc = getVisibleCount();
                    const maxIndex = Math.max(0, items().length - vc);
                    index = Math.min(maxIndex, index + 1);
                    slide();
                });
                prev.addEventListener('click', ()=>{ index = Math.max(0, index - 1); slide(); });

                window.addEventListener('resize', ()=>{
                    index = Math.min(index, Math.max(0, items().length - getVisibleCount()));
                    slide();
                    truncateCardTexts();
                });

                // initial render after layout
                setTimeout(()=>{ if(window.lucide) window.lucide.createIcons(); slide(); truncateCardTexts(); }, 60);
            })();
            </script>

   <!-- Gemini AI Logic -->
<script type="module">
    import { GoogleGenerativeAI } from "https://esm.run/@google/generative-ai";

    const btnGenerate = document.getElementById('btn-generate-ai');
    const aiIntro = document.getElementById('ai-intro');
    const aiLoading = document.getElementById('ai-loading');
    const aiResult = document.getElementById('ai-result');
    const aiContentBox = document.getElementById('ai-content-box');
    const btnSave = document.getElementById('btn-save-itinerary');

    let generatedItineraryText = ""; 

    // API Key from environment
    const API_KEY = process.env.API_KEY; 

    if (btnGenerate) {
        btnGenerate.addEventListener('click', async () => {
            const article = window.currentArticle;
            if (!article) {
                alert('ì—¬í–‰ì§€ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.');
                return;
            }

            aiIntro.classList.add('hidden');
            aiLoading.classList.remove('hidden');
            
            try {
                const genAI = new GoogleGenerativeAI(API_KEY);
                const model = genAI.getGenerativeModel({ model: "gemini-3-flash-preview" });

                const prompt = `
                    ì „ë¬¸ ì—¬í–‰ í”Œë˜ë„ˆë¡œì„œ ì—¬í–‰ ì¶”ì²œ ì‚¬ì´íŠ¸ì—ì„œ í™œìš©í•  ìˆ˜ ìˆëŠ” ê³ í€„ë¦¬í‹°ë¡œ ë‹¤ìŒ ì—¬í–‰ì§€ì— ëŒ€í•œ ìƒì„¸í•œ 3ì¼ ì—¬í–‰ ì½”ìŠ¤ë¥¼ ìì„¸í•˜ê²Œ ì§œì¤˜.
                    ì—¬í–‰ì§€: "${article.title}"
                    í…Œë§ˆ: ${article.tags.join(', ')}
                    ì„¤ëª…: ${article.description}
                    ì¶œë ¥ì€ ë°˜ë“œì‹œ HTML íƒœê·¸ë¥¼ ì‚¬ìš©í•´ì„œ ê¹”ë”í•˜ê²Œ í•´ì¤˜. (<h3>, <ul>, <li>, <strong>)
                    ë§ˆí¬ë‹¤ìš´ ê¸°í˜¸(\`\`\`html ë“±)ëŠ” ì“°ì§€ ë§ˆ. í•œêµ­ì–´ë¡œ ì‘ì„±í•´.
                `;

                const result = await model.generateContent(prompt);
                const response = await result.response;
                generatedItineraryText = response.text(); 

                aiLoading.classList.add('hidden');
                aiResult.classList.remove('hidden');
                aiContentBox.innerHTML = generatedItineraryText;

                if (window.lucide) window.lucide.createIcons();

            } catch (error) {
                console.error("AI ìƒì„± ì—ëŸ¬:", error);
                alert("ì½”ìŠ¤ ìƒì„± ì¤‘ ì—ëŸ¬ ë°œìƒ (Gemini API): " + error.message);
                aiLoading.classList.add('hidden');
                aiIntro.classList.remove('hidden');
            }
        });
    }

    // ë§ˆì´í˜ì´ì§€ ì €ì¥ ë° ì´ë™ ë¡œì§
    if (btnSave) {
        btnSave.addEventListener('click', () => {
            console.log("ì €ì¥ ë²„íŠ¼ í´ë¦­ë¨"); 
            
            const article = window.currentArticle;
            
            if (localStorage.getItem('isLoggedIn') !== 'true') {
                if(confirm('ë¡œê·¸ì¸ì´ í•„ìš”í•œ ê¸°ëŠ¥ì…ë‹ˆë‹¤. ë¡œê·¸ì¸í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                    location.href = 'login.html';
                }
                return;
            }
            
            let contentToSave = generatedItineraryText;
            if (!contentToSave || contentToSave.trim() === "") {
                if (aiContentBox && aiContentBox.innerHTML.trim() !== "") {
                    contentToSave = aiContentBox.innerHTML;
                }
            }

            if (!article || !contentToSave) {
                alert('ì €ì¥í•  ì½”ìŠ¤ ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € ì½”ìŠ¤ë¥¼ ìƒì„±í•´ ì£¼ì„¸ìš”.');
                return;
            }

            try {
                let saved = [];
                const rawData = localStorage.getItem('myItineraries');
                if (rawData) {
                    try {
                        saved = JSON.parse(rawData);
                    } catch (e) {
                        saved = [];
                    }
                }

                const newItinerary = {
                    id: Date.now().toString(),
                    articleId: article.id,
                    title: `${article.title} - AI ì¶”ì²œ ì½”ìŠ¤`,
                    content: contentToSave,
                    date: new Date().toLocaleDateString(),
                    image: article.imageUrl
                };

                saved.unshift(newItinerary);
                localStorage.setItem('myItineraries', JSON.stringify(saved));
                
                alert('ë§ˆì´í˜ì´ì§€ì— ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!');
                
                // 2ì¤‘ ì²´í¬: ì´ë™
                setTimeout(() => {
                    window.location.href = 'mypage.html';
                }, 100);

            } catch (err) {
                console.error("ì €ì¥ ì¤‘ ì—ëŸ¬ ë°œìƒ:", err);
                alert("ì €ì¥í•˜ëŠ” ë™ì•ˆ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: " + err.message);
            }
        });
    }
</script>
</body>
</html>
