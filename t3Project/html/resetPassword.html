<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ì—¬ê¸°ì €ê¸° : ìƒˆ ë¹„ë°€ë²ˆí˜¸ ì„¤ì •</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="../css/global.css">
    <link rel="stylesheet" href="../css/auth.css">
</head>
<body class="bg-gray-50 h-screen flex items-center justify-center p-6">

    <div class="w-full max-w-md bg-white rounded-3xl shadow-xl p-8 md:p-10">
        <div class="text-center mb-8">
            <h1 class="text-2xl font-black mb-2">ìƒˆ ë¹„ë°€ë²ˆí˜¸ ì„¤ì •</h1>
            <p class="text-gray-500 text-sm">ìƒˆë¡œ ì‚¬ìš©í•  ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.</p>
        </div>

        <form id="reset-form" class="space-y-4">
            <div>
                <input id="new-password" type="password" placeholder="ìƒˆ ë¹„ë°€ë²ˆí˜¸" class="w-full px-4 py-3 rounded-xl bg-gray-50 border-gray-100 border focus:border-blue-600 focus:bg-white focus:outline-none transition-colors text-sm" required>
            </div>
            <div>
                <input id="confirm-password" type="password" placeholder="ìƒˆ ë¹„ë°€ë²ˆí˜¸ í™•ì¸" class="w-full px-4 py-3 rounded-xl bg-gray-50 border-gray-100 border focus:border-blue-600 focus:bg-white focus:outline-none transition-colors text-sm" required>
            </div>
            <button type="submit" id="btn-update" class="w-full py-3.5 bg-blue-600 text-white rounded-xl font-bold hover:bg-blue-700 transition-colors shadow-lg">
                ë¹„ë°€ë²ˆí˜¸ ë³€ê²½í•˜ê¸°
            </button>
        </form>
    </div>

    <script src="../js/script.js"></script>
    <script>
        const form = document.getElementById('reset-form');
        const btn = document.getElementById('btn-update');

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì„¸ì…˜ í™•ì¸ (ë§í¬ê°€ ìœ íš¨í•œì§€ ì²´í¬)
        window.addEventListener('DOMContentLoaded', async () => {
            const supabase = window.supabaseClient;
            // Supabaseê°€ URLì˜ í† í°(#access_token=...)ì„ ê°ì§€í•˜ë©´ ìë™ìœ¼ë¡œ ì„¸ì…˜ì„ ë³µêµ¬í•©ë‹ˆë‹¤.
            const { data: { session } } = await supabase.auth.getSession();

            if (!session) {
                showAuthModal("ìœ íš¨í•˜ì§€ ì•Šê±°ë‚˜ ë§Œë£Œëœ ë§í¬", `ìƒˆë¡œê³ ì¹¨í•˜ì—¬ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”. `, "âš ï¸");
                location.href = 'forgot-password.html';
            }
        });

        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const newPassword = document.getElementById('new-password').value;
            const confirmPassword = document.getElementById('confirm-password').value;
            const supabase = window.supabaseClient;

            if (newPassword !== confirmPassword) {
                showAuthModal("ì…ë ¥ ì˜¤ë¥˜", "ë¹„ë°€ë²ˆí˜¸ê°€ ì„œë¡œ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ë‹¤ì‹œ í™•ì¸í•´ì£¼ì„¸ìš”.", "âŒ");
                return;
            }

            if (newPassword.length < 6) {
                showAuthModal("ë³´ì•ˆ ê²½ê³ ", "ë¹„ë°€ë²ˆí˜¸ëŠ” ìµœì†Œ 6ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.", "ğŸ”");
                return;
            }

            btn.disabled = true;
            btn.textContent = "ë³€ê²½ ì¤‘...";

            try {
                // ì‚¬ìš©ìê°€ ë¡œê·¸ì¸ëœ ìƒíƒœ(ë§í¬ í´ë¦­ ì§í›„)ì´ë¯€ë¡œ updateUserë¡œ ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ ê°€ëŠ¥
                const { data, error } = await supabase.auth.updateUser({
                    password: newPassword
                });

                if (error) throw error;

                showAuthModal("ë³€ê²½ ì™„ë£Œ", "ë¹„ë°€ë²ˆí˜¸ê°€ ì„±ê³µì ìœ¼ë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.\nìƒˆ ë¹„ë°€ë²ˆí˜¸ë¡œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.", "âœ…");
                
                // ë¡œê·¸ì•„ì›ƒ í›„ ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™ (ì•ˆì „í•˜ê²Œ)
                await supabase.auth.signOut();
                location.href = 'login.html';

            } catch (error) {
                showAuthModal("ë³€ê²½ ì‹¤íŒ¨", error.message, "âš ï¸");
                btn.disabled = false;
                btn.textContent = "ë¹„ë°€ë²ˆí˜¸ ë³€ê²½í•˜ê¸°";
            }
        });
    </script>
</body>
</html>