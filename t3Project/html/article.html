
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ìƒì„¸ ì •ë³´ - ì—¬ê¸°ì €ê¸°</title>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link rel="stylesheet" href="../css/global.css">
    <link rel="stylesheet" href="../css/article.css">
</head>
<body style="padding-bottom: 8rem;">

    <!-- Header Navigation -->
    <div id="article-nav" class="navbar" style="background: transparent;">
        <div class="nav-inner">
            <div class="flex gap-2">
                <a href="javascript:history.back()" class="nav-icon-btn">
                    <i data-lucide="chevron-left" width="24"></i>
                </a>
                <a href="index.html" class="nav-icon-btn">
                    <i data-lucide="home" width="20"></i>
                </a>
            </div>
            <div class="flex gap-2">
                <button class="nav-icon-btn">
                    <i data-lucide="share-2" width="20"></i>
                </button>
                <button class="nav-icon-btn">
                    <i data-lucide="search" width="20"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- Hero Media -->
    <div class="hero-header">
        <img id="d-image" src="" alt="Hero">
        <div class="hero-gradient"></div>
        
        <div class="hero-text-overlay">
            <div class="flex items-center gap-2 mb-2">
                <span id="d-category" class="card-badge"></span>
                <span id="d-season" class="card-badge"></span>
            </div>
            <h1 id="d-title" class="text-3xl font-black mb-2" style="line-height: 1.2;"></h1>
            <p id="d-subtitle" class="text-white" style="opacity: 0.9;"></p>
        </div>
    </div>

    <!-- Host Info Bar -->
    <div class="host-info-bar">
        <div class="host-profile">
            <div class="host-avatar">
                <img src="https://api.dicebear.com/7.x/avataaars/svg?seed=Host" class="object-cover w-full h-full">
            </div>
            <div>
                <p class="text-xs text-gray-500">Hosted by</p>
                <p id="d-host" class="text-sm font-bold text-gray-900"></p>
            </div>
        </div>
        <div class="host-rating">
            <i data-lucide="star" width="16" fill="currentColor"></i>
            <span id="d-rating"></span>
        </div>
    </div>

    <!-- Main Content -->
    <div class="article-container">
        
        <p id="d-desc" class="article-desc"></p>

        <!-- Tags -->
        <div id="d-tags" class="tags-container"></div>

        <!-- Accordion Sections -->
        <div class="accordion-wrapper">
            
            <!-- Gemini AI Itinerary Generator -->
            <div class="accordion-item ai-section">
                <button class="accordion-btn" onclick="toggleAccordion(this)">
                    <span class="font-bold" style="color: var(--indigo-600); display: flex; align-items: center; gap: 0.5rem;">
                        <i data-lucide="sparkles" width="20"></i> AI ë§ì¶¤ ì—¬í–‰ ì½”ìŠ¤
                    </span>
                    <i data-lucide="chevron-down" width="20" class="text-gray-400"></i>
                </button>
                <div class="accordion-content">
                    <div class="content-inner">
                        <div id="ai-intro" class="text-center">
                            <p class="text-sm text-gray-600" style="margin-bottom: 1rem;">
                                ì—¬ê¸°ì €ê¸°ê°€ <strong><span id="ai-destination-name"></span></strong> ì—¬í–‰ì„ ìœ„í•œ <br>
                                ìµœì ì˜ 3ì¼ ì½”ìŠ¤ë¥¼ ì œì•ˆí•´ ë“œë¦½ë‹ˆë‹¤.
                            </p>
                            <button id="btn-generate-ai" class="btn btn-primary" style="background-color: var(--indigo-600); box-shadow: var(--shadow-md);">
                                <i data-lucide="wand-2" width="18" style="margin-right: 0.5rem;"></i> ì½”ìŠ¤ ìƒì„±í•˜ê¸°
                            </button>
                        </div>

                        <div id="ai-loading" class="hidden text-center" style="padding: 2rem 0;">
                            <div class="ai-loading-spinner"></div>
                            <p style="color: var(--indigo-600); font-weight: bold;">Geminiê°€ ì—¬í–‰ ê³„íšì„ ì§œê³  ìˆì–´ìš”...</p>
                            <p class="text-xs text-gray-400" style="margin-top: 0.5rem;">ì•½ 10~20ì´ˆ ì •ë„ ì†Œìš”ë©ë‹ˆë‹¤.</p>
                        </div>

                        <div id="ai-result" class="hidden">
                            <div id="ai-content-box" style="background: white; padding: 1.5rem; border-radius: var(--radius-xl); border: 1px solid var(--indigo-50); margin-bottom: 1rem; font-size: 0.875rem; line-height: 1.6;">
                                <!-- Result injected here -->
                            </div>
                            <button id="btn-save-itinerary" class="btn w-full" style="background: white; border: 1px solid var(--indigo-600); color: var(--indigo-600);">
                                <i data-lucide="bookmark" width="18" style="margin-right: 0.5rem;"></i> ë§ˆì´í˜ì´ì§€ì— ì €ì¥
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Program Info -->
            <div class="accordion-item">
                <button class="accordion-btn" onclick="toggleAccordion(this)">
                    <span class="font-bold text-gray-900">ğŸ—ºï¸ í”„ë¡œê·¸ë¨ ì†Œê°œ</span>
                    <i data-lucide="chevron-down" width="20" class="text-gray-400"></i>
                </button>
                <div class="accordion-content">
                    <div class="content-inner" id="d-content">
                        <!-- Content Injected -->
                    </div>
                </div>
            </div>

            <!-- Course Info -->
            <div class="accordion-item">
                <button class="accordion-btn" onclick="toggleAccordion(this)">
                    <span class="font-bold text-gray-900">ğŸ“ ì½”ìŠ¤ ì•ˆë‚´</span>
                    <i data-lucide="chevron-down" width="20" class="text-gray-400"></i>
                </button>
                <div class="accordion-content">
                    <div class="content-inner">
                         <div class="flex items-center" style="margin-bottom: 1rem;">
                            <i data-lucide="map-pin" class="text-accent" width="20" style="margin-right: 0.5rem;"></i>
                            <span id="d-course" class="font-medium text-gray-800"></span>
                         </div>
                         <div style="width: 100%; height: 200px; background-color: var(--gray-200); border-radius: var(--radius-lg); display: flex; align-items: center; justify-content: center; color: var(--gray-500); font-size: 0.875rem;">
                             Google Map Area
                         </div>
                    </div>
                </div>
            </div>

            <!-- Reviews -->
            <div class="accordion-item">
                <button class="accordion-btn" onclick="toggleAccordion(this)">
                    <span class="font-bold text-gray-900">ğŸ’¬ ìƒìƒ í›„ê¸°</span>
                    <i data-lucide="chevron-down" width="20" class="text-gray-400"></i>
                </button>
                <div class="accordion-content open"> <!-- Default Open -->
                    <div id="d-reviews" class="content-inner" style="display: flex; flex-direction: column; gap: 1rem;">
                        <!-- Reviews Injected -->
                    </div>
                </div>
            </div>

        </div>
    </div>

    <!-- Sticky Bottom Bar -->
    <div class="bottom-bar">
        <div>
            <div class="flex items-center gap-1" style="margin-bottom: 0.125rem;">
                <span id="d-price" class="price-tag"></span>
                <span class="text-xs text-gray-400">/ 1ì¸</span>
            </div>
            <p style="font-size: 0.625rem; color: var(--green-600); font-weight: bold;">ì¦‰ì‹œ ì˜ˆì•½ ê°€ëŠ¥</p>
        </div>
        <div class="flex gap-2">
            <button id="detail-like-btn" class="like-btn">
                <i data-lucide="heart" width="24" style="color: var(--gray-400);"></i>
            </button>
            <button class="btn btn-reserve">
                ì˜ˆì•½í•˜ê¸°
            </button>
        </div>
    </div>

    <script src="../js/data.js"></script>
    <script src="../js/script.js"></script>
    <script>
        // ì•„ì½”ë””ì–¸ í† ê¸€ í•¨ìˆ˜
        function toggleAccordion(btn) {
            const content = btn.nextElementSibling;
            content.classList.toggle('open');
        }

        // ë°ì´í„° ë¡œë“œ
        const urlParams = new URLSearchParams(window.location.search);
        const articleId = urlParams.get('id');
        window.currentArticle = null;
        
        if(articleId) addToRecent(articleId);

        window.currentArticle = ARTICLES.find(a => a.id === articleId);

        if (!window.currentArticle) {
            alert('ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
            location.href = 'index.html';
        } else {
            const art = window.currentArticle;
            document.getElementById('d-image').src = art.imageUrl;
            document.getElementById('d-title').textContent = art.title;
            document.getElementById('ai-destination-name').textContent = art.title;
            document.getElementById('d-subtitle').textContent = art.subtitle;
            document.getElementById('d-category').textContent = art.category;
            document.getElementById('d-season').textContent = art.season;
            document.getElementById('d-host').textContent = art.host;
            document.getElementById('d-rating').textContent = art.rating;
            document.getElementById('d-desc').textContent = art.description;
            document.getElementById('d-content').innerHTML = art.content;
            document.getElementById('d-course').textContent = art.courseInfo;
            document.getElementById('d-price').textContent = art.price;
            
            const tagsContainer = document.getElementById('d-tags');
            art.tags.forEach(tag => {
                const btn = document.createElement('button');
                btn.className = 'tag cursor-pointer';
                btn.textContent = '#' + tag;
                btn.onclick = () => location.href = `index.html?tag=${encodeURIComponent(tag)}`;
                tagsContainer.appendChild(btn);
            });

            const reviewContainer = document.getElementById('d-reviews');
            if (art.reviews) {
                art.reviews.forEach(review => {
                    const div = document.createElement('div');
                    div.style.background = 'var(--gray-50)';
                    div.style.padding = '1rem';
                    div.style.borderRadius = 'var(--radius-xl)';
                    div.innerHTML = `
                        <div class="flex justify-between items-start" style="margin-bottom: 0.5rem;">
                            <div class="flex items-center gap-2">
                                <div style="width: 24px; height: 24px; background: var(--gray-200); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 10px; font-weight: bold; color: var(--gray-500);">${review.user[0]}</div>
                                <span class="text-sm font-bold">${review.user}</span>
                            </div>
                            <span class="text-xs text-gray-400">${review.date}</span>
                        </div>
                        <p class="text-sm text-gray-700">${review.text}</p>
                    `;
                    reviewContainer.appendChild(div);
                });
            }

            const likeBtn = document.getElementById('detail-like-btn');
            const heartIcon = likeBtn.querySelector('i');
            likeBtn.dataset.id = articleId;
            
            function updateLikeState() {
                const favorites = getFavorites();
                const heartIcon = likeBtn.querySelector('svg') || likeBtn.querySelector('i');
                if (!heartIcon) return;

                if (favorites.includes(articleId)) {
                    likeBtn.style.backgroundColor = 'var(--red-500)';
                    likeBtn.style.borderColor = 'var(--red-500)';
                    heartIcon.style.color = 'white';
                    heartIcon.setAttribute('fill', 'currentColor');
                } else {
                    likeBtn.style.backgroundColor = 'white';
                    likeBtn.style.borderColor = 'var(--gray-200)';
                    heartIcon.style.color = 'var(--gray-400)';
                    heartIcon.setAttribute('fill', 'none');
                }
            }

            likeBtn.onclick = () => {
                toggleFavorite(articleId);
                updateLikeState();
            };
            updateLikeState();
        }
    </script>

   <!-- Gemini AI Logic -->
<script type="module">
    import { GoogleGenerativeAI } from "https://esm.run/@google/generative-ai";

    const btnGenerate = document.getElementById('btn-generate-ai');
    const aiIntro = document.getElementById('ai-intro');
    const aiLoading = document.getElementById('ai-loading');
    const aiResult = document.getElementById('ai-result');
    const aiContentBox = document.getElementById('ai-content-box');
    const btnSave = document.getElementById('btn-save-itinerary');

    let generatedItineraryText = ""; 

    // API Key
    const API_KEY = 'AIzaSyCLsrnnckg3jl38RXhdt__zymmsLSjnxRM'; 

    if (btnGenerate) {
        btnGenerate.addEventListener('click', async () => {
            const article = window.currentArticle;
            if (!article) {
                alert('ì—¬í–‰ì§€ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.');
                return;
            }

            aiIntro.classList.add('hidden');
            aiLoading.classList.remove('hidden');
            
            try {
                const genAI = new GoogleGenerativeAI(API_KEY);
                // Updated to gemini-3-flash-preview as requested
                const model = genAI.getGenerativeModel({ model: "gemini-3-flash-preview" });

                const prompt = `
                    ì „ë¬¸ ì—¬í–‰ í”Œë˜ë„ˆë¡œì„œ ì—¬í–‰ ì¶”ì²œ ì‚¬ì´íŠ¸ì—ì„œ í™œìš©í•  ìˆ˜ ìˆëŠ” ê³ í€„ë¦¬í‹°ë¡œ ë‹¤ìŒ ì—¬í–‰ì§€ì— ëŒ€í•œ ìƒì„¸í•œ 3ì¼ ì—¬í–‰ ì½”ìŠ¤ë¥¼ ìì„¸í•˜ê²Œ ì§œì¤˜.
                    ì—¬í–‰ì§€: "${article.title}"
                    í…Œë§ˆ: ${article.tags.join(', ')}
                    ì„¤ëª…: ${article.description}
                    ì¶œë ¥ì€ ë°˜ë“œì‹œ HTML íƒœê·¸ë¥¼ ì‚¬ìš©í•´ì„œ ê¹”ë”í•˜ê²Œ í•´ì¤˜. (<h3>, <ul>, <li>, <strong>)
                    ë§ˆí¬ë‹¤ìš´ ê¸°í˜¸(\`\`\`html ë“±)ëŠ” ì“°ì§€ ë§ˆ. í•œêµ­ì–´ë¡œ ì‘ì„±í•´.
                `;

                const result = await model.generateContent(prompt);
                const response = await result.response;
                generatedItineraryText = response.text(); 

                aiLoading.classList.add('hidden');
                aiResult.classList.remove('hidden');
                aiContentBox.innerHTML = generatedItineraryText;

                if (window.lucide) window.lucide.createIcons();

            } catch (error) {
                console.error("AI ìƒì„± ì—ëŸ¬:", error);
                alert("ì½”ìŠ¤ ìƒì„± ì¤‘ ì—ëŸ¬ ë°œìƒ (Gemini API): " + error.message);
                aiLoading.classList.add('hidden');
                aiIntro.classList.remove('hidden');
            }
        });
    }

    // ë§ˆì´í˜ì´ì§€ ì €ì¥ ë° ì´ë™ ë¡œì§
    if (btnSave) {
        btnSave.addEventListener('click', () => {
            console.log("ì €ì¥ ë²„íŠ¼ í´ë¦­ë¨"); 
            
            const article = window.currentArticle;
            
            if (localStorage.getItem('isLoggedIn') !== 'true') {
                if(confirm('ë¡œê·¸ì¸ì´ í•„ìš”í•œ ê¸°ëŠ¥ì…ë‹ˆë‹¤. ë¡œê·¸ì¸í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                    location.href = 'login.html';
                }
                return;
            }
            
            let contentToSave = generatedItineraryText;
            if (!contentToSave || contentToSave.trim() === "") {
                if (aiContentBox && aiContentBox.innerHTML.trim() !== "") {
                    contentToSave = aiContentBox.innerHTML;
                }
            }

            if (!article || !contentToSave) {
                alert('ì €ì¥í•  ì½”ìŠ¤ ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € ì½”ìŠ¤ë¥¼ ìƒì„±í•´ ì£¼ì„¸ìš”.');
                return;
            }

            try {
                let saved = [];
                const rawData = localStorage.getItem('myItineraries');
                if (rawData) {
                    try {
                        saved = JSON.parse(rawData);
                    } catch (e) {
                        saved = [];
                    }
                }

                const newItinerary = {
                    id: Date.now().toString(),
                    articleId: article.id,
                    title: `${article.title} - AI ì¶”ì²œ ì½”ìŠ¤`,
                    content: contentToSave,
                    date: new Date().toLocaleDateString(),
                    image: article.imageUrl
                };

                saved.unshift(newItinerary);
                localStorage.setItem('myItineraries', JSON.stringify(saved));
                
                alert('ë§ˆì´í˜ì´ì§€ì— ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!');
                
                // 2ì¤‘ ì²´í¬: ì´ë™
                setTimeout(() => {
                    window.location.href = 'mypage.html';
                }, 100);

            } catch (err) {
                console.error("ì €ì¥ ì¤‘ ì—ëŸ¬ ë°œìƒ:", err);
                alert("ì €ì¥í•˜ëŠ” ë™ì•ˆ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: " + err.message);
            }
        });
    }
</script>
</body>
</html>
