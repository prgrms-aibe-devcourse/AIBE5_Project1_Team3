<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>로그인 - 여기저기</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Supabase 라이브러리 (필수) -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <!-- <link rel="stylesheet" href="../css/style.css" /> -->
    <script>
        tailwind.config = {
            theme: { extend: { colors: { primary: '#000', accent: '#FF385C' } } }
        }
    </script>
</head>
<body class="bg-gray-50 h-screen flex items-center justify-center p-6">

    <div class="w-full max-w-md bg-white rounded-3xl shadow-xl p-8 md:p-10 animate-fade-in relative">
        <a href="index.html" class="absolute top-6 right-6 text-gray-400 hover:text-black">
            <i data-lucide="x" width="24"></i>
        </a>
        <div class="text-center mb-10">
            <h1 class="text-3xl font-black mb-2 tracking-tight">여기저기</h1>
            <p class="text-gray-500">나만의 여행 큐레이션을 시작해보세요.</p>
        </div>

        <div class="space-y-4">
            <!-- type="button" 추가 (중요: 폼 제출 방지) -->
            <button type="button" id="btn-google" class="w-full py-3.5 px-4 rounded-xl border border-gray-200 flex items-center justify-center gap-3 hover:bg-gray-50 transition-colors relative">
                <img src="https://www.svgrepo.com/show/475656/google-color.svg" alt="Google" class="w-5 h-5" />
                <span class="font-bold text-gray-700">Google로 시작하기</span>
            </button>
            
            <div class="relative py-4">
                <div class="absolute inset-0 flex items-center"><div class="w-full border-t border-gray-100"></div></div>
                <div class="relative flex justify-center text-xs"><span class="px-2 bg-white text-gray-400">또는 이메일로 로그인</span></div>
            </div>

            <form id="form-login" class="space-y-4">
                <div><input id="input-email" type="email" placeholder="이메일 주소" class="w-full px-4 py-3 rounded-xl bg-gray-50 border-gray-100 border focus:border-black focus:bg-white focus:outline-none transition-colors text-sm" required></div>
                <div><input id="input-password" type="password" placeholder="비밀번호" class="w-full px-4 py-3 rounded-xl bg-gray-50 border-gray-100 border focus:border-black focus:bg-white focus:outline-none transition-colors text-sm" required></div>
                <button type="submit" id="btn-submit" class="w-full py-3.5 bg-black text-white rounded-xl font-bold hover:bg-gray-800 transition-colors shadow-lg shadow-gray-200 disabled:bg-gray-400">로그인</button>
            </form>
        </div>
        <div class="mt-8 text-center text-xs text-gray-400">
            <a href="#" class="underline hover:text-black">회원가입</a>
        </div>
    </div>

    <!-- script.js가 있으면 로드하되, 없어도 작동하게 분리 -->
    <script src="script.js"></script>
    
    <!-- 기존 <script src="script.js"></script>가 있다면 지우거나 주석 처리해주세요 -->
    <!-- <script src="script.js"></script> -->
    
    <script>
        // 아이콘 생성
        if(window.lucide) lucide.createIcons();

        // ------------------------------------------------------------------
        // [진단 1] Supabase 라이브러리 로드 확인
        // ------------------------------------------------------------------
        btnSwitchMode.addEventListener('click', (e) => {
            e.preventDefault();
            isSignUpMode = !isSignUpMode;

            if (isSignUpMode) {
                authDesc.textContent = "새로운 계정을 만들어보세요.";
                dividerText.textContent = "또는 이메일로 회원가입";
                btnSubmit.textContent = "회원가입 시작하기";
                confirmGroup.classList.remove('hidden'); // 비밀번호 확인 칸 보이기
                confirmInput.required = true;
                switchLabel.textContent = "이미 계정이 있으신가요?";
                btnSwitchMode.textContent = "로그인으로 돌아가기";
            } else {
                authDesc.textContent = "나만의 여행 큐레이션을 시작해보세요.";
                dividerText.textContent = "또는 이메일로 로그인";
                btnSubmit.textContent = "로그인";
                confirmGroup.classList.add('hidden'); // 비밀번호 확인 칸 숨기기
                confirmInput.required = false;
                switchLabel.textContent = "계정이 없으신가요?";
                btnSwitchMode.textContent = "회원가입";
            }
        });

        // ------------------------------------------------------------------
        // [추가] 이메일 로그인 & 회원가입 통합 처리
        // ------------------------------------------------------------------
        authForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('input-email').value;
            const password = document.getElementById('input-password').value;

            btnSubmit.disabled = true;
            btnSubmit.textContent = isSignUpMode ? "처리 중..." : "로그인 중...";

            if (isSignUpMode) {
                // 회원가입 로직
                const confirmPw = confirmInput.value;
                if (password !== confirmPw) {
                    alert("비밀번호가 일치하지 않습니다.");
                    btnSubmit.disabled = false;
                    btnSubmit.textContent = "회원가입 시작하기";
                    return;
                }

                const { data, error } = await supabaseClient.auth.signUp({ email, password });
                if (error) {
                    alert("가입 실패: " + error.message);
                } else {
                    alert("가입 성공! 메일함에서 인증 버튼을 눌러주세요.");
                }
            } else {
                // 로그인 로직
                const { data, error } = await supabaseClient.auth.signInWithPassword({ email, password });
                if (error) {
                    alert("로그인 실패: " + error.message);
                } else {
                    alert("로그인 성공!");
                    location.href = 'index.html';
                }
            }
            btnSubmit.disabled = false;
            btnSubmit.textContent = isSignUpMode ? "회원가입 시작하기" : "로그인";
        });

        supabaseClient.auth.onAuthStateChange((event, session) => {
            // 1. 이메일 링크를 통해 인증(INITIAL_SESSION)되었거나 SIGNED_IN 되었을 때
            // 2. 하지만 사용자가 '로그인 폼'을 통해 직접 버튼을 눌러 로그인하는 중이 아닐 때만 반응하게 합니다.
            
            // 이메일 링크 클릭 시 보통 event가 'SIGNED_IN' 또는 'USER_UPDATED'로 들어옵니다.
            if (event === 'SIGNED_IN') {
                // 현재 URL에 'access_token'이 포함되어 있다면 이메일 링크를 타고 온 것으로 간주할 수 있습니다.
                const isEmailConfirmation = window.location.hash.includes('access_token');
                
                if (isEmailConfirmation) {
                    alert("이메일 인증이 완료되었습니다! 메인 페이지로 이동합니다.");
                    location.href = 'index.html';
                }
                // 직접 로그인(signInWithPassword)의 경우, 
                // 폼 제출 핸들러 내의 location.href = 'index.html'이 처리하므로 여기서 중복 처리할 필요가 없습니다.
            }
        });

      // --- 소셜 로그인 함수 (개선 버전) ---
    async function handleSocialLogin(provider) {
        try {
            // 1. 현재 접속한 환경의 프로토콜+도메인+포트번호를 자동으로 가져옵니다.
            // (예: 로컬은 http://127.0.0.1:5500, 배포 후엔 https://prgrms-aibe-devcourse.github.io)
            const currentOrigin = window.location.origin;

            // 2. 레포지토리 이름을 포함한 공통 경로 설정
            // GitHub Pages 배포 환경인지 로컬 환경인지 체크하여 경로를 맞춥니다.
            const redirectPath = window.location.hostname.includes('github.io')
                ? '/AIBE5_Project1_Team3/t3Project/html/index.html' // 배포 환경
                : '/t3Project/html/index.html';                     // 로컬 환경

            const { data, error } = await supabaseClient.auth.signInWithOAuth({
                provider: provider,
                options: {
                    // 두 값을 합쳐서 리다이렉트 주소 생성
                    redirectTo: currentOrigin + redirectPath,
                }
            });

            if (error) throw error;
        } catch (error) {
            console.error(error);
            alert("소셜 로그인 에러: " + error.message);
        }
    }
        if(btnGoogle) btnGoogle.addEventListener('click', () => handleSocialLogin('google'));
    </script>
</body>
</html>