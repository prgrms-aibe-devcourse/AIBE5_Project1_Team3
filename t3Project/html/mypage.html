<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì—¬ê¸°ì €ê¸° : ë§ˆì´í˜ì´ì§€</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="../css/global.css">
    <link rel="stylesheet" href="../css/mypage.css">
    <link rel="stylesheet" href="../css/auth.css">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#000',
                        accent: '#FF385C',
                        ai: '#8B5CF6',
                    }
                }
            }
        }
    </script>
     <style>
        .tab-indicator { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .tab-content { display: none; animation: fadeIn 0.4s ease-out; }
        .tab-content.active { display: block; }
        .trip-card { transition: transform 0.2s; }
        .trip-card:active { transform: scale(0.98); }
        
        /* Toggle Switch UI (Settings modal deleted, but kept style just in case) */
        .toggle-label {
            width: 3rem;
            height: 1.5rem;
            background-color: #e5e7eb;
            border-radius: 9999px;
            position: relative;
            cursor: pointer;
            transition: background-color 0.3s ease-in-out;
        }
        .toggle-checkbox { display: none; }
        .toggle-circle {
            position: absolute; top: 2px; left: 2px;
            width: 1.25rem; height: 1.25rem;
            background-color: white; border-radius: 50%;
            transition: transform 0.3s ease-in-out;
            box-shadow: 0 1px 3px rgba(0,0,0,0.3);
        }
        .toggle-checkbox:checked + .toggle-label { background-color: #000; }
        .toggle-checkbox:checked + .toggle-label .toggle-circle { transform: translateX(1.5rem); }
        
        /* Star Rating */
        .star-btn i { transition: all 0.2s; }
        .star-btn.active i { fill: #FACC15; color: #FACC15; }
        
        /* Checkbox */
        .custom-checkbox:checked {
            background-color: #FF385C; border-color: #FF385C;
            background-image: url("data:image/svg+xml,%3csvg viewBox='0 0 16 16' fill='white' xmlns='http://www.w3.org/2000/svg'%3e%3cpath d='M12.207 4.793a1 1 0 010 1.414l-5 5a1 1 0 01-1.414 0l-2-2a1 1 0 011.414-1.414L6.5 9.086l4.293-4.293a1 1 0 011.414 0z'/%3e%3c/svg%3e");
        }

        /* Modal Scroll */
        .modal-scroll::-webkit-scrollbar { width: 6px; }
        .modal-scroll::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 4px; }
        .modal-scroll::-webkit-scrollbar-thumb { background: #d1d5db; border-radius: 4px; }
        .modal-scroll::-webkit-scrollbar-thumb:hover { background: #9ca3af; }

        /* Drag & Drop */
        .draggable-item { cursor: grab; transition: all 0.2s; user-select: none; }
        .draggable-item:active { cursor: grabbing; }
        .draggable-item.dragging { opacity: 0.5; background-color: #f3f4f6; border: 2px dashed #ccc; }
        .drag-handle { cursor: grab; color: #9ca3af; padding: 4px; }
        .drag-handle:hover { color: #374151; background-color: #f3f4f6; border-radius: 4px; }
 
        /* [New] ì‹¤ì œ ì²´í¬ë°•ìŠ¤ëŠ” ìˆ¨ê¹€ */
        .saved-item-checkbox {
            display: none !important;
        }

        /* [Modified] ì¹´ë“œ ì„ íƒ ì‹œ ìŠ¤íƒ€ì¼ (ê¹”ë”í•œ ë¸”ë™/ì˜¤ë²„ë ˆì´) */
        .card-selected {
            position: relative;
            transform: scale(0.98); /* ì‚´ì§ ëˆŒë¦° ë“¯í•œ íš¨ê³¼ */
            transition: all 0.2s ease;
        }
        
        /* [New] ì„ íƒ ì‹œ ì–´ë‘ìš´ ë§‰(Overlay) ì”Œìš°ê¸° */
        .card-selected::before {
            content: '';
            position: absolute;
            inset: 0;
            background-color: rgba(0, 0, 0, 0.4); /* 40% ê²€ì • íˆ¬ëª…ë„ */
            z-index: 10;
        }
        
        /* [Modified] ì¤‘ì•™ ì²´í¬ ì•„ì´ì½˜ */
        .card-selected::after {
            content: 'âœ”';
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            font-size: 2.5rem;
            color: white;
            z-index: 20;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.5)); /* ê·¸ë¦¼ìë¡œ ê°€ì‹œì„± í™•ë³´ */
        }
    </style>
</head>
<body class="bg-gray-50 pb-24">

    <div class="sticky top-0 left-0 w-full bg-white/90 backdrop-blur-md z-40 border-b border-gray-100 px-4 h-14 flex items-center justify-between">
        <div class="flex items-center gap-3">
            <a href="index.html" class="text-gray-800 hover:text-black transition-colors">
                <i data-lucide="chevron-left" width="24"></i>
            </a>
            <h1 class="font-bold text-lg text-gray-900">ë§ˆì´í˜ì´ì§€</h1>
        </div>
        <button onclick="handleLogout()" class="text-gray-500 hover:text-red-500 transition-colors" aria-label="ë¡œê·¸ì•„ì›ƒ">
            <i data-lucide="log-out" width="20"></i>
        </button>
    </div>

    <div class="bg-white px-6 py-8 mb-2">
        <div class="flex items-center gap-4">
            <div class="relative group">
                <div class="w-20 h-20 rounded-full p-[2px] bg-gradient-to-tr from-blue-400 via-blue-500 to-blue-600">
                    <img id="profile-img" src="" class="w-full h-full rounded-full border-2 border-white bg-gray-100 object-cover" alt="Profile">
                </div>
                </div>
            <div class="flex-1">
                <h2 id="profile-name" class="text-xl font-black text-gray-900 leading-tight mb-1"></h2>
                <p id="profile-email" class="text-xs text-gray-400 mb-2"></p>
                <p id="profile-bio" class="text-sm text-gray-600 mb-3 line-clamp-1"></p>
                <button onclick="openProfileModal()" class="px-3 py-1.5 border border-gray-200 rounded-lg text-xs font-bold text-gray-600 hover:bg-gray-50 hover:border-black transition-all">
                    í”„ë¡œí•„ í¸ì§‘
                </button>
            </div>
        </div>
        
        <div class="flex justify-between mt-8 px-2">
            <div class="text-center w-1/3 cursor-pointer border-r border-gray-100" onclick="switchTab('saved')">
                <p class="text-xs text-gray-400 font-medium mb-1">ì°œí•œ ì—¬í–‰</p>
                <p class="text-lg font-black text-[#2563EB]" id="stat-likes">0</p>
            </div>
            <div class="text-center w-1/3 border-r border-gray-100" onclick="switchTab('trips')">
                <p class="text-xs text-gray-400 font-medium mb-1">ë‹¤ë…€ì˜¨ ì—¬í–‰</p>
                <p class="text-lg font-black text-gray-900" id="stat-trips">0</p>
            </div>
            <div class="text-center w-1/3 cursor-pointer" onclick="switchTab('reviews')">
                <p class="text-xs text-gray-400 font-medium mb-1">ë‚˜ì˜ í›„ê¸°</p>
                <p class="text-lg font-black text-gray-900" id="stat-reviews">0</p>
            </div>
        </div>
    </div>

    <div class="sticky top-14 bg-white z-30 border-b border-gray-100">
        <div class="flex relative">
            <button onclick="switchTab('saved')" class="tab-btn w-1/3 py-3 text-sm font-bold text-gray-400 transition-colors data-[active=true]:text-black" data-tab="saved">
                ì°œí•œ ëª©ë¡
            </button>
            <button onclick="switchTab('trips')" class="tab-btn w-1/3 py-3 text-sm font-bold text-gray-400 transition-colors data-[active=true]:text-black" data-tab="trips">
                ë‚˜ì˜ ì—¬í–‰
            </button>
            <button onclick="switchTab('reviews')" class="tab-btn w-1/3 py-3 text-sm font-bold text-gray-400 transition-colors data-[active=true]:text-black" data-tab="reviews">
                ë‚˜ì˜ í›„ê¸°
            </button>
            <div id="tab-line" class="absolute bottom-0 h-[2px] bg-black transition-all duration-300 w-1/3 left-0"></div>
        </div>
    </div>

    <div class="max-w-3xl mx-auto px-4 py-6 min-h-[50vh]">

        <!-- Tab 1: Saved -->
        <div id="tab-saved" class="tab-content active">
            <div class="flex justify-between items-center mb-4 bg-gray-50/90 backdrop-blur p-3 rounded-xl border border-gray-100 shadow-sm">

                <p class="text-xs text-gray-500 pl-1" id="selection-guide-text">ë§ˆìŒì— ë“œëŠ” ì—¬í–‰ì§€ë¡œ ì¼ì •ì„ ë§Œë“¤ì–´ë³´ì„¸ìš”.</p>
                
                <div class="flex gap-2">
                    <!-- 1. ê¸°ë³¸ ìƒíƒœ ë²„íŠ¼ -->
                    <button id="btn-start-selection" onclick="toggleSelectionMode(true)" class="bg-[#2563EB] text-white px-4 py-2 rounded-full text-xs font-bold shadow-md hover:shadow-lg hover:brightness-95 transition flex items-center gap-1">
                        <i data-lucide="calendar-plus" width="14"></i>
                        ì¼ì • ë§Œë“¤ê¸°
                    </button>

                    <!-- 2. ì„ íƒ ëª¨ë“œ ë²„íŠ¼ë“¤ (ì²˜ìŒì—” ìˆ¨ê¹€) -->
                    <div id="selection-actions" class="hidden flex gap-2">
                        <button onclick="toggleSelectionMode(false)" class="bg-gray-200 text-gray-600 px-4 py-2 rounded-full text-xs font-bold hover:bg-gray-300 transition-colors">
                            ì·¨ì†Œ
                        </button>
                        <button onclick="generateTripFromSelection()" class="bg-[#62B6FF] text-white px-4 py-2 rounded-full text-xs font-bold shadow-md hover:bg-[#4FA8F0] transition-colors flex items-center gap-1">
                            <i data-lucide="check" width="14"></i>
                            ì„ íƒ ì™„ë£Œ
                        </button>
                    </div>
                </div>
            </div>
            
            <div id="saved-grid" class="grid grid-cols-1 sm:grid-cols-2 gap-4"></div>
            
            <div id="saved-empty" class="hidden flex-col items-center justify-center py-20 text-gray-400">
                <i data-lucide="heart-off" width="48" class="mb-4 text-gray-200"></i>
                <p>ì•„ì§ ì°œí•œ ì—¬í–‰ì§€ê°€ ì—†ì–´ìš”.</p>
                <a href="index.html" class="mt-4 text-accent text-sm font-bold underline">ì—¬í–‰ì§€ ë‘˜ëŸ¬ë³´ê¸°</a>
            </div>
        </div>

        <div id="tab-trips" class="tab-content space-y-6">
            <div class="flex justify-between items-end mb-4 border-b border-gray-100 pb-2">
                <h3 class="font-bold text-lg flex items-center gap-2">
                    ë‹¤ê°€ì˜¤ëŠ” ì—¬í–‰ <span class="text-[#2563EB]accent text-sm" id="upcoming-count">0</span>
                </h3>
                <button onclick="openManualCreateModal()" class="flex items-center gap-1 px-3 py-1.5 bg-[#2563EB] text-white rounded-full text-xs font-bold hover:bg-[#1D4ED8] transition-colors shadow-lg shadow-gray-200">
                    <i data-lucide="plus" width="14"></i> ì„ì˜ ì‘ì„±
                </button>
            </div>
            <div id="upcoming-list" class="space-y-4"></div>
            <div class="pt-6">
                <h3 class="font-bold text-gray-400 text-sm mb-4">ì§€ë‚œ ì—¬í–‰</h3>
                <div id="past-list" class="space-y-4 opacity-90"></div>
            </div>
        </div>

        <div id="tab-reviews" class="tab-content">
             <div class="bg-blue-50 p-4 rounded-xl mb-6 flex items-center gap-3">
                <i data-lucide="info" class="text-blue-500" width="16"></i>
                <p class="text-xs text-blue-800 leading-relaxed">
                    ë³„ì ê³¼ í•¨ê»˜ ìƒìƒí•œ í›„ê¸°ë¥¼ ë‚¨ê²¨ì£¼ì„¸ìš”.
                </p>
            </div>
            <div id="review-list" class="space-y-4"></div>
             <div id="review-empty" class="hidden text-center py-20 text-gray-400">ì‘ì„±í•œ í›„ê¸°ê°€ ì—†ìŠµë‹ˆë‹¤.</div>
        </div>
    </div>

    <div id="profile-modal" class="fixed inset-0 z-50 hidden flex items-center justify-center px-4">
        <div class="absolute inset-0 bg-black/60 backdrop-blur-sm transition-opacity"></div>
        <div class="bg-white w-full max-w-md rounded-3xl p-6 z-10 relative animate-slide-up max-h-[85vh] overflow-y-auto modal-scroll">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-black">í”„ë¡œí•„ í¸ì§‘</h3>
                <button onclick="closeProfileModal()" class="p-2 hover:bg-gray-100 rounded-full"><i data-lucide="x" width="20"></i></button>
            </div>
            <div class="flex flex-col items-center mb-6">
                <div class="relative w-24 h-24 mb-3">
                    <img id="edit-profile-img" src="" class="w-full h-full rounded-full bg-gray-100 object-cover border border-gray-200">
                </div>
            </div>
            <form onsubmit="saveProfile(event)" class="space-y-4">
                <div><label class="block text-xs font-bold text-gray-500 mb-1">ë‹‰ë„¤ì„</label><input type="text" id="edit-name" class="w-full p-3 bg-gray-50 rounded-xl border border-gray-200 focus:border-black focus:outline-none font-bold" required></div>
                <div><label class="block text-xs font-bold text-gray-500 mb-1">í•œì¤„ ì†Œê°œ</label><input type="text" id="edit-bio" class="w-full p-3 bg-gray-50 rounded-xl border border-gray-200 focus:border-black focus:outline-none" placeholder="í”„ë¡œí•„ì„ í¸ì§‘í•´ë³´ì„¸ìš”."></div>
                <div><label class="block text-xs font-bold text-gray-500 mb-1">ì´ë©”ì¼</label><input type="email" id="edit-email" class="w-full p-3 bg-gray-100 rounded-xl border border-transparent text-gray-400 cursor-not-allowed" readonly></div>
                <button type="submit" class="w-full bg-black text-white py-4 rounded-xl font-bold text-lg hover:bg-gray-800 mt-2">ì €ì¥í•˜ê¸°</button>
            </form>
        </div>
    </div>

    <div id="detail-modal" class="fixed inset-0 z-50 hidden flex items-center justify-center px-4">
        <div class="absolute inset-0 bg-black/60 backdrop-blur-sm"></div>
        <div class="bg-white w-full max-w-5xl rounded-3xl p-6 md:p-8 z-10 relative animate-fade-in h-[90vh] flex flex-col">
             <div class="flex justify-between items-center mb-6 flex-shrink-0">
                <div class="flex items-center gap-3">
                    <h3 class="text-2xl font-black text-gray-900 leading-tight" id="view-title"></h3>
                    <span id="view-badge" class="px-2 py-1 bg-gray-100 rounded text-[10px] font-bold text-gray-500"></span>
                </div>
                <button onclick="closeDetailModal()" class="p-2 bg-gray-100 hover:bg-gray-200 rounded-full"><i data-lucide="x" width="24"></i></button>
             </div>
             
             <div class="flex flex-col md:flex-row gap-8 h-full overflow-hidden">
                 <div class="flex-1 space-y-6 overflow-y-auto pr-2 modal-scroll">
                     
                     <div class="flex items-center gap-3 text-gray-700 bg-gray-50 p-4 rounded-2xl border border-gray-100">
                         <i data-lucide="calendar" width="20"></i>
                         <span id="view-date" class="font-bold text-base"></span>
                     </div>
                     
                     <div id="view-places-container" class="hidden h-full flex flex-col">
                        <label class="block text-sm font-bold text-gray-600 mb-2 flex items-center gap-2">
                            <i data-lucide="map-pin" width="16"></i> í¬í•¨ëœ ì—¬í–‰ì§€
                        </label>
                        <div id="view-places-list" class="space-y-3 bg-gray-50 p-4 rounded-xl border border-gray-100 flex-1 overflow-y-auto modal-scroll">
                            </div>
                     </div>
                 </div>

                 <div class="flex-1 flex flex-col h-full min-h-[300px]">
                     <label class="block text-xs font-bold text-gray-500 mb-2">ìƒì„¸ ì¼ì • ë° ë©”ëª¨</label>
                     <div id="view-memo" class="flex-1 bg-gray-50 p-5 rounded-2xl border border-gray-200 text-sm leading-7 text-gray-700 whitespace-pre-wrap overflow-y-auto modal-scroll shadow-inner"></div>
                 </div>
             </div>
             
             <div class="mt-6 pt-4 border-t border-gray-100 flex-shrink-0 text-right">
                 <button onclick="closeDetailModal()" class="px-8 py-3 bg-bg-[#2563EB] text-white rounded-xl font-bold hover:bg-gray-800 transition-colors">ë‹«ê¸°</button>
             </div>
        </div>
    </div>

    <div id="create-modal" class="fixed inset-0 z-50 hidden flex items-center justify-center px-4">
        <div class="absolute inset-0 bg-black/60 backdrop-blur-sm transition-opacity"></div>
        <div class="bg-white w-full max-w-5xl rounded-3xl p-6 md:p-8 z-10 relative animate-slide-up h-[90vh] flex flex-col">
            
            <div class="flex justify-between items-center mb-6 flex-shrink-0">
                <h3 class="text-2xl font-black text-gray-900" id="create-modal-title">ìƒˆ ì¼ì • ë§Œë“¤ê¸°</h3>
                <button type="button" onclick="closeCreateModal()" class="p-2 hover:bg-gray-100 rounded-full transition-colors"><i data-lucide="x" width="24"></i></button>
            </div>
            
            <form onsubmit="handleCreateOrUpdateTrip(event)" class="flex-1 overflow-hidden flex flex-col">
                <input type="hidden" id="edit-trip-id">
                
                <div class="flex flex-col md:flex-row gap-8 h-full overflow-y-auto md:overflow-hidden">
                    
                    <div class="flex-1 flex flex-col gap-5 overflow-y-auto pr-2 modal-scroll h-full">
                        
                        <div>
                            <label class="block text-xs font-bold text-gray-500 mb-1">ì—¬í–‰ ì´ë¦„</label>
                            <input type="text" id="trip-title" class="w-full p-3.5 bg-gray-50 rounded-xl border border-gray-200 focus:border-black focus:bg-white focus:outline-none font-bold transition-colors" placeholder="ì˜ˆ: ì‚¿í¬ë¡œ ì‹ë„ë½ ì—¬í–‰" required>
                        </div>
                        
                        <div class="flex gap-4">
                            <div class="flex-1">
                                <label class="block text-xs font-bold text-gray-500 mb-1">ì‹œì‘ì¼</label>
                                <input type="date" id="trip-start" class="w-full p-3.5 bg-gray-50 rounded-xl border border-gray-200 focus:border-black focus:bg-white focus:outline-none text-sm transition-colors" required>
                            </div>
                            <div class="flex-1">
                                <label class="block text-xs font-bold text-gray-500 mb-1">ì¢…ë£Œì¼</label>
                                <input type="date" id="trip-end" class="w-full p-3.5 bg-gray-50 rounded-xl border border-gray-200 focus:border-black focus:bg-white focus:outline-none text-sm transition-colors" required>
                            </div>
                        </div>

                        <div id="selected-places-container" class="hidden bg-gray-50 p-4 rounded-xl border border-gray-200 flex-1 flex flex-col min-h-[300px]">
                            <label class="block text-sm font-bold text-gray-800 mb-3 flex items-center justify-between">
                                <span class="flex items-center gap-1"><i data-lucide="list" width="16"></i> ì„ íƒëœ ì°œ ëª©ë¡ (ë“œë˜ê·¸ë¡œ ìˆœì„œ ë³€ê²½)</span>
                                <span class="text-[10px] text-gray-400 font-normal">ìœ„ì•„ë˜ë¡œ ë“œë˜ê·¸í•˜ì—¬ ìˆœì„œë¥¼ ë°”ê¿”ë³´ì„¸ìš”</span>
                            </label>
                            <div id="selected-places-list" class="space-y-2 flex-1 overflow-y-auto modal-scroll pr-1 border-t border-gray-200 pt-3">
                                </div>
                        </div>

                    </div>

                    <div class="flex-1 flex flex-col h-full min-h-[300px]">
                        <label class="block text-xs font-bold text-gray-500 mb-2 flex justify-between">
                            <span>ìƒì„¸ ì¼ì • ë° ë©”ëª¨</span>
                        </label>
                        <textarea id="trip-memo" class="flex-1 w-full p-5 bg-gray-50 rounded-2xl border border-gray-200 focus:border-black focus:bg-white focus:outline-none resize-none text-sm leading-7 shadow-inner transition-colors modal-scroll" placeholder="ì—¬ê¸°ì— ìƒì„¸ ì¼ì •ì´ í‘œì‹œë©ë‹ˆë‹¤."></textarea>
                    </div>
                </div>

                <div class="mt-6 pt-4 border-t border-gray-100 flex-shrink-0">
                    <button type="submit" id="btn-save-trip" class="w-full bg-[#2563EB] text-white py-4 rounded-xl font-bold text-lg hover:bg-[#1D4ED8] transition-all shadow-lg active:scale-[0.99]">
                        ì¼ì • ì €ì¥í•˜ê¸°
                    </button>
                </div>
            </form>
        </div>
    </div>
    <!-- Trip Places Review List Modal -->
    <div id="review-list-modal" class="fixed inset-0 z-50 hidden flex items-center justify-center px-4">
    <div class="absolute inset-0 bg-black/60 backdrop-blur-sm"></div>

    <div class="bg-white w-full max-w-lg rounded-3xl p-6 md:p-8 z-10 relative animate-slide-up h-[80vh] flex flex-col">
        
        <!-- í—¤ë” -->
        <div class="flex justify-between items-center mb-2 flex-shrink-0">
        <h3 class="text-xl font-black text-gray-900">í›„ê¸° ì‘ì„±í•  ì¥ì†Œ ì„ íƒ</h3>
        <button onclick="closeReviewListModal()" class="p-2 hover:bg-gray-100 rounded-full transition-colors">
            <i data-lucide="x" width="24"></i>
        </button>
        </div>

        <p class="text-xs text-gray-500 mb-6 flex-shrink-0">
        ë‹¤ë…€ì˜¨ ì—¬í–‰ì§€ì˜ ì¶”ì–µì„ ê°ê° ë‚¨ê²¨ë³´ì„¸ìš”.
        </p>

        <!-- ì¥ì†Œ ë¦¬ìŠ¤íŠ¸ -->
        <div id="review-places-list" class="flex-1 overflow-y-auto modal-scroll space-y-3 pr-2">
        <!-- JSë¡œ ì£¼ì… -->
        </div>

        <!-- âœ… ì™„ë£Œ ë²„íŠ¼ ì˜ì—­ (ì´ê²Œ ë¹ ì§€ë©´ ì•ˆ ë¨) -->
        <div class="pt-4 border-t border-gray-100 flex-shrink-0">
        <button
            id="btn-review-complete"
            type="button"
            onclick="completeAllReviewsAndClose()"
            class="w-full py-3 rounded-xl font-bold transition-colors bg-gray-200 text-gray-400 cursor-not-allowed"
            disabled
        >
            ëª¨ë“  ì¥ì†Œ í›„ê¸° ì‘ì„± ì™„ë£Œ
        </button>
        <p id="review-complete-hint" class="text-[11px] text-gray-400 mt-2 text-center">
            ëª¨ë“  ì¥ì†Œì˜ í›„ê¸°ë¥¼ ì‘ì„±í•˜ë©´ í™œì„±í™”ë©ë‹ˆë‹¤.
        </p>
        </div>
    </div>
    </div>

    <!-- Review Write/Edit Modal (Fixed) -->
    <div id="review-modal" class="fixed inset-0 z-50 hidden flex items-center justify-center px-4">
        <div class="absolute inset-0 bg-black/60 backdrop-blur-sm"></div>
        <div class="bg-white w-full max-w-md rounded-2xl p-6 z-10 relative animate-fade-in">
             <div class="flex justify-between items-center mb-4">
                 <h3 class="text-lg font-bold" id="review-modal-title">í›„ê¸° ì‘ì„±</h3>
                 <button onclick="closeReviewModal()" class="text-gray-400 hover:text-black"><i data-lucide="x" width="20"></i></button>
             </div>
             
             <!-- [Change] ì„ íƒëœ ì¥ì†Œ í‘œì‹œ (ìˆ˜ì • ë¶ˆê°€) -->
             <div class="mb-4">
                 <label class="block text-xs text-gray-400 font-bold mb-1">ì‘ì„± ì¤‘ì¸ ì¥ì†Œ</label>
                 <div class="relative">
                    <input type="text" id="review-target-display" class="w-full p-3 bg-gray-100 border border-transparent rounded-xl text-sm font-bold text-gray-600 focus:outline-none" readonly>
                    <div class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400">
                        <i data-lucide="lock" width="14"></i>
                    </div>
                 </div>
             </div>

             <!-- ë³„ì  -->
             <div class="flex flex-col items-center mb-4 bg-gray-50 p-3 rounded-xl border border-gray-100">
                 <p class="text-xs text-gray-400 font-bold mb-2">ë³„ì ì„ ì„ íƒí•´ì£¼ì„¸ìš”</p>
                 <div class="flex gap-2" id="star-container">
                     <button type="button" onclick="setRating(1)" class="star-btn active text-gray-300"><i data-lucide="star" width="32" fill="currentColor"></i></button>
                     <button type="button" onclick="setRating(2)" class="star-btn active text-gray-300"><i data-lucide="star" width="32" fill="currentColor"></i></button>
                     <button type="button" onclick="setRating(3)" class="star-btn active text-gray-300"><i data-lucide="star" width="32" fill="currentColor"></i></button>
                     <button type="button" onclick="setRating(4)" class="star-btn active text-gray-300"><i data-lucide="star" width="32" fill="currentColor"></i></button>
                     <button type="button" onclick="setRating(5)" class="star-btn active text-gray-300"><i data-lucide="star" width="32" fill="currentColor"></i></button>
                 </div>
                 <p id="rating-text" class="text-xs font-bold text-accent mt-2">5ì  - ìµœê³ ì˜€ì–´ìš”!</p>
             </div>

             <!-- [New] ì‚¬ì§„/ë™ì˜ìƒ ì—…ë¡œë“œ UI -->
             <div class="mb-4">
                <label class="block text-xs text-gray-400 font-bold mb-2">ì‚¬ì§„ ë° ë™ì˜ìƒ ì²¨ë¶€</label>
                <div class="flex items-center gap-2">
                    <label for="review-file-input" class="cursor-pointer flex items-center justify-center w-16 h-16 bg-gray-50 border border-dashed border-gray-300 rounded-xl hover:bg-gray-100 transition-colors">
                        <i data-lucide="camera" width="20" class="text-gray-400"></i>
                    </label>
                    <!-- accept ì†ì„±ìœ¼ë¡œ ì´ë¯¸ì§€/ë¹„ë””ì˜¤ë§Œ í—ˆìš© -->
                    <input type="file" id="review-file-input" class="hidden" accept="image/*,video/*" multiple onchange="handleFileSelect(event)">
                    
                    <!-- ë¯¸ë¦¬ë³´ê¸° ì˜ì—­ -->
                    <div id="file-preview-container" class="flex gap-2 overflow-x-auto h-16 items-center no-scrollbar"></div>
                </div>
                <p class="text-[10px] text-gray-400 mt-1">* ìµœëŒ€ 5ê°œê¹Œì§€ ì—…ë¡œë“œ ê°€ëŠ¥</p>
             </div>
             <!-- ê¸°ì¡´ ì—…ë¡œë“œ ë¯¸ë””ì–´ ëª©ë¡(ìˆ˜ì • ì‹œ í‘œì‹œ) -->
            <div id="existing-media-section" class="mb-4 hidden">
                <label class="block text-xs text-gray-400 font-bold mb-2">ê¸°ì¡´ ì²¨ë¶€íŒŒì¼</label>
                <div id="existing-media-container" class="flex gap-2 overflow-x-auto pb-2 no-scrollbar"></div>
                <p class="text-[10px] text-gray-400 mt-1">ì‚­ì œ(X)í•œ í•­ëª©ì€ ì €ì¥ ì‹œ ë°˜ì˜ë©ë‹ˆë‹¤.</p>
            </div>
             <textarea id="review-text" class="w-full h-32 p-3 bg-gray-50 rounded-xl resize-none focus:outline-none mb-4 border border-gray-200" placeholder="ì—¬í–‰ì˜ ìƒìƒí•œ í›„ê¸°ë¥¼ ë‚¨ê²¨ì£¼ì„¸ìš”."></textarea>
             <button onclick="submitReview()" id="btn-save-review" class="w-full bg-[#2563EB] text-white py-3 rounded-xl font-bold">ì‘ì„± ì™„ë£Œ</button>
        </div>
    </div>

    <button onclick="resetAllData()" class="fixed bottom-4 right-4 bg-[#2563EB] text-white px-4 py-2 rounded-full text-xs font-bold
shadow-md hover:shadow-lg hover:brightness-95 transition
flex items-center gap-1">
        ë°ì´í„° ì´ˆê¸°í™”
    </button>

    <script src="../js/script.js"></script>
    <script src="../js/data.js"></script>
    <script>
        // [New] íŒŒì¼ ì—…ë¡œë“œìš© ì „ì—­ ë³€ìˆ˜
        let selectedFiles = [];
        let existingMedia = []; // ìˆ˜ì • ëª¨ë“œì—ì„œ ë‚¨ê¸¸ ê¸°ì¡´ ë¯¸ë””ì–´ ëª©ë¡
        
        // --- 0. Global Variables ---
        var currentSelectedPlaces = (typeof currentSelectedPlaces !== 'undefined') ? currentSelectedPlaces : [];

        // --- 1. Data Reset Logic ---
        function resetAllData() {
            showConfirmModal(
                'ë°ì´í„° ì´ˆê¸°í™”',
                'ëª¨ë“  ì°œí•œ ëª©ë¡ê³¼ ì—¬í–‰ ì¼ì •ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n(ë°ì´í„° ë²„ì „ ë¶ˆì¼ì¹˜ í•´ê²°ìš©)',
                () => {
                localStorage.removeItem('myTrips');
                localStorage.removeItem('myReviews');
                localStorage.removeItem('favorites');

                showAuthModal('ì´ˆê¸°í™” ì™„ë£Œ', 'ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì°œí•˜ê¸°ë¥¼ ì‹œë„í•´ì£¼ì„¸ìš”.', 'âœ…');
                location.reload();
                },
                'âš ï¸'
            );
            }

        // --- 2. Settings & Profile Logic ---
        let currentAvatarSeed = 'Felix';
        const defaultProfile = { name: 'ì—¬í–‰í•˜ëŠ” ê¹€ì² ìˆ˜', email: 'traveler_kim@example.com', bio: 'ì—¬í–‰ì€ ë‚˜ë¥¼ ì°¾ëŠ” ì—¬ì •', avatarSeed: 'Felix' };

        function getProfileKey(userId) {
        return `userProfile:${userId}`;
        }

        async function loadProfile() {
        const { data: { user }, error } = await supabaseClient.auth.getUser();
        if (error || !user) return;

        const key = getProfileKey(user.id);
        const local = JSON.parse(localStorage.getItem(key) || 'null');

        const email = user.email || '';
        const md = user.user_metadata || {};

        const baseName =
            md.full_name || md.name || (email ? email.split('@')[0] : 'ì‚¬ìš©ì');

        // ë¡œì»¬ í¸ì§‘ê°’ì´ ìˆìœ¼ë©´ ê·¸ê±¸ ìš°ì„  ì‚¬ìš©
        const name = local?.name ?? baseName;
        const bio = local?.bio ?? (md.bio ?? 'í”„ë¡œí•„ì„ í¸ì§‘í•´ë³´ì„¸ìš”.');
        const avatarSeed = local?.avatarSeed ?? (name || 'seed');

        document.getElementById('profile-name').textContent = name;
        document.getElementById('profile-email').textContent = email;
        document.getElementById('profile-bio').textContent = bio;
        
        const avatarUrl =
        md.avatar_url ||
        md.picture ||
        `https://api.dicebear.com/7.x/avataaars/svg?seed=${user.id}`;

        document.getElementById('profile-img').src = avatarUrl;


        currentAvatarSeed = avatarSeed;
        }
        async function openProfileModal() {
            const { data: { user } } = await supabaseClient.auth.getUser();
            if (!user) return;

            const key = getProfileKey(user.id);
            const local = JSON.parse(localStorage.getItem(key) || 'null');

            const email = user.email || '';
            const md = user.user_metadata || {};
            const baseName = md.full_name || md.name || (email ? email.split('@')[0] : 'ì‚¬ìš©ì');

            const name = local?.name ?? baseName;
            const bio = local?.bio ?? '';
            const avatarSeed = local?.avatarSeed ?? (name || 'seed');

            const avatarUrl =
            md.avatar_url ||
            md.picture ||
            `https://api.dicebear.com/7.x/avataaars/svg?seed=${user.id}`;

            document.getElementById('edit-profile-img').src = avatarUrl;

            document.getElementById('edit-name').value = name;
            document.getElementById('edit-bio').value = bio;
            document.getElementById('edit-email').value = email;
            document.getElementById('edit-profile-img').src = avatarUrl;

            currentAvatarSeed = avatarSeed;

            document.getElementById('profile-modal').classList.remove('hidden');
            document.getElementById('profile-modal').classList.add('flex');
            }
        function closeProfileModal() { document.getElementById('profile-modal').classList.add('hidden'); document.getElementById('profile-modal').classList.remove('flex'); }
        async function saveProfile(e) {
            e.preventDefault();

            const { data: { user } } = await supabaseClient.auth.getUser();
            if (!user) return;

            const key = getProfileKey(user.id);

            const newProfile = {
                name: document.getElementById('edit-name').value,
                bio: document.getElementById('edit-bio').value,
                avatarSeed: currentAvatarSeed
            };

            localStorage.setItem(key, JSON.stringify(newProfile));
            await loadProfile();
            closeProfileModal();
            showAuthModal('ì €ì¥ ì™„ë£Œ', 'í”„ë¡œí•„ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.', 'âœ…');
            }

        function refreshAvatar() { currentAvatarSeed = Math.random().toString(36).substring(7); document.getElementById('edit-profile-img').src = `https://api.dicebear.com/7.x/avataaars/svg?seed=${currentAvatarSeed}`; }
        
        // --- 3. Tab Logic ---
        function switchTab(tabId) {
             if (tabId === 'favorites') tabId = 'saved'; // âœ… alias ë°©ì–´
            document.querySelectorAll('.tab-btn').forEach(btn => { const isActive = btn.dataset.tab === tabId; btn.dataset.active = isActive; btn.classList.toggle('text-black', isActive); btn.classList.toggle('text-gray-400', !isActive); });
            const line = document.getElementById('tab-line'); 
            if(tabId === 'saved') line.style.left = '0%'; 
            if(tabId === 'trips') line.style.left = '33.33%'; 
            if(tabId === 'reviews') line.style.left = '66.66%';
            document.querySelectorAll('.tab-content').forEach(content => { content.classList.remove('active'); }); document.getElementById(`tab-${tabId}`).classList.add('active');
        }

        // --- 4. Trips Logic ---
        function getTrips() { return JSON.parse(localStorage.getItem('myTrips') || '[]'); }
        
        function renderTrips() {
            const trips = getTrips(); const reviews = getMyReviews();
            const upcomingList = document.getElementById('upcoming-list'); const pastList = document.getElementById('past-list');
            upcomingList.innerHTML = ''; pastList.innerHTML = '';
            
            if (trips.length === 0) { upcomingList.innerHTML = `<div class="text-center py-10 text-gray-400 text-sm">ë“±ë¡ëœ ì—¬í–‰ ì¼ì •ì´ ì—†ìŠµë‹ˆë‹¤.</div>`; }
            trips.sort((a, b) => new Date(a.startDate) - new Date(b.startDate));

            trips.forEach((trip, index) => {
                const start = new Date(trip.startDate); 
                const end = new Date(trip.endDate); 
                end.setHours(23, 59, 59, 999); 
                
                const isPast = end < new Date(); 
                const today = new Date(); today.setHours(0,0,0,0);
                const dDay = Math.ceil((start - today) / (1000 * 60 * 60 * 24));
                const places = trip.selectedPlaces || [];
                const hasReview =
                places.length > 0 &&
                places.every(p => {
                    const placeName = p.title || p;
                    return reviews.some(r => r.tripId === trip.id && r.targetPlace === placeName);
                });
                
                // âœ… [REPLACE] ê³¼ê±° ì—¬í–‰ì´ë©´ ë¬´ì¡°ê±´ "í›„ê¸° ì“°ê¸°" ë²„íŠ¼ë§Œ ë…¸ì¶œ (ì‘ì„±ì™„ë£Œ ë±ƒì§€ ì œê±°)
                let actionButtonHtml = '';
                if (isPast) {
                    actionButtonHtml =
                        `<button type="button"
                            onclick="event.stopPropagation(); openCreateReviewModal('${trip.id}')"
                            class="px-4 py-2 bg-[#2563EB] text-white text-xs font-bold rounded-lg hover:bg-[#1D4ED8] transition-colors relative z-20 shadow-md">
                            í›„ê¸° ì“°ê¸°
                        </button>`;
                } else {
                    actionButtonHtml =
                        `<div class="flex gap-2 relative z-20">
                            <button type="button"
                                onclick="event.stopPropagation(); openEditModal('${trip.id}')"
                                class="p-2 bg-gray-100 rounded-full font-bold rounded-lg text-gray-500 text-xs hover:text-black hover:bg-gray-200 transition-colors">
                                ìˆ˜ì •
                            </button>

                            
                            <button type="button"
                                onclick="event.stopPropagation(); deleteTrip(${index})"
                                class="p-2 bg-gray-100 rounded-full font-bold rounded-lg text-gray-500 text-xs
hover:text-[#62B6FF] hover:bg-[#62B6FF]/10 transition-colors">
                                ì‚­ì œ
                            </button>
                        </div>`;
                }
                
                // [Modified] Location logic fallback (since input was removed, might be empty in new trips)
                const displayLocation = trip.location || 'ì—¬í–‰'; 
                
                const cardHtml = `
                <div onclick="openDetailModal('${trip.id}')" class="trip-card bg-white border border-gray-100 rounded-2xl p-5 shadow-sm flex justify-between items-center group relative overflow-hidden cursor-pointer hover:shadow-md">
                <div class="relative z-10">
                    <div class="flex items-center gap-2 mb-1">
                    <span class="text-[10px] font-bold px-2 py-0.5 rounded ${isPast ? 'bg-gray-100 text-gray-400' : 'bg-blue-100 text-blue-700'}">
                        ${isPast ? 'ì—¬í–‰ì™„ë£Œ' : (dDay <= 0 ? (dDay === 0 ? 'D-Day' : 'ì—¬í–‰ì¤‘') : `D-${dDay}`)}
                    </span>
                    <span class="text-xs text-gray-400">${trip.startDate} ~ ${trip.endDate}</span>
                    </div>

                    <h4 class="font-bold text-lg text-gray-900 flex items-center gap-2">
                    ${trip.title} ${trip.isAI ? '<i data-lucide="sparkles" width="14" class="text-violet-500"></i>' : ''}
                    </h4>

                    <p class="text-sm text-gray-500 flex items-center gap-1 mt-1">
                    <i data-lucide="map-pin" width="12"></i> ${displayLocation}
                    </p>
                </div>

                <div class="relative z-10 flex flex-col items-end gap-2">${actionButtonHtml}</div>
                </div>
                `;
                
                if (isPast) { pastList.innerHTML += cardHtml; } else { upcomingList.innerHTML += cardHtml; }
            });
            document.getElementById('upcoming-count').textContent = trips.length; // Approximate
            document.getElementById('stat-trips').textContent = trips.filter(t => new Date(t.endDate) < new Date()).length;
            lucide.createIcons();
        }

        // --- 5. Favorites with Smart Generator & Drag-Drop ---
        
        // [ìˆ˜ì •ë¨] ì¼ì • ìƒì„± í•¨ìˆ˜ (ì™„ë£Œ í›„ ëª¨ë“œ í•´ì œ)
        function generateTripFromSelection() {
            const checkboxes = document.querySelectorAll('.saved-item-checkbox:checked');
            if (checkboxes.length === 0) { 
            showAuthModal(
                'ì„ íƒ í•„ìš”',
                'ì¼ì •ì— ì¶”ê°€í•  ì¥ì†Œë¥¼ ìµœì†Œ 1ê°œ ì´ìƒ ì„ íƒí•´ì£¼ì„¸ìš”.',
                'â—'
            );
            return;
            }

            // ... (ê¸°ì¡´ ë°ì´í„° ì²˜ë¦¬ ë¡œì§ ë™ì¼) ...
            const selectedIds = Array.from(checkboxes).map(cb => cb.dataset.id);
            const selectedArticles = [];
            const locationKeywords = [];
            let themeCounts = { 'ë§›ì§‘': 0, 'íœ´ì–‘': 0, 'ê´€ê´‘': 0, 'ì•¡í‹°ë¹„í‹°': 0 };

            currentSelectedPlaces = [];

            selectedIds.forEach(id => {
                if (typeof ARTICLES !== 'undefined') {
                    const article = ARTICLES.find(a => a.id === id);
                    if (article) {
                        const tags = (article.mainTags || []).concat(article.tags || []).join(' ');
                        let cat = 'ê´€ê´‘';
                        if (tags.match(/ìˆ™ì†Œ|í˜¸í…”|ë¦¬ì¡°íŠ¸|íœì…˜|ìŠ¤í…Œì´/)) cat = 'ìˆ™ì†Œ';
                        else if (tags.match(/ë§›ì§‘|ì‹ë‹¹|ì¹´í˜|ìŒì‹ì |ë² ì´ì»¤ë¦¬/)) cat = 'ë§›ì§‘';
                        
                        if(tags.match(/ë§›ì§‘|ì‹ë‹¹|ì¹´í˜/)) themeCounts['ë§›ì§‘']++;
                        if(tags.match(/ìˆ™ì†Œ|í˜¸í…”|ë¦¬ì¡°íŠ¸|íœ´ì–‘|íë§/)) themeCounts['íœ´ì–‘']++;
                        if(tags.match(/ê´€ê´‘|ëª…ì†Œ|ìœ ì /)) themeCounts['ê´€ê´‘']++;
                        if(tags.match(/ì•¡í‹°ë¹„í‹°|ì„œí•‘|íŠ¸ë ˆí‚¹/)) themeCounts['ì•¡í‹°ë¹„í‹°']++;

                        const textToScan = (article.address || '') + (article.title || '');
                        if (textToScan.includes('ê°•ë¦‰')) locationKeywords.push('ê°•ë¦‰');
                        else if (textToScan.includes('ê°€í‰')) locationKeywords.push('ê°€í‰');
                        else if (textToScan.includes('ë°©ì½•')) locationKeywords.push('ë°©ì½•');
                        else if (textToScan.includes('ì½”ì‚¬ë¬´ì´')) locationKeywords.push('ì½”ì‚¬ë¬´ì´');
                        else if (textToScan.includes('ì˜¤ì‚¬ì¹´')) locationKeywords.push('ì˜¤ì‚¬ì¹´');
                        else if (textToScan.includes('ê²½ì£¼')) locationKeywords.push('ê²½ì£¼');
                        else if (textToScan.includes('ê´Œ')) locationKeywords.push('ê´Œ');
                        else if (textToScan.includes('ì œì£¼')) locationKeywords.push('ì œì£¼');

                        currentSelectedPlaces.push({
                            id: article.id,
                            title: article.name || article.title,
                            address: article.address || 'ì£¼ì†Œ ì •ë³´ ì—†ìŒ',
                            imageUrl: article.imageUrl,
                            category: cat,
                            rating: article.rating
                        });
                    }
                }
            });

            let mainLocation = 'ë‚˜ë§Œì˜';
            if (locationKeywords.length > 0) {
                const counts = {};
                locationKeywords.forEach(loc => { counts[loc] = (counts[loc] || 0) + 1; });
                mainLocation = Object.keys(counts).reduce((a, b) => counts[a] > counts[b] ? a : b);
            }

            let mainTheme = Object.keys(themeCounts).reduce((a, b) => themeCounts[a] > themeCounts[b] ? a : b);
            let themeValue = 'íë§';
            if(mainTheme === 'ë§›ì§‘') themeValue = 'ë§›ì§‘';
            if(mainTheme === 'ê´€ê´‘') themeValue = 'ê´€ê´‘';
            if(mainTheme === 'ì•¡í‹°ë¹„í‹°') themeValue = 'ì•¡í‹°ë¹„í‹°';

            // 1. ëª¨ë‹¬ ì—´ê¸°
            openCreateModal();
            
            // 2. ê°’ ì±„ìš°ê¸°
            const setVal = (id, val) => { if(document.getElementById(id)) document.getElementById(id).value = val; };
            setVal('trip-title', `${mainLocation} ${mainTheme} ì—¬í–‰`);
            
            const today = new Date();
            const start = new Date(today); start.setDate(today.getDate() + 7);
            const end = new Date(start); end.setDate(start.getDate() + 9);
            setVal('trip-start', start.toISOString().split('T')[0]);
            setVal('trip-end', end.toISOString().split('T')[0]);

            renderDraggableList();
            updateTripMemo(mainLocation, mainTheme);

            // 3. [ì¤‘ìš”] ì¼ì •ì´ ìƒì„±ë˜ì—ˆìœ¼ë¯€ë¡œ ì„ íƒ ëª¨ë“œ ì¢…ë£Œ (ì´ˆê¸°í™”)
            toggleSelectionMode(false);
        }

        // --- Drag & Drop List Rendering ---
        function renderDraggableList() {
            const container = document.getElementById('selected-places-container');
            const list = document.getElementById('selected-places-list');
            
            if(container) {
                container.classList.remove('hidden');
                container.style.display = 'flex'; // Changed to flex for expansion
            }
            if(list) {
                list.innerHTML = '';
                currentSelectedPlaces.forEach((item, index) => {
                    const li = document.createElement('div');
                    li.className = 'draggable-item flex items-center gap-3 p-3 bg-white rounded-xl border border-gray-100 shadow-sm select-none hover:shadow-md transition-shadow';
                    li.setAttribute('draggable', 'true');
                    li.dataset.index = index;

                    li.innerHTML = `
                        <div class="drag-handle p-2 cursor-grab text-gray-400 hover:text-black"><i data-lucide="grip-vertical" width="18"></i></div>
                        <div class="w-12 h-12 rounded-lg overflow-hidden flex-shrink-0">
                            <img src="${item.imageUrl}" class="w-full h-full object-cover pointer-events-none">
                        </div>
                        <div class="flex-1 min-w-0 pointer-events-none">
                            <div class="flex items-center gap-2 mb-0.5">
                                <span class="text-[10px] font-bold text-gray-500 bg-gray-100 px-1.5 py-0.5 rounded">${item.category === 'ìˆ™ì†Œ' ? 'ğŸ  ìˆ™ì†Œ' : (item.category === 'ë§›ì§‘' ? 'ğŸ½ï¸ ë§›ì§‘' : 'ğŸ“¸ ê´€ê´‘')}</span>
                                <p class="text-sm font-bold text-gray-900 truncate">${item.title}</p>
                            </div>
                            <p class="text-xs text-gray-400 truncate">${item.address}</p>
                        </div>
                    `;

                    li.addEventListener('dragstart', () => li.classList.add('dragging'));
                    li.addEventListener('dragend', () => {
                        li.classList.remove('dragging');
                        // [Modified] No longer reading from input fields for update
                        safeUpdateMemo();
                    });

                    list.appendChild(li);
                });

                list.addEventListener('dragover', e => {
                    e.preventDefault();
                    const afterElement = getDragAfterElement(list, e.clientY);
                    const draggable = document.querySelector('.dragging');
                    if (afterElement == null) {
                        list.appendChild(draggable);
                    } else {
                        list.insertBefore(draggable, afterElement);
                    }
                });
                
                list.addEventListener('drop', () => {
                    const newItems = list.querySelectorAll('.draggable-item');
                    const reorderedArray = [];
                    newItems.forEach(div => {
                        reorderedArray.push(currentSelectedPlaces[div.dataset.index]);
                    });
                    currentSelectedPlaces = reorderedArray;
                    newItems.forEach((div, idx) => { div.dataset.index = idx; });

                    safeUpdateMemo();
                });
            }
            if(typeof lucide !== 'undefined') lucide.createIcons();
        }

        function safeUpdateMemo() {
            // [Modified] Defaults since inputs are gone
            const location = 'ì—¬í–‰';
            const theme = 'ê³„íš';
            updateTripMemo(location, theme);
        }

        function getDragAfterElement(container, y) {
            const draggableElements = [...container.querySelectorAll('.draggable-item:not(.dragging)')];
            return draggableElements.reduce((closest, child) => {
                const box = child.getBoundingClientRect();
                const offset = y - box.top - box.height / 2;
                if (offset < 0 && offset > closest.offset) {
                    return { offset: offset, element: child };
                } else {
                    return closest;
                }
            }, { offset: Number.NEGATIVE_INFINITY }).element;
        }

        function updateTripMemo(location, theme) {
            let memo = `âœ¨ [${location}] ${theme} ì¼ì • âœ¨\n\n`;
            memo += `ğŸ“‹ ë°©ë¬¸ ì¥ì†Œ ìˆœì„œ\n`;
            
            currentSelectedPlaces.forEach((item, index) => {
                const icon = item.category === 'ìˆ™ì†Œ' ? 'ğŸ ' : (item.category === 'ë§›ì§‘' ? 'ğŸ½ï¸' : 'ğŸ“¸');
                memo += `${index + 1}. ${icon} ${item.title}\n   ğŸ“ ${item.address}\n`;
            });

            memo += `\nğŸ—“ï¸ ìë™ ì¶”ì²œ ë™ì„ \n-------------------\n`;

            if (currentSelectedPlaces.length === 0) {
                memo += "ì¥ì†Œë¥¼ ì„ íƒí•˜ë©´ ì¼ì •ì´ ìƒì„±ë©ë‹ˆë‹¤.";
            } else {
                const itemsPerDay = 3;
                let dayCount = 1;
                memo += `1ì¼ì°¨:\n`;
                memo += `- ë„ì°© ë° ì´ë™\n`;

                currentSelectedPlaces.forEach((item, index) => {
                    if (index > 0 && index % itemsPerDay === 0) {
                        dayCount++;
                        memo += `\n${dayCount}ì¼ì°¨:\n`;
                    }
                    const seq = index % itemsPerDay;
                    let timeLabel = "";
                    if (seq === 0) timeLabel = "[ì˜¤ì „]";
                    else if (seq === 1) timeLabel = "[ì˜¤í›„]";
                    else if (seq === 2) timeLabel = "[ì €ë…]";

                    let action = "ë°©ë¬¸";
                    if (item.category === 'ìˆ™ì†Œ') {
                        action = "ì²´í¬ì¸";
                        timeLabel = "[ìˆ™ì†Œ]"; 
                    } else if (item.category === 'ë§›ì§‘') {
                        action = "ì‹ì‚¬";
                    }

                    memo += `- ${timeLabel} ${item.title} (${action})\n`;
                });
                memo += `\n${dayCount + 1}ì¼ì°¨:\n- ì²´í¬ì•„ì›ƒ ë° ê·€ê°€\n`;
            }
            
            const memoEl = document.getElementById('trip-memo');
            if(memoEl) memoEl.value = memo;
             // [ì¶”ê°€] ëª¨ë‹¬ì´ ì—´ë¦¬ë©´ ì„ íƒ ëª¨ë“œ ì¢…ë£Œ (ê¹”ë”í•˜ê²Œ ì´ˆê¸°í™”)
            toggleSelectionMode(false);
        }

        // --- Modals Management ---
        function openDetailModal(tripId) {
            const trips = getTrips(); 
            const trip = trips.find(t => t.id === tripId); 
            if(!trip) return;

            document.getElementById('view-title').textContent = trip.title;
            const typeText = trip.isAI ? 'AI ìƒì„±' : 'ì§ì ‘ ìƒì„±';
            document.getElementById('view-badge').textContent = typeText;
            
            document.getElementById('view-date').textContent = `${trip.startDate} ~ ${trip.endDate}`; 
            // [Modified] Removed text assignment for deleted fields (location, companions, budget, theme, transport)
            
            document.getElementById('view-memo').textContent = trip.memo || 'ì‘ì„±ëœ ë©”ëª¨ê°€ ì—†ìŠµë‹ˆë‹¤.';

            // [Modified] ì„ íƒëœ ì—¬í–‰ì§€ ëª©ë¡ í‘œì‹œ (Expanded)
            const placesContainer = document.getElementById('view-places-container');
            const placesList = document.getElementById('view-places-list');
            
            if (trip.selectedPlaces && trip.selectedPlaces.length > 0) {
                placesContainer.classList.remove('hidden');
                placesList.innerHTML = '';
                
                trip.selectedPlaces.forEach(item => {
                    const title = item.title || item;
                    const imgUrl = item.imageUrl || 'https://via.placeholder.com/40';
                    const category = item.category || 'ì¥ì†Œ';
                    const address = item.address || 'ì£¼ì†Œ ì •ë³´ ì—†ìŒ';

                    placesList.innerHTML += `
                        <div class="flex items-center gap-3 p-3 bg-white rounded-lg border border-gray-100 shadow-sm">
                            <img src="${imgUrl}" class="w-12 h-12 rounded-md object-cover flex-shrink-0">
                            <div class="flex-1 min-w-0">
                                <div class="flex items-center gap-2">
                                    <span class="text-[10px] font-bold text-gray-500 bg-gray-100 px-1.5 rounded">${category}</span>
                                    <p class="text-sm font-bold text-gray-900 truncate">${title}</p>
                                </div>
                                <p class="text-xs text-gray-400 truncate">${address}</p>
                            </div>
                        </div>`;
                });
            } else {
                placesContainer.classList.add('hidden');
            }

            document.getElementById('detail-modal').classList.remove('hidden'); 
            document.getElementById('detail-modal').classList.add('flex');
        }
        function closeDetailModal() { document.getElementById('detail-modal').classList.add('hidden'); document.getElementById('detail-modal').classList.remove('flex'); }
        
        // [New] ìˆ˜ë™ ìƒì„± ë²„íŠ¼ìš© (ì´ˆê¸°í™” í¬í•¨)
        function openManualCreateModal() {
            currentSelectedPlaces = []; // ì—¬ê¸°ì„œë§Œ ì´ˆê¸°í™”!
            openCreateModal();
        }

        function openCreateModal() { 
            document.getElementById('create-modal-title').textContent = 'ìƒˆ ì¼ì • ë§Œë“¤ê¸°'; document.getElementById('btn-save-trip').textContent = 'ì¼ì • ì €ì¥í•˜ê¸°'; document.getElementById('edit-trip-id').value = ''; 
            document.querySelector('#create-modal form').reset(); 
            if (currentSelectedPlaces.length === 0) {
                const container = document.getElementById('selected-places-container');
                if(container) container.classList.add('hidden');
            }
            document.getElementById('create-modal').classList.remove('hidden'); document.getElementById('create-modal').classList.add('flex'); 
        }
        
        function openEditModal(tripId) {
            const trips = getTrips(); 
            const trip = trips.find(t => t.id === tripId); 
            if(!trip) return;

            document.getElementById('create-modal-title').textContent = 'ì¼ì • ìˆ˜ì •í•˜ê¸°'; 
            document.getElementById('btn-save-trip').textContent = 'ìˆ˜ì •ì™„ë£Œ'; 
            document.getElementById('edit-trip-id').value = trip.id;
            
            const setVal = (id, val) => { const el = document.getElementById(id); if(el) el.value = val; };
            setVal('trip-title', trip.title); 
            // [Modified] Removed setVal for deleted fields
            setVal('trip-start', trip.startDate); 
            setVal('trip-end', trip.endDate); 
            setVal('trip-memo', trip.memo || '');
            
            // [Updated] ìˆ˜ì • ì‹œì—ë„ ê¸°ì¡´ ì¥ì†Œ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
            currentSelectedPlaces = trip.selectedPlaces || [];
            
            if (currentSelectedPlaces.length > 0) {
                renderDraggableList(); // ë¦¬ìŠ¤íŠ¸ ë Œë”ë§
                const container = document.getElementById('selected-places-container');
                if(container) {
                    container.classList.remove('hidden');
                    container.style.display = 'flex';
                }
            } else {
                const container = document.getElementById('selected-places-container');
                if(container) container.classList.add('hidden');
            }
            
            document.getElementById('create-modal').classList.remove('hidden'); 
            document.getElementById('create-modal').classList.add('flex');
            if(typeof lucide !== 'undefined') lucide.createIcons();
        }
        
        function closeCreateModal() { document.getElementById('create-modal').classList.add('hidden'); document.getElementById('create-modal').classList.remove('flex'); }
        
        function handleCreateOrUpdateTrip(e) {
            e.preventDefault(); 
            let trips = getTrips(); 
            
            const getVal = (id) => {
                const el = document.getElementById(id);
                return el ? el.value : '';
            };

            const editId = getVal('edit-trip-id');
            
            // [Modified] Deleted fields are now hardcoded or empty
            const tripData = { 
                title: getVal('trip-title'), 
                location: 'ì—¬í–‰', // Default
                startDate: getVal('trip-start'), 
                endDate: getVal('trip-end'), 
                budget: '0', 
                companions: '', 
                memo: getVal('trip-memo'), 
                theme: '',       
                transport: '',
                selectedPlaces: currentSelectedPlaces, // í˜„ì¬ ì „ì—­ ë³€ìˆ˜ ê°’ ì‚¬ìš©
                isAI: false 
            };

            if(editId) { 
                const index = trips.findIndex(t => t.id === editId); 
                if(index !== -1) { 
                    trips[index] = { ...trips[index], ...tripData }; 
                    showAuthModal('ìˆ˜ì • ì™„ë£Œ', 'ì¼ì •ì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.', 'âœ…');
                } 
            } else { 
                trips.push({ id: Date.now().toString(), ...tripData }); 
            }
            
            localStorage.setItem('myTrips', JSON.stringify(trips)); 
            closeCreateModal(); 
            renderTrips(); 
            e.target.reset();
        }
        function deleteTrip(index) {
            showConfirmModal('ì¼ì • ì‚­ì œ', 'ì¼ì •ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?', () => {
                const trips = getTrips();
                trips.splice(index, 1);
                localStorage.setItem('myTrips', JSON.stringify(trips));
                renderTrips();
            }, 'ğŸ—‘ï¸');
            }

        
        // âœ… [ADD] ì „ì—­ ë³€ìˆ˜ 1ê°œ ì¶”ê°€
        let currentReviewArticleId = null;

        // âœ… [ADD] ì•„í‹°í´ ìƒì„¸ë¡œ ì´ë™ í—¬í¼
        function goToReviewArticle(articleId) {
        if (!articleId) {
            showAuthModal('ì´ë™ ë¶ˆê°€', 'ì—°ê²°ëœ ì•„í‹°í´ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'âš ï¸');
            return;
            }
        location.href = `article.html?id=${encodeURIComponent(articleId)}#reviews`;
        }

        // --- 6. Review Logic (Updated: articleId ì—°ê²°) ---
        function getMyReviews() {
            return JSON.parse(localStorage.getItem('myReviews') || '[]');
        }

        let currentReviewTripId = null;
        let editingReviewId = null;
        let targetPlaceTitle = '';
        let currentRating = 5;

        // âœ… [REPLACE] 1ë‹¨ê³„: ì¥ì†Œ ëª©ë¡ ëª¨ë‹¬ ì—´ê¸° (placeName + articleId ê°™ì´ ë„˜ê¹€)
function openCreateReviewModal(tripId) {
    const trips = getTrips();
    const trip = trips.find(t => t.id === tripId);
    if (!trip) return;

    currentReviewTripId = tripId;

    const listContainer = document.getElementById('review-places-list');
    listContainer.innerHTML = '';

    const myReviews = getMyReviews();

    if (trip.selectedPlaces && trip.selectedPlaces.length > 0) {
        trip.selectedPlaces.forEach(place => {
            const placeName = (place && typeof place === 'object') ? (place.title || place.name || '') : String(place);
            const placeImg  = (place && typeof place === 'object') ? (place.imageUrl || 'https://via.placeholder.com/40') : 'https://via.placeholder.com/40';
            const category  = (place && typeof place === 'object') ? (place.category || 'ì¥ì†Œ') : 'ì¥ì†Œ';

            // âœ… í•µì‹¬: articleId í™•ë³´ (ê°ì²´ë©´ place.id, ì•„ë‹ˆë©´ place ìì²´ê°€ idì¼ ìˆ˜ë„ ìˆìœ¼ë‹ˆ ë°©ì–´)
            const placeIdRaw = (place && typeof place === 'object') ? place.id : place;
            const placeId = placeIdRaw != null ? String(placeIdRaw) : '';

            // ë”°ì˜´í‘œ ì´ìŠ¤ì¼€ì´í”„ (onclick ì•ˆì „)
            const safeName = placeName.replace(/'/g, "\\'");
            const safeId   = placeId.replace(/'/g, "\\'");

            // ê¸°ì¡´ ë¦¬ë·° ì°¾ê¸° (tripId + targetPlace ê¸°ì¤€ì€ ìœ ì§€)
            const existingReview = myReviews.find(r => r.tripId === tripId && r.targetPlace === placeName);

            let actionBtn = '';
            if (existingReview) {
                actionBtn = `
                    <button
                        type="button"
                        onclick="openWriteModal('${safeName}', '${safeId}', ${existingReview.id})"
                        class="px-4 py-2 bg-gray-100 text-gray-600 text-xs font-bold rounded-lg hover:bg-gray-200 transition-colors flex items-center gap-1"
                    >
                        <i data-lucide="check" width="12"></i> ì™„ë£Œ (ìˆ˜ì •)
                    </button>`;
            } else {
                actionBtn = `
                    <button
                        type="button"
                        onclick="openWriteModal('${safeName}', '${safeId}', null)"
                        class="px-4 py-2
bg-[#62B6FF] text-white
text-xs font-bold rounded-lg
hover:bg-[#4FA8F0]
transition-colors
shadow-sm"
                    >
                        ì‘ì„±í•˜ê¸°
                    </button>`;
            }

            listContainer.innerHTML += `
                <div class="flex items-center gap-3 p-3 bg-white rounded-xl border border-gray-100 shadow-sm">
                    <img src="${placeImg}" class="w-12 h-12 rounded-lg object-cover flex-shrink-0 bg-gray-100">
                    <div class="flex-1 min-w-0">
                        <div class="flex items-center gap-2 mb-0.5">
                            <span class="text-[10px] font-bold text-gray-500 bg-gray-100 px-1.5 rounded">${category}</span>
                        </div>
                        <p class="text-sm font-bold text-gray-900 truncate">${placeName}</p>
                    </div>
                    ${actionBtn}
                </div>
            `;
        });
    } else {
        listContainer.innerHTML = `
            <div class="text-center py-10 text-gray-400 text-sm">
                ì„ íƒëœ ì¥ì†Œê°€ ì—†ìŠµë‹ˆë‹¤.<br>ì „ì²´ í›„ê¸°ë§Œ ë‚¨ê¸¸ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
            </div>
        `;
    }

    // ëª©ë¡ ëª¨ë‹¬ ì—´ê¸°
    document.getElementById('review-list-modal').classList.remove('hidden');
    document.getElementById('review-list-modal').classList.add('flex');

    if (typeof lucide !== 'undefined') lucide.createIcons();

    updateReviewCompleteButton(tripId);
}

        function closeReviewListModal() {
            document.getElementById('review-list-modal').classList.add('hidden');
            document.getElementById('review-list-modal').classList.remove('flex');
        }

        function updateReviewCompleteButton(tripId) {
    const btn = document.getElementById('btn-review-complete');
    const hint = document.getElementById('review-complete-hint');
    if (!btn) return;

    const trips = getTrips();
    const trip = trips.find(t => t.id === tripId);
    const places = (trip && trip.selectedPlaces) ? trip.selectedPlaces : [];

    // ì¥ì†Œê°€ ì—†ìœ¼ë©´ ì™„ë£Œ ë²„íŠ¼ ë¹„í™œì„±
    if (!places || places.length === 0) {
        btn.disabled = true;
        btn.className = "w-full py-3 rounded-xl font-bold transition-colors bg-gray-200 text-gray-400 cursor-not-allowed";
        if (hint) hint.textContent = "ì„ íƒëœ ì¥ì†Œê°€ ì—†ì–´ ì™„ë£Œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.";
        return;
    }

    const myReviews = getMyReviews();

    // âœ… ëª¨ë“  ì¥ì†Œê°€ ë¦¬ë·° ì‘ì„±ëëŠ”ì§€ ì²´í¬
    const allDone = places.every(p => {
    const pid = (p && typeof p === 'object') ? String(p.id ?? '') : String(p ?? '');
    if (!pid) return false;
    return myReviews.some(r => r.tripId === tripId && String(r.articleId) === pid);
    });

    if (allDone) {
        btn.disabled = false;
        btn.className = "w-full py-3 rounded-xl font-bold transition-colors bg-black text-white hover:bg-gray-800";
        if (hint) hint.textContent = "ëª¨ë“  ì¥ì†Œ í›„ê¸°ê°€ ì‘ì„±ë˜ì—ˆìŠµë‹ˆë‹¤. ì™„ë£Œë¥¼ ëˆŒëŸ¬ ë‹«ì„ ìˆ˜ ìˆì–´ìš”.";
    } else {
        btn.disabled = true;
        btn.className = "w-full py-3 rounded-xl font-bold transition-colors bg-gray-200 text-gray-400 cursor-not-allowed";
        if (hint) hint.textContent = "ëª¨ë“  ì¥ì†Œì˜ í›„ê¸°ë¥¼ ì‘ì„±í•˜ë©´ í™œì„±í™”ë©ë‹ˆë‹¤.";
    }
}

    function completeAllReviewsAndClose() {
    closeReviewListModal();
    showAuthModal('ì™„ë£Œ', 'ëª¨ë“  ì¥ì†Œ í›„ê¸°ê°€ ì‘ì„±ë˜ì—ˆìŠµë‹ˆë‹¤.', 'âœ…');
    }

    function renderExistingMedia() {
        const section = document.getElementById('existing-media-section');
        const container = document.getElementById('existing-media-container');
        if (!section || !container) return;

        if (!existingMedia || existingMedia.length === 0) {
            section.classList.add('hidden');
            container.innerHTML = '';
            return;
        }

        section.classList.remove('hidden');
        container.innerHTML = '';

        existingMedia.forEach((m, idx) => {
            const wrap = document.createElement('div');
            wrap.className = 'relative w-16 h-16 flex-shrink-0 group';

            let el;
            if (m.type === 'video') {
            el = document.createElement('video');
            el.src = m.url;
            el.controls = true;
            } else {
            el = document.createElement('img');
            el.src = m.url;
            }
            el.className = 'w-full h-full object-cover rounded-lg border border-gray-200 bg-black';

            const del = document.createElement('button');
            del.type = 'button';
            del.className = 'absolute -top-1 -right-1 bg-red-500 text-white rounded-full p-0.5 shadow-md opacity-0 group-hover:opacity-100 transition-opacity';
            del.innerHTML = 'âœ•';
            del.onclick = (e) => {
            e.stopPropagation();
            existingMedia.splice(idx, 1);
            renderExistingMedia();
            };

            wrap.appendChild(el);
            wrap.appendChild(del);
            container.appendChild(wrap);
        });
        }
    
    // âœ… [REPLACE] 2ë‹¨ê³„: ê¸€ì“°ê¸° ëª¨ë‹¬ ì—´ê¸° (placeName + articleIdë¥¼ ì „ì—­ì— ì €ì¥)
    function openWriteModal(placeName, articleId, reviewId) {
    targetPlaceTitle = placeName;
    selectedFiles = []; 
    const previewContainer = document.getElementById('file-preview-container');
    if (previewContainer) previewContainer.innerHTML = '';
    
    currentReviewArticleId = articleId;   // âœ… í•µì‹¬
    editingReviewId = reviewId;
    existingMedia = [];
    document.getElementById('existing-media-section')?.classList.add('hidden');
    document.getElementById('review-modal-title').textContent = reviewId ? 'í›„ê¸° ìˆ˜ì •' : 'í›„ê¸° ì‘ì„±';
    document.getElementById('btn-save-review').textContent = reviewId ? 'ìˆ˜ì • ì™„ë£Œ' : 'ì‘ì„± ì™„ë£Œ';

    // ì¥ì†Œëª… í‘œì‹œ(ìˆ˜ì • ë¶ˆê°€)
    const targetDisplay = document.getElementById('review-target-display');
    if (targetDisplay) targetDisplay.value = placeName;

    // ë‚´ìš© ì„¸íŒ…
    if (reviewId) {
    const reviews = getMyReviews();
    const review = reviews.find(r => r.id === reviewId);
    if (review) {
        document.getElementById('review-text').value = review.text || '';
        // âœ… ê¸°ì¡´ ë¦¬ë·°ì— articleIdê°€ ìˆìœ¼ë©´ ê·¸ê±¸ ìš°ì„  ì‚¬ìš©
        currentReviewArticleId = review.articleId || currentReviewArticleId;
        setRating(review.rating || 5);

        // âœ…ğŸ”¥ ì—¬ê¸° ì¶”ê°€ (ê¸°ì¡´ ì²¨ë¶€íŒŒì¼ ë¶ˆëŸ¬ì˜¤ê¸°)
        existingMedia = Array.isArray(review.media) ? [...review.media] : [];
        renderExistingMedia();

        } else {
            document.getElementById('review-text').value = '';
            setRating(5);
        }
    } else {
        document.getElementById('review-text').value = '';
        setRating(5);
    }

    document.getElementById('review-modal').classList.remove('hidden');
    document.getElementById('review-modal').classList.add('flex');
    
    if(typeof lucide !== 'undefined') lucide.createIcons();
    }

    // âœ… [REPLACE] ë¦¬ë·° ì €ì¥ (articleId ê°™ì´ ì €ì¥)
    async function submitReview() {
            const text = document.getElementById('review-text').value;
            if(!text) return alert('ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
            
            const btn = document.getElementById('btn-save-review');
            const originalBtnText = btn.textContent;
            
            // ë¡œë”© í‘œì‹œ
            btn.textContent = 'ì—…ë¡œë“œ ì¤‘...';
            btn.disabled = true;

            try {
                // [ì¶”ê°€ë¨] íŒŒì¼ ì—…ë¡œë“œ ìˆ˜í–‰
                const newMedia = await uploadFilesToSupabase();

                let reviews = getMyReviews();

                if (editingReviewId) {
            const index = reviews.findIndex(r => r.id === editingReviewId);
            if (index !== -1) {
                reviews[index].text = text;
                reviews[index].rating = currentRating;
                reviews[index].date = new Date().toLocaleDateString() + ' (ìˆ˜ì •ë¨)';
                // âœ… articleId ì—†ë˜ ì˜ˆì „ ë°ì´í„° ë³´ì •
                reviews[index].articleId = reviews[index].articleId || currentReviewArticleId || '';
                reviews[index].targetPlace = reviews[index].targetPlace || targetPlaceTitle;
                 // [ì¶”ê°€ë¨] ë¯¸ë””ì–´ ì¶”ê°€ (ê¸°ì¡´ ë¯¸ë””ì–´ ìœ ì§€ + ìƒˆ ë¯¸ë””ì–´)
                reviews[index].media = (existingMedia || []).concat(newMedia);
            }
        } else {
            const trips = getTrips();
            const trip = trips.find(t => t.id === currentReviewTripId);

            reviews.unshift({
                id: Date.now(),
                tripId: currentReviewTripId,
                tripTitle: trip ? trip.title : 'ì—¬í–‰',
                targetPlace: targetPlaceTitle,
                articleId: currentReviewArticleId ? String(currentReviewArticleId) : '',   // âœ… í•µì‹¬
                text: text,
                rating: currentRating,
                date: new Date().toLocaleDateString(),
                media: newMedia // [ì¶”ê°€ë¨] ë¯¸ë””ì–´ ì €ì¥
            });
        }

        localStorage.setItem('myReviews', JSON.stringify(reviews));
                showAuthModal('ì €ì¥ ì™„ë£Œ', 'í›„ê¸°ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.', 'â—');
                closeReviewModal();
                
                openCreateReviewModal(currentReviewTripId);
                renderReviews();
                renderTrips();

            } catch (err) {
                console.error(err);
                alert('ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            } finally {
                // ë²„íŠ¼ ë³µêµ¬
                btn.textContent = originalBtnText;
                btn.disabled = false;
            }
        }
        // [New] íŒŒì¼ ì„ íƒ í•¸ë“¤ëŸ¬ (ë¯¸ë¦¬ë³´ê¸° ìƒì„±)
        function handleFileSelect(event) {
            const files = Array.from(event.target.files);
            const previewContainer = document.getElementById('file-preview-container');
            
            // ìµœëŒ€ 5ê°œ ì œí•œ
            if (selectedFiles.length + files.length > 5) {
                alert('ìµœëŒ€ 5ê°œê¹Œì§€ë§Œ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤.');
                return;
            }
            
            files.forEach(file => {
                selectedFiles.push(file);
                
                const wrapper = document.createElement('div');
                wrapper.className = 'relative w-16 h-16 flex-shrink-0 group';
                
                const el = document.createElement(file.type.startsWith('video') ? 'video' : 'img');
                el.src = URL.createObjectURL(file);
                el.className = 'w-full h-full object-cover rounded-lg border border-gray-200';
                
                // ì‚­ì œ ë²„íŠ¼
                const closeBtn = document.createElement('button');
                closeBtn.className = 'absolute -top-1 -right-1 bg-red-500 text-white rounded-full p-0.5 shadow-md opacity-0 group-hover:opacity-100 transition-opacity';
                closeBtn.innerHTML = '<svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>';
                closeBtn.onclick = () => {
                    const idx = selectedFiles.indexOf(file);
                    if(idx > -1) selectedFiles.splice(idx, 1);
                    wrapper.remove();
                };

                wrapper.appendChild(el);
                wrapper.appendChild(closeBtn);
                previewContainer.appendChild(wrapper);
            });
            
            // input ì´ˆê¸°í™” (ê°™ì€ íŒŒì¼ ë‹¤ì‹œ ì„ íƒ ê°€ëŠ¥í•˜ê²Œ)
            event.target.value = '';
        }

        // [New] Supabase Storage ì—…ë¡œë“œ í•¨ìˆ˜
        function safeExt(name) {
        const m = name.match(/\.([a-zA-Z0-9]+)$/);
        return m ? m[1].toLowerCase() : "bin";
        }

        async function uploadFilesToSupabase() {
        if (selectedFiles.length === 0) return [];

        const uploadedUrls = [];
        for (const file of selectedFiles) {
            const ext = safeExt(file.name);
            const fileName = `reviews/${Date.now()}_${crypto.randomUUID()}.${ext}`; // âœ… í•œê¸€ ì œê±°

            const { error } = await supabaseClient
            .storage
            .from("reviews")
            .upload(fileName, file, { upsert: false });

            if (error) {
            console.error("Upload Error:", error);
            alert(`ì—…ë¡œë“œ ì‹¤íŒ¨: ${file.name}\n${error.message || ""}`);
            continue;
            }

            const { data: publicData } = supabaseClient
            .storage
            .from("reviews")
            .getPublicUrl(fileName);

            uploadedUrls.push({
            url: publicData.publicUrl,
            type: file.type.startsWith("video") ? "video" : "image",
            });
        }

        return uploadedUrls;
        }   


        // [ìˆ˜ì •ë¨] ë³„ì  UI (ì•ˆì „ì¥ì¹˜ ì¶”ê°€)
        function setRating(rating) {
            currentRating = rating;
            // CSS ì„ íƒì ì •í™•ë„ ë†’ì„
            const stars = document.querySelectorAll('#review-modal #star-container button');
            const ratingTexts = ["", "1ì  - ì•„ì‰¬ì› ì–´ìš”", "2ì  - ê·¸ì € ê·¸ë¬ì–´ìš”", "3ì  - ê´œì°®ì•˜ì–´ìš”", "4ì  - ì¢‹ì•˜ì–´ìš”!", "5ì  - ìµœê³ ì˜€ì–´ìš”!"];
            
            const textEl = document.getElementById('rating-text');
            if(textEl) textEl.textContent = ratingTexts[rating] || "";
            
            if (!stars || stars.length === 0) return; // ë²„íŠ¼ ëª» ì°¾ìœ¼ë©´ ì¤‘ë‹¨

            stars.forEach((btn, index) => {
                const icon = btn.querySelector('svg') || btn.querySelector('i');
                if (index < rating) {
                    btn.classList.add('active'); 
                    btn.classList.remove('text-gray-300');
                    if(icon) { 
                        icon.classList.add('fill-yellow-400', 'text-yellow-400'); 
                        icon.classList.remove('text-gray-300'); 
                    }
                } else {
                    btn.classList.remove('active'); 
                    btn.classList.add('text-gray-300');
                    if(icon) { 
                        icon.classList.remove('fill-yellow-400', 'text-yellow-400'); 
                        icon.classList.add('text-gray-300'); 
                    }
                }
            });
        }

        // âœ… [REPLACE] renderReviews() - ì¹´ë“œ ì „ì²´ í´ë¦­ ì‹œ ì•„í‹°í´ ìƒì„¸ë¡œ ì´ë™
        function renderReviews() {
        const reviews = getMyReviews();
        const list = document.getElementById('review-list');
        const empty = document.getElementById('review-empty');

        const statEl = document.getElementById('stat-reviews');
        if (statEl) statEl.textContent = reviews.length;

        list.innerHTML = '';

        if (reviews.length === 0) {
            empty.classList.remove('hidden');
            return;
        }
        empty.classList.add('hidden');

        reviews.forEach((review) => {
            // ë³„ì 
            let starsHtml = '';
            for (let i = 0; i < 5; i++) {
            starsHtml += `<i data-lucide="star" width="12" class="${
                i < (review.rating || 0) ? 'fill-yellow-400 text-yellow-400' : 'text-gray-300'
            }"></i>`;
            }

            // ë¯¸ë””ì–´
            let mediaHtml = '';
            if (review.media && review.media.length > 0) {
    mediaHtml = `<div class="flex gap-2 mt-3 overflow-x-auto pb-2 no-scrollbar">`;
    review.media.forEach((m) => {
        const safeUrl = String(m.url || '').replace(/'/g, "\\'");
        const safeType = (m.type === 'video') ? 'video' : 'image';

        if (m.type === 'video') {
        mediaHtml += `
            <video
            src="${m.url}"
            class="w-20 h-20 rounded-lg object-cover flex-shrink-0 border border-gray-100 bg-black cursor-pointer"
            onclick="event.stopPropagation(); openMediaLightbox('${safeUrl}','${safeType}')"
            muted
            ></video>`;
        } else {
        mediaHtml += `
            <img
            src="${m.url}"
            class="w-20 h-20 rounded-lg object-cover flex-shrink-0 border border-gray-100 cursor-pointer"
            onclick="event.stopPropagation(); openMediaLightbox('${safeUrl}','${safeType}')"
            />`;
        }
    });
    mediaHtml += `</div>`;
    }

            const safeArticleId = review.articleId ? String(review.articleId).replace(/'/g, "\\'") : '';
            const safePlace = (review.targetPlace || '').replace(/'/g, "\\'");

            // ì¹´ë“œ í´ë¦­ ì´ë™
            const clickAttr = review.articleId
            ? `onclick="goToReviewArticle('${safeArticleId}')"`
            : `onclick="alert('ì´ ë¦¬ë·°ëŠ” ì—°ê²°ëœ ì•„í‹°í´ ì •ë³´(articleId)ê°€ ì—†ì–´ ì´ë™í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');"`;

            const placeBadge = review.targetPlace
            ? `<span class="text-[10px] bg-gray-100 text-gray-500 px-2 py-0.5 rounded ml-2">ğŸ“ ${review.targetPlace}</span>`
            : '';

            // âœ… ìˆ˜ì •/ì‚­ì œ ë²„íŠ¼(ì „íŒŒ ë°©ì§€)
            const actionBtns = `
            <div class="flex gap-2">
                <button
                type="button"
                onclick="event.stopPropagation(); openWriteModal('${safePlace}', '${safeArticleId}', ${review.id})"
                class="p-2 bg-gray-100 text-gray-700 text-xs font-bold rounded-lg hover:bg-gray-200 transition-colors"
                >ìˆ˜ì •</button>
                <button
                type="button"
                onclick="event.stopPropagation(); deleteReview(${review.id})"
                class="p-2 bg-gray-50 text-gray-600 text-xs font-bold rounded-lg hover:text-[#62B6FF] hover:bg-[#62B6FF]/10 transition-colors"
                >ì‚­ì œ</button>
            </div>
            `;

            list.innerHTML += `
            <div ${clickAttr} class="bg-white p-4 rounded-xl border border-gray-100 shadow-sm animate-fade-in relative group cursor-pointer hover:shadow-md transition-shadow">
                <div class="flex justify-between items-start mb-2">
                <div>
                    <div class="flex items-center">
                    <h4 class="font-bold text-sm text-gray-900">${review.tripTitle || 'ì—¬í–‰'}</h4>
                    ${placeBadge}
                    </div>
                    <div class="flex items-center gap-1 mt-1">${starsHtml}</div>
                </div>
                <div class="flex flex-col items-end gap-2">
                    <span class="text-xs text-gray-400">${review.date || ''}</span>
                    ${actionBtns}
                </div>
                </div>

                <p class="text-sm text-gray-600 line-clamp-3 leading-relaxed mt-2">${review.text || ''}</p>
                ${mediaHtml}
            </div>
            `;
        });

        if (typeof lucide !== 'undefined') lucide.createIcons();
        }

        function openMediaLightbox(url, type) {
            const modal = document.getElementById('media-lightbox');
            const body = document.getElementById('media-lightbox-body');
            if (!modal || !body) return;

            body.innerHTML = '';

            if (type === 'video') {
                const v = document.createElement('video');
                v.src = url;
                v.controls = true;
                v.autoplay = true;
                v.className = 'w-full h-full object-contain bg-black';
                body.appendChild(v);
            } else {
                const img = document.createElement('img');
                img.src = url;
                img.alt = 'review media';
                img.className = 'w-full h-full object-contain bg-black';
                body.appendChild(img);
            }

            modal.classList.remove('hidden');
            modal.classList.add('flex');

            // ESCë¡œ ë‹«ê¸°
            document.addEventListener('keydown', onLightboxKeydown);
            }

            function closeMediaLightbox() {
            const modal = document.getElementById('media-lightbox');
            const body = document.getElementById('media-lightbox-body');
            if (body) body.innerHTML = ''; // ì˜ìƒ ë©ˆì¶¤
            if (modal) {
                modal.classList.add('hidden');
                modal.classList.remove('flex');
            }
            document.removeEventListener('keydown', onLightboxKeydown);
            }

            function onLightboxKeydown(e) {
            if (e.key === 'Escape') closeMediaLightbox();
            }   

        function openTripFromReview(tripId) {
            if (!tripId) return;
            // âœ… â€œì—¬í–‰ ìƒì„¸â€ = ê¸°ì¡´ ìƒì„¸ ëª¨ë‹¬ë¡œ ë³´ê¸°
            openDetailModal(tripId);

            // ë§Œì•½ ë„ˆí¬ê°€ ì—¬í–‰ ìƒì„¸ í˜ì´ì§€ê°€ ë”°ë¡œ ìˆë‹¤ë©´ ì´ê±°ë¡œ êµì²´:
            // location.href = `trip.html?id=${encodeURIComponent(tripId)}`;
            }

        function goToArticle(articleId) {
            if (!articleId) return;
            location.href = `article.html?id=${encodeURIComponent(articleId)}`;
        }
        function deleteReview(id) {
            showConfirmModal('í›„ê¸° ì‚­ì œ', 'ì •ë§ ì´ í›„ê¸°ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?', () => {
                let reviews = getMyReviews();
                reviews = reviews.filter(r => r.id !== id);
                localStorage.setItem('myReviews', JSON.stringify(reviews));
                renderReviews();
                renderTrips();
                }, 'ğŸ—‘ï¸');
            }
        
        function openEditReviewModal(reviewId) { 
            const reviews = getMyReviews(); 
            const review = reviews.find(r => r.id === reviewId); 
            if(!review) return; 

            editingReviewId = reviewId; 
            currentReviewTripId = review.tripId; 
            document.getElementById('review-modal-title').textContent = 'í›„ê¸° ìˆ˜ì •'; 
            document.getElementById('btn-save-review').textContent = 'ìˆ˜ì • ì™„ë£Œ'; 
            document.getElementById('review-text').value = review.text; 
            
            const trips = getTrips();
            const trip = trips.find(t => t.id === review.tripId);
            
            setRating(review.rating || 5); 
            document.getElementById('review-modal').classList.remove('hidden'); 
            document.getElementById('review-modal').classList.add('flex'); 
        }

        function closeReviewModal() { document.getElementById('review-modal').classList.add('hidden'); document.getElementById('review-modal').classList.remove('flex'); }

        // [New] ì„ íƒ ëª¨ë“œ ìƒíƒœ ê´€ë¦¬
        let isSelectionMode = false;

        // [ìˆ˜ì •ë¨] ëª¨ë“œ ì „í™˜ ì‹œ ìŠ¤íƒ€ì¼ ì´ˆê¸°í™” ì¶”ê°€
        function toggleSelectionMode(active) {
            isSelectionMode = active;
            
            const startBtn = document.getElementById('btn-start-selection');
            const actions = document.getElementById('selection-actions');
            const guide = document.getElementById('selection-guide-text');
            
            if (active) {
                startBtn.classList.add('hidden');
                actions.classList.remove('hidden');
                actions.classList.add('flex');
                guide.textContent = 'ì¼ì •ì— ì¶”ê°€í•  ì¥ì†Œë¥¼ í´ë¦­í•˜ì—¬ ì„ íƒí•˜ì„¸ìš”.';
                } else {
                startBtn.classList.remove('hidden');
                actions.classList.add('hidden');
                actions.classList.remove('flex');
                guide.textContent = 'ë§ˆìŒì— ë“œëŠ” ì—¬í–‰ì§€ë¥¼ ì°œí•´ë³´ì„¸ìš”.';
                
                // [ì´ˆê¸°í™”] ëª¨ë“  ì„ íƒ í•´ì œ (ì²´í¬ë°•ìŠ¤ & ìŠ¤íƒ€ì¼)
                document.querySelectorAll('.saved-item-checkbox').forEach(cb => cb.checked = false);
                document.querySelectorAll('.card-selected').forEach(card => card.classList.remove('card-selected'));
            }
            renderSaved(); // ë²„íŠ¼ í‘œì‹œ ìƒíƒœ ê°±ì‹ 
        }

        // [ìˆ˜ì •ë¨] ì°œ ëª©ë¡ ë Œë”ë§ (ë²„íŠ¼ ìƒíƒœ ì „í™˜ ë¡œì§ ê°•í™”)
        function renderSaved() {
            const favIds = JSON.parse(localStorage.getItem('favorites') || '[]'); 
            const grid = document.getElementById('saved-grid'); 
            const empty = document.getElementById('saved-empty'); 
            const statLikes = document.getElementById('stat-likes'); 
            
            // [UI] ë²„íŠ¼ ê·¸ë£¹ ì œì–´
            const startBtn = document.getElementById('btn-start-selection');
            const actionGroup = document.getElementById('selection-actions');

            statLikes.textContent = favIds.length; 
            grid.innerHTML = '';
            
            const savedArticles = [];
            favIds.forEach(id => {
                if(typeof ARTICLES !== 'undefined') {
                    const article = ARTICLES.find(a => a.id === id);
                    if(article) savedArticles.push(article);
                }
            });

            if (savedArticles.length === 0) { 
                empty.classList.remove('hidden'); empty.classList.add('flex'); 
                // ì•„ì´í…œ ì—†ìœ¼ë©´ ë²„íŠ¼ ëª¨ë‘ ìˆ¨ê¹€
                if(startBtn) startBtn.style.display = 'none';
                if(actionGroup) actionGroup.style.display = 'none';
            } else { 
                empty.classList.add('hidden'); empty.classList.remove('flex'); 
                
                // [í•µì‹¬] ì„ íƒ ëª¨ë“œ ì—¬ë¶€ì— ë”°ë¼ ë²„íŠ¼ í‘œì‹œ ì „í™˜
                if (isSelectionMode) {
                    if(startBtn) startBtn.style.display = 'none';
                    if(actionGroup) {
                        actionGroup.classList.remove('hidden');
                        actionGroup.style.display = 'flex';
                    }
                } else {
                    if(startBtn) startBtn.style.display = 'flex';
                    if(actionGroup) {
                        actionGroup.classList.add('hidden');
                        actionGroup.style.display = 'none';
                    }
                }
                
                savedArticles.forEach(item => { 
                    let category = 'ì—¬í–‰';
                    const allTags = (item.mainTags || []).concat(item.tags || []);
                    if (allTags.some(t => t.match(/ìˆ™ì†Œ|í˜¸í…”|ë¦¬ì¡°íŠ¸|íœì…˜/))) category = 'ìˆ™ì†Œ';
                    else if (allTags.some(t => t.match(/ë§›ì§‘|ì‹ë‹¹|ì¹´í˜|ìŒì‹ì /))) category = 'ë§›ì§‘';
                    else if (allTags.some(t => t.match(/ê´€ê´‘|ëª…ì†Œ|íˆ¬ì–´|ì•¡í‹°ë¹„í‹°/))) category = 'ê´€ê´‘';

                    const deleteBtnDisplay = isSelectionMode ? 'none' : 'block';
                    
                    // [New] ì´ë¯¸ ì„ íƒëœ ìƒíƒœë¼ë©´ ìŠ¤íƒ€ì¼ ìœ ì§€ (ë¦¬ë Œë”ë§ ì‹œ ìƒíƒœ ë³µêµ¬)
                    const isChecked = document.querySelector(`.saved-item-checkbox[data-id="${item.id}"]`)?.checked;
                    const cardClass = isChecked ? 'group relative rounded-xl overflow-hidden aspect-[4/3] cursor-pointer shadow-sm border border-gray-100 transition-all hover:shadow-md card-selected' : 'group relative rounded-xl overflow-hidden aspect-[4/3] cursor-pointer shadow-sm border border-gray-100 transition-all hover:shadow-md';

                    grid.innerHTML += `
                    <div id="card-${item.id}" onclick="onCardClick('${item.id}')" class="${cardClass} relative overflow-hidden isolate">
                    <input type="checkbox" id="cb-${item.id}" class="saved-item-checkbox" data-id="${item.id}">

                    <div class="w-full h-full relative">
                    <button
                        type="button"
                        style="display:${deleteBtnDisplay};"
                        onclick="event.stopPropagation(); removeFavoriteFromMyPage('${item.id}')"
                        class="absolute top-3 right-3 z-[999] bg-black/30 backdrop-blur p-2 rounded-full text-white hover:bg-red-500 transition-colors shadow-sm"
                    >
                        <i data-lucide="x" width="16" height="16"></i>
                    </button>

                    <img src="${item.imageUrl}" class="w-full h-full object-cover transition-transform duration-500 group-hover:scale-105">
                    <div class="absolute inset-0 bg-gradient-to-t from-black/80 via-transparent to-transparent"></div>

                    <div class="absolute bottom-4 left-4 right-4 text-white pointer-events-none">
                        <span class="inline-block px-2 py-0.5 rounded-md bg-black/30 backdrop-blur-sm text-[10px] font-bold mb-1 border border-white/20">${category}</span>
                        <h4 class="font-bold text-sm leading-tight line-clamp-2 drop-shadow-md">${item.title}</h4>
                    </div>
                    </div>
                </div>
                `;

                }); 
                if (window.lucide) {
                lucide.createIcons();
                }
            }
        }
        // [New] í†µí•© ì¹´ë“œ í´ë¦­ í•¸ë“¤ëŸ¬ (ì„ íƒ/ì´ë™ ë¶„ê¸°)
        function onCardClick(id) {
            if (isSelectionMode) {
                // [ì„ íƒ ëª¨ë“œ] ì²´í¬ë°•ìŠ¤ í† ê¸€ ë° ìŠ¤íƒ€ì¼ ë³€ê²½
                const checkbox = document.getElementById(`cb-${id}`);
                const card = document.getElementById(`card-${id}`);
                
                if (checkbox) {
                    checkbox.checked = !checkbox.checked; // ì²´í¬ ìƒíƒœ ë°˜ì „
                    
                    // ì‹œê°ì  í”¼ë“œë°± (í´ë˜ìŠ¤ í† ê¸€)
                    if(checkbox.checked) {
                        card.classList.add('card-selected');
                    } else {
                        card.classList.remove('card-selected');
                    }
                }
            } else {
                // [ì¼ë°˜ ëª¨ë“œ] ìƒì„¸ í˜ì´ì§€ ì´ë™
                location.href = `article.html?id=${id}`;
            }
        }

        // [New] ì¹´ë“œ í´ë¦­ ì‹œ ì²´í¬ë°•ìŠ¤ í† ê¸€ (ì„ íƒ ëª¨ë“œì¼ ë•Œë§Œ)
        function toggleCheck(id) {
            if (!isSelectionMode) {
                // ì„ íƒ ëª¨ë“œê°€ ì•„ë‹ˆë©´ ìƒì„¸ í˜ì´ì§€ë¡œ ì´ë™ (ì›ë˜ ê¸°ëŠ¥)
                location.href = `article.html?id=${id}`;
                return;
            }
            // ì„ íƒ ëª¨ë“œë©´ ì²´í¬ë°•ìŠ¤ í† ê¸€
            const checkbox = document.querySelector(`.saved-item-checkbox[data-id="${id}"]`);
            if (checkbox) {
                checkbox.checked = !checkbox.checked;
            }
        }
        function removeFavoriteFromMyPage(id) { toggleFavorite(id); renderSaved(); }

        window.addEventListener('DOMContentLoaded', async () => {
            const { data: { session } } = await supabaseClient.auth.getSession();

            if (!session) {
                showAuthModal('ë¡œê·¸ì¸ í•„ìš”', 'ë¡œê·¸ì¸ì´ í•„ìš”í•œ ì„œë¹„ìŠ¤ì…ë‹ˆë‹¤.', 'â—');
                setTimeout(() => location.href = 'login.html', 800);
                return;
            }

            loadProfile();
            renderTrips();
            renderSaved();
            renderReviews();
            lucide.createIcons();
            setRating(5);

            const tabParam = new URLSearchParams(location.search).get('tab');
            const hash = window.location.hash.replace('#', '');
            let targetTab = 'saved';
            if (tabParam === 'favorites') targetTab = 'saved';
            else if (['saved','trips','reviews'].includes(tabParam)) targetTab = tabParam;
            else if (['saved','trips','reviews'].includes(hash)) targetTab = hash;
            switchTab(targetTab);
            });
    </script>
    <!-- Media Lightbox Modal -->
    <div id="media-lightbox" class="fixed inset-0 z-[999] hidden items-center justify-center px-4">
    <div class="absolute inset-0 bg-black/70" onclick="closeMediaLightbox()"></div>

    <div class="relative z-10 w-full max-w-3xl bg-black rounded-2xl overflow-hidden shadow-2xl">
        <button
        type="button"
        onclick="closeMediaLightbox()"
        class="absolute top-3 right-3 z-20 bg-white/10 hover:bg-white/20 text-white rounded-full px-3 py-1 text-sm font-bold"
        >
        ë‹«ê¸°
        </button>

        <!-- ì´ë¯¸ì§€/ì˜ìƒì´ ì—¬ê¸° ë“¤ì–´ê° -->
        <div id="media-lightbox-body" class="w-full h-[70vh] flex items-center justify-center bg-black"></div>
    </div>
    </div>
</body>
</html>
